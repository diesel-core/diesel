class A{constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isImportant=!1,this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class V{constructor(){this.root=new A}insert(J,L){let G=this.root;const X=J.split("/").filter(Boolean);if(J==="/"){G.isEndOfWord=!0,G.handler.push(L.handler),G.isImportant=L.isImportant,G.path=J,G.method.push(L.method);return}for(let U of X){let Y=!1,_=U;if(U.startsWith(":"))Y=!0,_=":";if(!G.children[_])G.children[_]=new A;G=G.children[_],G.isDynamic=Y,G.pattern=U}G.isEndOfWord=!0,G.method.push(L.method),G.handler.push(L.handler),G.isImportant=L.isImportant,G.path=J}insertMidl(J){if(!this.root.subMiddlewares.has(J))this.root.subMiddlewares.set(J)}search(J,L){let G=this.root;const X=J.split("/").filter(Boolean);for(let Y of X){let _=Y;if(!G.children[_])if(G.children[":"])G=G.children[":"];else return null;else G=G.children[_]}let U=G.method.indexOf(L);if(U!==-1)return{path:G.path,handler:G.handler[U],isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[U]};return{path:G.path,handler:G.handler,isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[U]}}getAllRoutes(){const J=[],L=(G,X)=>{if(G.isEndOfWord)J.push({path:X,handler:G.handler,isImportant:G.isImportant,isDynamic:G.isDynamic,pattern:G.pattern});for(let U in G.children){const Y=G.children[U],_=X+(U===":"?"/:"+Y.pattern:"/"+U);L(Y,_)}};return L(this.root,""),J}}async function M(J){const L={};if(!J)return L;return J.split(";").forEach((X)=>{const[U,Y]=X.trim().split("=");L[U]=Y.split(" ")[0]}),L}async function C(J,L){const G={},X=J.split("/"),[U]=L.split("?"),Y=U.split("/");if(X.length!==Y.length)return null;return X.forEach((_,z)=>{if(_.startsWith(":")){const E=_.slice(1);G[E]=Y[z]}}),G}async function O(J){const L=J.headers.get("Content-Type");if(L.includes("application/json"))try{return await J.json()}catch(G){return new Response({error:"Invalid JSON format"})}else if(L.startsWith("application/x-www-form-urlencoded")){const G=await J.text();return Object.fromEntries(new URLSearchParams(G))}else if(L.startsWith("multipart/form-data")){const G=await J.formData();return T(G)}else return new Response({error:"unknown request body"})}function T(J){const L={};for(let[G,X]of J.entries())L[G]=X;return L}function B(J,L){let G={},X={},U=!1,Y=null,_=null,z=null,E=null,K=200;return{req:J,url:L,next:()=>{},status(Z){return K=Z,this},async body(){if(!E)E=await O(J);return E},setHeader(Z,$){return G[Z]=$,this},set(Z,$){return X[Z]=$,this},get(Z){return X[Z]},setAuth(Z){return U=Z,this},getAuth(){return U},text(Z,$){if($)K=$;return new Response(Z,{status:K,headers:G})},json(Z,$){if($)K=$;return new Response(JSON.stringify(Z),{status:K,headers:{"Content-Type":"application/json",...G}})},html(Z,$){if($)K=$;return new Response(Bun.file(Z),{status:K,headers:{...G}})},file(Z,$){if($)K=$;return new Response(Bun.file(Z),{status:K,headers:{...G}})},redirect(Z,$){if($)K=$;return new Response(null,{status:K,headers:{Location:Z,...G}})},async getParams(Z){if(!z)z=await C(J.routePattern,L.pathname);return Z?z[Z]:z},getQuery(Z){if(!Y)Y=Object.fromEntries(L.searchParams.entries());return Z?Y[Z]:Y},cookie(Z,$,F={}){let W=`${encodeURIComponent(Z)}=${encodeURIComponent($)}`;if(F.maxAge)W+=`; Max-Age=${F.maxAge}`;if(F.expires)W+=`; Expires=${F.expires.toUTCString()}`;if(F.path)W+=`; Path=${F.path}`;if(F.domain)W+=`; Domain=${F.domain}`;if(F.secure)W+="; Secure";if(F.httpOnly)W+="; HttpOnly";if(F.sameSite)W+=`; SameSite=${F.sameSite}`;if(G["Set-Cookie"]){const j=Array.isArray(G["Set-Cookie"])?G["Set-Cookie"]:[G["Set-Cookie"]];j.push(W),G["Set-Cookie"]=j}else G["Set-Cookie"]=W;return this},async getCookie(Z){if(!_)_=await M(J.headers.get("cookie"));return Z?_[Z]:_}}}async function b(J,L){for(let G of J){const X=await G(L);if(X)return X}}function I(J){return new Response(`Route not found for ${J}`,{status:404})}function v(){return new Response("Method not allowed",{status:405})}function N(){return new Response("No response from handler",{status:204})}function R(){return new Response("Internal Server Error",{status:500})}async function Q(J,L,G){const{pathname:X}=L,{method:U}=J,Y=G.trie.search(X,U);if(!Y||!Y.handler)return I(X);if(Y.method!==U)return v();if(Y.isDynamic)J.routePattern=Y.path;const _=B(J,L);if(G.hasMiddleware){const z=[...G.globalMiddlewares,...G.middlewares.get(X)||[]],E=await b(z,_);if(E)return E}try{return await Y.handler(_)??N()}catch(z){return R()}}class D{constructor(){this.routes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new V,this.hasMiddleware=!1}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[J,L]of this.middlewares.entries())if(L.length>0){this.hasMiddleware=!0;break}}listen(J,L){this.compile();const G=Bun.serve({port:J,fetch:async(X)=>{const U=new URL(X.url);try{return await Q(X,U,this)}catch(Y){return new Response("Internal Server Error",{status:500})}},onClose(){console.log("Server is shutting down...")}});if(typeof L==="function")return L();return console.log(`Server is running on http://localhost:${J}`),G}register(J,L){const G=Object.entries(L.trie.root.children);L.trie.root.subMiddlewares.forEach((X,U)=>{if(!this.middlewares.has(J+U))this.middlewares.set(J+U,[]);if(!this.middlewares.get(J+U).includes(...X))this.middlewares.get(J+U).push(...X)});for(let[X,U]of G){const Y=J+U?.path,_=U.handler[0],z=U.method[0];this.trie.insert(Y,{handler:_,method:z})}L.trie=new V}#G(J,L,G){const X=G.slice(0,-1);if(!this.middlewares.has(L))this.middlewares.set(L,[]);if(L==="/")X.forEach((Y)=>{if(!this.globalMiddlewares.includes(Y))this.globalMiddlewares.push(Y)});else if(!this.middlewares.get(L).includes(...X))this.middlewares.get(L).push(...X);const U=G[G.length-1];this.trie.insert(L,{handler:U,method:J})}use(J,L){if(typeof J==="function"){if(!this.globalMiddlewares.includes(J))return this.globalMiddlewares.push(J)}const G=J;if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(!this.middlewares.get(G).includes(L))this.middlewares.get(G).push(L)}get(J,...L){return this.#G("GET",J,L)}post(J,...L){return this.#G("POST",J,L)}put(J,...L){return this.#G("PUT",J,L)}patch(J,...L){if(L.length>0)return this.#G("PATCH",J,L)}delete(J,...L){return this.#G("DELETE",J,L)}}var S=D;export{S as default};
