class B{constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class A{constructor(){this.root=new B}insert(J,L){let G=this.root;const X=J.split("/").filter(Boolean);if(J==="/"){G.isEndOfWord=!0,G.handler.push(L.handler),G.path=J,G.method.push(L.method);return}for(let U of X){let Y=!1,_=U;if(U.startsWith(":"))Y=!0,_=":";if(!G.children[_])G.children[_]=new B;G=G.children[_],G.isDynamic=Y,G.pattern=U}G.isEndOfWord=!0,G.method.push(L.method),G.handler.push(L.handler),G.path=J}insertMidl(J){if(!this.root.subMiddlewares.has(J))this.root.subMiddlewares.set(J)}search(J,L){let G=this.root;const X=J.split("/").filter(Boolean);for(let Y of X){let _=Y;if(!G.children[_])if(G.children[":"])G=G.children[":"];else return null;else G=G.children[_]}let U=G.method.indexOf(L);if(U!==-1)return{path:G.path,handler:G.handler[U],isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[U]};return{path:G.path,handler:G.handler,isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[U]}}getAllRoutes(){const J=[],L=(G,X)=>{if(G.isEndOfWord)J.push({path:X,handler:G.handler,isImportant:G.isImportant,isDynamic:G.isDynamic,pattern:G.pattern});for(let U in G.children){const Y=G.children[U],_=X+(U===":"?"/:"+Y.pattern:"/"+U);L(Y,_)}};return L(this.root,""),J}}async function M(J){const L={};if(!J)return L;return J.split(";").forEach((X)=>{const[U,Y]=X.trim().split("=");L[U]=Y.split(" ")[0]}),L}async function O(J,L){const G={},X=J.split("/"),[U]=L.split("?"),Y=U.split("/");if(X.length!==Y.length)return null;return X.forEach((_,z)=>{if(_.startsWith(":")){const E=_.slice(1);G[E]=Y[z]}}),G}async function b(J){const L=J.headers.get("Content-Type")||"";if(!L)return{};try{if(L.startsWith("application/json"))return await J.json();if(L.startsWith("application/x-www-form-urlencoded")){const G=await J.text();return Object.fromEntries(new URLSearchParams(G))}if(L.startsWith("multipart/form-data")){const G=await J.formData();return I(G)}return new Response({error:"Unknown request body type"})}catch(G){return new Response({error:"Invalid request body format"})}}function I(J){const L={};for(let[G,X]of J.entries())L[G]=X;return L}function Q(J,L){let G={},X={},U=!1,Y=null,_=null,z=null,E=null,W=200;return{req:J,url:L,next:()=>{},status(Z){return W=Z,this},async body(){if(!E)E=await b(J);return E},setHeader(Z,$){return G[Z]=$,this},set(Z,$){return X[Z]=$,this},get(Z){return X[Z]},setAuth(Z){return U=Z,this},getAuth(){return U},text(Z,$){if($)W=$;return new Response(Z,{status:W,headers:G})},json(Z,$){if($)W=$;return new Response(JSON.stringify(Z),{status:W,headers:{"Content-Type":"application/json",...G}})},html(Z,$){if($)W=$;return new Response(Bun.file(Z),{status:W,headers:{...G}})},file(Z,$){if($)W=$;return new Response(Bun.file(Z),{status:W,headers:{...G}})},redirect(Z,$){if($)W=$;return new Response(null,{status:W,headers:{Location:Z,...G}})},async getParams(Z){if(!z)z=await O(J.routePattern,L.pathname);return Z?z[Z]:z},getQuery(Z){if(!Y)Y=Object.fromEntries(L.searchParams.entries());return Z?Y[Z]:Y},async cookie(Z,$,F={}){let V=`${encodeURIComponent(Z)}=${encodeURIComponent($)}`;if(F.maxAge)V+=`; Max-Age=${F.maxAge}`;if(F.expires)V+=`; Expires=${F.expires.toUTCString()}`;if(F.path)V+=`; Path=${F.path}`;if(F.domain)V+=`; Domain=${F.domain}`;if(F.secure)V+="; Secure";if(F.httpOnly)V+="; HttpOnly";if(F.sameSite)V+=`; SameSite=${F.sameSite}`;if(G["Set-Cookie"]){const D=Array.isArray(G["Set-Cookie"])?G["Set-Cookie"]:[G["Set-Cookie"]];D.push(V),G["Set-Cookie"]=D}else G["Set-Cookie"]=V;return this},async getCookie(Z){if(!_)_=await M(J.headers.get("cookie"));return Z?_[Z]:_}}}async function T(J,L){for(let G of J){const X=await G(L);if(X)return X}}function v(J){return new Response(`Route not found for ${J}`,{status:404})}function C(){return new Response("Method not allowed",{status:405})}function N(){return new Response("No response from handler",{status:204})}function R(){return new Response("Internal Server Error",{status:500})}async function j(J,L,G){const{pathname:X}=L,{method:U}=J,Y=G.trie.search(X,U);if(!Y||!Y.handler)return v(X);if(Y.method!==U)return C();if(Y.isDynamic)J.routePattern=Y.path;const _=Q(J,L);if(G.hasMiddleware){const z=[...G.globalMiddlewares,...G.middlewares.get(X)||[]],E=await T(z,_);if(E)return E}try{return await Y.handler(_)??N()}catch(z){return R()}}class K{constructor(){this.routes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new A,this.hasMiddleware=!1}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[J,L]of this.middlewares.entries())if(L.length>0){this.hasMiddleware=!0;break}}listen(J,{sslCert:L=null,sslKey:G=null}={},X){this.compile();const U={port:J,fetch:async(_)=>{const z=new URL(_.url);try{return await j(_,z,this)}catch(E){return new Response("Internal Server Error",{status:500})}},onClose(){console.log("Server is shutting down...")}};if(L&&G)U.certFile=L,U.keyFile=G;const Y=Bun.serve(U);if(typeof X==="function")return X();if(L&&G)console.log(`HTTPS server is running on https://localhost:${J}`);else console.log(`HTTP server is running on http://localhost:${J}`);return Y}register(J,L){const G=Object.entries(L.trie.root.children);L.trie.root.subMiddlewares.forEach((X,U)=>{if(!this.middlewares.has(J+U))this.middlewares.set(J+U,[]);if(!this.middlewares.get(J+U).includes(...X))this.middlewares.get(J+U).push(...X)});for(let[X,U]of G){const Y=J+U?.path,_=U.handler[0],z=U.method[0];this.trie.insert(Y,{handler:_,method:z})}L.trie=new A}#G(J,L,G){const X=G.slice(0,-1);if(!this.middlewares.has(L))this.middlewares.set(L,[]);if(L==="/")X.forEach((Y)=>{if(!this.globalMiddlewares.includes(Y))this.globalMiddlewares.push(Y)});else if(!this.middlewares.get(L).includes(...X))this.middlewares.get(L).push(...X);const U=G[G.length-1];this.trie.insert(L,{handler:U,method:J})}use(J,L){if(typeof J==="function"){if(!this.globalMiddlewares.includes(J))return this.globalMiddlewares.push(J)}const G=J;if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(!this.middlewares.get(G).includes(L))this.middlewares.get(G).push(L)}get(J,...L){return this.#G("GET",J,L)}post(J,...L){return this.#G("POST",J,L)}put(J,...L){return this.#G("PUT",J,L)}patch(J,...L){if(L.length>0)return this.#G("PATCH",J,L)}delete(J,...L){return this.#G("DELETE",J,L)}}var S=K;export{S as default};
