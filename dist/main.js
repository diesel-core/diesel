class Q{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class D{root;constructor(){this.root=new Q}insert(z,F){let G=this.root,J=z.split("/").filter(Boolean);if(z==="/"){G.isEndOfWord=!0,G.handler.push(F.handler),G.path=z,G.method.push(F.method);return}for(let U of J){let X=!1,_=U;if(U.startsWith(":"))X=!0,_=":";if(!G.children[_])G.children[_]=new Q;G=G.children[_],G.isDynamic=X,G.pattern=U,G.method.push(F.method),G.handler.push(F.handler),G.path=z}G.isEndOfWord=!0,G.method.push(F.method),G.handler.push(F.handler),G.path=z}search(z,F){let G=this.root,J=z.split("/").filter(Boolean);for(let X of J){let _=X;if(!G.children[_])if(G.children[":"])G=G.children[":"];else return null;else G=G.children[_]}let U=G.method.indexOf(F);if(U!==-1)return{path:G.path,handler:G.handler[U],isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[U]};return{path:G.path,handler:G.handler,isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[U]}}}function K(z,F,G){let J=new Headers,U={},X=!1,_,Z=null,$,L,V=200,B={};return{req:z,server:F,url:G,getUser(){return B},setUser(Y){if(Y)B=Y},status(Y){return V=Y,this},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!L)L=await C(z);if(L.error)return new Response(JSON.stringify({error:L.error}),{status:400});return L},setHeader(Y,E){return J.set(Y,E),this},set(Y,E){return U[Y]=E,this},get(Y){return U[Y]||null},setAuth(Y){return X=Y,this},getAuth(){return X},text(Y,E){return new Response(Y,{status:E??V,headers:J})},send(Y,E){return new Response(Y,{status:E??V,headers:J})},json(Y,E){return new Response(JSON.stringify(Y),{status:E??V,headers:J})},html(Y,E){return new Response(Bun.file(Y),{status:E??V,headers:J})},file(Y,E){return new Response(Bun.file(Y),{status:E??V,headers:J})},redirect(Y,E){return J.set("Location",Y),new Response(null,{status:E??302,headers:J})},setCookie(Y,E,W={}){let A=`${encodeURIComponent(Y)}=${encodeURIComponent(E)}`;if(W.maxAge)A+=`; Max-Age=${W.maxAge}`;if(W.expires)A+=`; Expires=${W.expires.toUTCString()}`;if(W.path)A+=`; Path=${W.path}`;if(W.domain)A+=`; Domain=${W.domain}`;if(W.secure)A+="; Secure";if(W.httpOnly)A+="; HttpOnly";if(W.sameSite)A+=`; SameSite=${W.sameSite}`;return J?.append("Set-Cookie",A),this},getParams(Y){if(!$&&z?.routePattern)$=b(z?.routePattern,G?.pathname);return Y?$[Y]||{}:$},getQuery(Y){try{if(!_)_=Object.fromEntries(G.searchParams);return Y?_[Y]||{}:_}catch(E){return{}}},getCookie(Y){if(!Z){let E=z.headers.get("cookie");if(E)Z=T(E);else return null}if(!Z)return null;if(Y)return Z[Y]??null;else return Z}}}function T(z){let F={};return z?.split(";")?.forEach((G)=>{let[J,U]=G?.trim()?.split("=");if(J)F[J.trim()]=U?.split(" ")[0]?.trim()}),F}function b(z,F){let G={},J=z.split("/"),[U]=F.split("?"),X=U.split("/");if(J.length!==X.length)return null;return J.forEach((_,Z)=>{if(_.startsWith(":")){let $=_.slice(1);G[$]=X[Z]}}),G}async function C(z){let F=z.headers.get("Content-Type")||"";if(!F)return{};try{if(F.startsWith("application/json"))return await z.json();if(F.startsWith("application/x-www-form-urlencoded")){let G=await z.text();return Object.fromEntries(new URLSearchParams(G))}if(F.startsWith("multipart/form-data")){let G=await z.formData(),J={};for(let[U,X]of G.entries())J[U]=X;return J}return{error:"Unknown request body type"}}catch(G){return{error:"Invalid request body format"}}}async function j(z,F,G,J){let U=J.trie.search(G.pathname,z.method);if(!U||U.method!==z.method)return new Response(U?"Method not allowed":`Route not found for ${G.pathname}`,{status:U?405:404});if(U.isDynamic)z.routePattern=U.path;let X=K(z,F,G);if(J.corsConfig){let Z=R(z,X,J.corsConfig);if(Z)return Z}if(J.hasOnReqHook&&J.hooks.onRequest)J.hooks.onRequest(X,F);if(J.hasFilterEnabled){let Z=z.routePattern??G.pathname;if(J.filters.includes(Z)===!1)if(J.filterFunction)try{let L=await J.filterFunction(X,F);if(L)return L}catch(L){return console.error("Error in filterFunction:",L),new Response(JSON.stringify({message:"Internal Server Error"}),{status:500})}else return new Response(JSON.stringify({message:"Authentication required"}),{status:400})}if(J.hasMiddleware){for(let $ of J.globalMiddlewares){let L=await $(X,F);if(L)return L}let Z=J.middlewares.get(G.pathname)||[];for(let $ of Z){let L=await $(X,F);if(L)return L}}if(J.hasPreHandlerHook&&J.hooks.preHandler){let Z=await J.hooks.preHandler(X);if(Z)return Z}let _=await U.handler(X);if(J.hasPostHandlerHook&&J.hooks.postHandler)await J.hooks.postHandler(X);if(J.hasOnSendHook&&J.hooks.onSend){let Z=await J.hooks.onSend(X,_);if(Z)return Z}return _??new Response("No response from handler",{status:204})}function R(z,F,G={}){let J=z.headers.get("origin")??"*",U=G?.origin,X=G?.allowedHeaders??["Content-Type","Authorization"],_=G?.methods??["GET","POST","PUT","DELETE","OPTIONS"],Z=G?.credentials??!1,$=G?.exposedHeaders??[];if(F.setHeader("Access-Control-Allow-Methods",_),F.setHeader("Access-Control-Allow-Headers",X),F.setHeader("Access-Control-Allow-Credentials",Z),$.length)F.setHeader("Access-Control-Expose-Headers",$);if(U==="*")F.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(U))if(J&&U.includes(J))F.setHeader("Access-Control-Allow-Origin",J);else if(U.includes("*"))F.setHeader("Access-Control-Allow-Origin","*");else return F.status(403).json({message:"CORS not allowed"});else if(typeof U==="string")if(J===U)F.setHeader("Access-Control-Allow-Origin",J);else return F.status(403).json({message:"CORS not allowed"});else return F.status(403).json({message:"CORS not allowed"});if(F.setHeader("Access-Control-Allow-Origin",J),z.method==="OPTIONS")return F.setHeader("Access-Control-Max-Age","86400"),F.status(204).text("");return null}function M(z){let{time:F=60000,max:G=100,message:J="Rate limit exceeded. Please try again later."}=z,U=new Map;return(X)=>{let _=new Date,Z=X.getIP().address;if(!U.has(Z))U.set(Z,{count:0,startTime:_});let $=U.get(Z);if($)if(_-$.startTime>F)$.count=1,$.startTime=_;else $.count++;if($&&$.count>G)return X.status(429).json({error:J})}}class N{globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;constructor(){this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=[],this.filterFunction=null,this.hasFilterEnabled=!1}filter(){return this.hasFilterEnabled=!0,{routeMatcher:(...z)=>{return this.FilterRoutes=z.sort(),this.filter()},permitAll:()=>{for(let z of this?.FilterRoutes)this.filters.push(z);return this.filter()},require:(z)=>{if(z)this.filterFunction=z}}}cors(z){this.corsConfig=z}addHooks(z,F){if(typeof z!=="string")throw new Error("hookName must be a string");if(typeof F!=="function")throw new Error("callback must be a instance of function");if(this.hooks.hasOwnProperty(z))this.hooks[z]=F;else throw new Error(`Unknown hook type: ${z}`)}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[z,F]of this.middlewares.entries())if(F.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0}listen(z,F,{sslCert:G=null,sslKey:J=null}={}){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(typeof z!=="number")throw new Error("Port must be a numeric value");this.compile();let U={port:z,fetch:async(_,Z)=>{let $=new URL(_.url);try{return await j(_,Z,$,this)}catch(L){return new Response("Internal Server Error",{status:500})}}};if(G&&J)U.certFile=G,U.keyFile=J;let X=Bun?.serve(U);if(typeof F==="function")return F();if(G&&J)console.log(`HTTPS server is running on https://localhost:${z}`);else console.log(`HTTP server is running on http://localhost:${z}`);return X}register(z,F){if(typeof z!=="string")throw new Error("path must be a string");if(typeof F!=="object")throw new Error("handler parameter should be a instance of router object",F);let G=Object.entries(F.trie.root.children);F.trie.root.subMiddlewares.forEach((J,U)=>{if(!this.middlewares.has(z+U))this.middlewares.set(z+U,[]);J?.forEach((X)=>{if(!this.middlewares.get(z+U)?.includes(X))this.middlewares.get(z+U)?.push(X)})});for(let[J,U]of G){let X=z+U?.path,_=U.handler[0],Z=U.method[0];this.trie.insert(X,{handler:_,method:Z})}F.trie=new D}addRoute(z,F,G){if(typeof F!=="string")throw new Error("Path must be a string type");if(typeof z!=="string")throw new Error("method must be a string type");let J=G.slice(0,-1),U=G[G.length-1];if(!this.middlewares.has(F))this.middlewares.set(F,[]);J.forEach((X)=>{if(F==="/"){if(!this.globalMiddlewares.includes(X))this.globalMiddlewares.push(X)}else if(!this.middlewares.get(F)?.includes(X))this.middlewares.get(F)?.push(X)}),this.trie.insert(F,{handler:U,method:z})}use(z,F){if(typeof z==="function"){if(!this.globalMiddlewares.includes(z))this.globalMiddlewares.push(z);return}let G=z;if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(F){if(!this.middlewares.get(G)?.includes(F))this.middlewares.get(G)?.push(F)}}get(z,...F){return this.addRoute("GET",z,F),this}post(z,...F){return this.addRoute("POST",z,F),this}put(z,...F){return this.addRoute("PUT",z,F),this}patch(z,...F){return this.addRoute("PATCH",z,F),this}delete(z,...F){return this.addRoute("DELETE",z,F),this}}export{M as rateLimit,N as default};
