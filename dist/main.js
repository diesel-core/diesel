class Y{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class U{root;constructor(){this.root=new Y}insert(w,F){let E=this.root,$=w.split("/").filter(Boolean);if(w==="/"){E.isEndOfWord=!0,E.handler.push(F.handler),E.path=w,E.method.push(F.method);return}for(let R of $){let L=!1,J=R;if(R.startsWith(":"))L=!0,J=":";if(!E.children[J])E.children[J]=new Y;E=E.children[J],E.isDynamic=L,E.pattern=R,E.method.push(F.method),E.handler.push(F.handler),E.path=w}E.isEndOfWord=!0,E.method.push(F.method),E.handler.push(F.handler),E.path=w}search(w,F){let E=this.root,$=w.split("/").filter(Boolean),R=$.length;for(let G of $){let A=G;if(!E.children[A])if(E.children[":"])E=E.children[":"];else return null;else E=E.children[A]}let L=E.path.split("/").filter(Boolean);if(R!==L.length)return null;let J=E.method.indexOf(F);if(J!==-1)return{path:E.path,handler:E.handler[J],isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[J]};return{path:E.path,handler:E.handler,isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[J]}}}function D(w){let{time:F=60000,max:E=100,message:$="Rate limit exceeded. Please try again later."}=w,R=new Map;return(L)=>{let J=new Date,G=L.ip;if(!R.has(G))R.set(G,{count:0,startTime:J});let A=R.get(G);if(A)if(J-A.startTime>F)A.count=1,A.startTime=J;else A.count++;if(A&&A.count>E)return L.json({error:$},429)}}function X(w){switch(w.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var V=(w,F,E,$)=>{if(E>$)return!1;let R=E+($-E)/2;if(w[R]==F)return!0;if(w[R]>F)return V(w,F,E,R-1);return V(w,F,R+1,$)};function Z(w,F,E){let $=new Headers({"Cache-Control":"no-cache"}),R=null,L=null,J=null,G=null,A={};return{req:w,server:F,url:E,setHeader(z,C){return $.set(z,C),this},removeHeader(z){return $.delete(z),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!R)try{R=Object.fromEntries(this.url.searchParams)}catch(z){throw new Error("Failed to parse query parameters")}return R},get params(){if(!L&&this.req.routePattern)try{L=Q(this.req.routePattern,this.url.pathname)}catch(z){throw new Error("Failed to extract route parameters")}return L??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!G)G=(async()=>{let z=await x(this.req);if(z.error)throw new Error(z.error);return Object.keys(z).length===0?null:z})();return G},set(z,C){return A[z]=C,this},get(z){return A[z]},text(z,C=200){if(!$.has("Content-Type"))$.set("Content-Type","text/plain; charset=utf-8");return new Response(z,{status:C,headers:$})},send(z,C=200){let K=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),N=z instanceof Uint8Array?"Uint8Array":z instanceof ArrayBuffer?"ArrayBuffer":typeof z;if(!$.has("Content-Type"))$.set("Content-Type",K.get(N)??"text/plain; charset=utf-8");let j=N==="object"&&z!==null?JSON.stringify(z):z;return new Response(j,{status:C,headers:$})},json(z,C=200){if(!$.has("Content-Type"))$.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(z),{status:C,headers:$})},file(z,C=200,K){let N=Bun.file(z);if(!$.has("Content-Type"))$.set("Content-Type",K??X(z));return new Response(N,{status:C,headers:$})},redirect(z,C=302){return $.set("Location",z),new Response(null,{status:C,headers:$})},setCookie(z,C,K={}){let N=`${encodeURIComponent(z)}=${encodeURIComponent(C)}`;if(K.maxAge)N+=`; Max-Age=${K.maxAge}`;if(K.expires)N+=`; Expires=${K.expires.toUTCString()}`;if(K.path)N+=`; Path=${K.path}`;if(K.domain)N+=`; Domain=${K.domain}`;if(K.secure)N+="; Secure";if(K.httpOnly)N+="; HttpOnly";if(K.sameSite)N+=`; SameSite=${K.sameSite}`;return $.append("Set-Cookie",N),this},get cookies(){if(!J){let z=this.req.headers.get("cookie");J=z?B(z):{}}return J}}}function B(w){return Object.fromEntries(w.split(";").map((F)=>{let[E,...$]=F.trim().split("=");return[E,decodeURIComponent($.join("="))]}))}function Q(w,F){let E={},$=w.split("/"),[R]=F.split("?"),L=R.split("/");if($.length!==L.length)return null;for(let J=0;J<$.length;J++)if($[J].startsWith(":"))E[$[J].slice(1)]=L[J];return E}async function x(w){let F=w.headers.get("Content-Type");if(!F)return{};if(w.headers.get("Content-Length")==="0"||!w.body)return{};try{if(F.startsWith("application/json"))return await w.json();if(F.startsWith("application/x-www-form-urlencoded")){let $=await w.text();return Object.fromEntries(new URLSearchParams($))}if(F.startsWith("multipart/form-data")){let $=await w.formData(),R={};for(let[L,J]of $.entries())R[L]=J;return R}return{error:"Unknown request body type"}}catch($){return{error:"Invalid request body format"}}}async function M(w,F,E,$){let R=Z(w,F,E),L=$.trie.search(E.pathname,w.method);if(w.routePattern=L?.path,$.hasFilterEnabled){let A=w.routePattern??E.pathname,z=await T($,A,R,F);if(z)return z}if($.hasMiddleware){let A=await W($.globalMiddlewares,R,F);if(A)return A;let z=$.middlewares.get(E.pathname)||[],C=await W(z,R,F);if(C)return C}if(!L?.handler||L.method!==w.method){if($.staticPath){let A=await S($,E.pathname,R);if(A)return A;let z=$.trie.search("*",w.method);if(z?.handler)return await z.handler(R)}if($.hooks.routeNotFound&&!L?.handler){let A=await $.hooks.routeNotFound(R);if(A)return A}if(!L||!L?.handler?.length)return f(404,`Route not found for ${E.pathname}`);if(L?.method!==w.method)return f(405,"Method not allowed")}if($.hooks.preHandler){let A=await $.hooks.preHandler(R);if(A)return A}let J=L.handler(R),G=J instanceof Promise?await J:J;if($.hooks.postHandler)await $.hooks.postHandler(R);if($.hooks.onSend){let A=await $.hooks.onSend(R,G);if(A)return A}return G??f(204,"No response from this handler")}async function W(w,F,E){for(let $ of w){let R=await $(F,E);if(R)return R}return null}async function T(w,F,E,$){if(!w.filters.has(F))if(w.filterFunction.length)for(let R of w.filterFunction){let L=await R(E,$);if(L)return L}else return E.json({error:!0,message:"Protected route, authentication required",status:401},401)}function f(w,F){return new Response(JSON.stringify({error:!0,message:F,status:w}),{status:w,headers:{"Content-Type":"application/json"}})}async function S(w,F,E){if(!w.staticPath)return null;let $=`${w.staticPath}${F}`;if(await Bun.file($).exists()){let L=X($);return E.file($,200,L)}return null}class _{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new U,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null,routeNotFound:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...w)=>{return this.FilterRoutes=w,this.setupFilter()},permitAll:()=>{for(let w of this?.FilterRoutes)this.filters.add(w);return this.FilterRoutes=null,this.setupFilter()},authenticate:(w)=>{if(w?.length)for(let F of w)this.filterFunction.push(F)}}}redirect(w,F,E){return this.any(w,($)=>{let R=$.params,L=F;if(R)for(let G in R)L=L.replace(`:${G}`,R[G]);let J=$.url.search;if(J)L+=J;return $.redirect(L,E)}),this}serveStatic(w){this.staticPath=w}static(w={}){return this.staticFiles={...this.staticFiles,...w},this}addHooks(w,F){if(typeof w!=="string")throw new Error("hookName must be a string");if(typeof F!=="function")throw new Error("callback must be a instance of function");switch(w){case"onRequest":this.hooks.onRequest=F;break;case"preHandler":this.hooks.preHandler=F;break;case"postHandler":this.hooks.postHandler=F;break;case"onSend":this.hooks.onSend=F;break;case"onError":this.hooks.onError=F;break;case"onClose":this.hooks.onClose=F;break;case"routeNotFound":this.hooks.routeNotFound=F;break;default:throw new Error(`Unknown hook type: ${w}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[w,F]of this.middlewares.entries())if(F.length>0){this.hasMiddleware=!0;break}this.tempRoutes=new Map}listen(w,...F){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let E="0.0.0.0",$=void 0,R={};for(let J of F)if(typeof J==="string")E=J;else if(typeof J==="function")$=J;else if(typeof J==="object"&&J!==null)R=J;let L={port:w,hostname:E,fetch:async(J,G)=>{let A=new URL(J.url);try{if(this.hooks.onRequest)this.hooks.onRequest(J,A,G);return await M(J,G,A,this)}catch(z){return this.hooks.onError?this.hooks.onError(z,J,A,G):new Response(JSON.stringify({message:"Internal Server Error",error:z.message,status:500}),{status:500})}},static:this.staticFiles,development:!0};if(R.sslCert&&R.sslKey)L.certFile=R.sslCert,L.keyFile=R.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(L),$)return $();if(R.sslCert&&R.sslKey)console.log(`HTTPS server is running on https://localhost:${w}`);else console.log(`HTTP server is running on http://localhost:${w}`);return this.serverInstance}close(w){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,w?w():console.log("Server has been stopped");else console.warn("Server is not running.")}route(w,F){if(!w||typeof w!=="string")throw new Error("Path must be a string");let E=Object.fromEntries(F.tempRoutes);return Object.entries(E).forEach(([R,L])=>{let J=`${w}${R}`;if(!this.middlewares.has(J))this.middlewares.set(J,[]);L.handlers.slice(0,-1).forEach((C)=>{if(!this.middlewares.get(J)?.includes(C))this.middlewares.get(J)?.push(C)});let A=L.handlers[L.handlers.length-1],z=L.method;try{this.trie.insert(J,{handler:A,method:z})}catch(C){console.error(`Error inserting ${J}:`,C)}}),F=null,this}register(w,F){return this.route(w,F)}addRoute(w,F,E){if(typeof F!=="string")throw new Error(`Error in ${E[E.length-1]}: Path must be a string. Received: ${typeof F}`);if(typeof w!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof w}`);this.tempRoutes.set(F,{method:w,handlers:E});let $=E.slice(0,-1),R=E[E.length-1];if(!this.middlewares.has(F))this.middlewares.set(F,[]);$.forEach((L)=>{if(F==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...$])];else if(!this.middlewares.get(F)?.includes(L))this.middlewares.get(F)?.push(L)});try{if(w==="ANY"){let L=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let J of L)this.trie.insert(F,{handler:R,method:J})}this.trie.insert(F,{handler:R,method:w})}catch(L){console.error(`Error inserting ${F}:`,L)}}use(w,F){if(Array.isArray(w))w.forEach(($)=>{if(typeof $==="function")this.globalMiddlewares.push($)});if(typeof w==="function"){if(this.globalMiddlewares.push(w),Array.isArray(F))F.forEach(($)=>{this.globalMiddlewares.push($)});return}return(Array.isArray(w)?w.filter(($)=>typeof $==="string"):[w].filter(($)=>typeof $==="string")).forEach(($)=>{if(!this.middlewares.has($))this.middlewares.set($,[]);if(F)(Array.isArray(F)?F:[F]).forEach((L)=>{this.middlewares.get($)?.push(L)})}),this}get(w,...F){return this.addRoute("GET",w,F),this}post(w,...F){return this.addRoute("POST",w,F),this}put(w,...F){return this.addRoute("PUT",w,F),this}patch(w,...F){return this.addRoute("PATCH",w,F),this}delete(w,...F){return this.addRoute("DELETE",w,F),this}any(w,...F){return this.addRoute("ANY",w,F),this}head(w,...F){return this.addRoute("HEAD",w,F),this}options(w,...F){return this.addRoute("OPTIONS",w,F),this}propfind(w,...F){return this.addRoute("PROPFIND",w,F),this}}export{_ as default};
