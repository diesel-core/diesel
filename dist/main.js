class U{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class K{root;constructor(){this.root=new U}insert(w,F){let f=this.root,R=w.split("/").filter(Boolean);if(w==="/"){f.isEndOfWord=!0,f.handler.push(F.handler),f.path=w,f.method.push(F.method);return}for(let $ of R){let E=!1,C=$;if($.startsWith(":"))E=!0,C=":";if(!f.children[C])f.children[C]=new U;f=f.children[C],f.isDynamic=E,f.pattern=$,f.method.push(F.method),f.handler.push(F.handler),f.path=w}f.isEndOfWord=!0,f.method.push(F.method),f.handler.push(F.handler),f.path=w}search(w,F){let f=this.root,R=w.split("/").filter(Boolean),$=R.length;for(let z of R){let L=z;if(!f.children[L])if(f.children[":"])f=f.children[":"];else return null;else f=f.children[L]}let E=f.path.split("/").filter(Boolean);if($!==E.length)return null;let C=f.method.indexOf(F);if(C!==-1)return{path:f.path,handler:f.handler[C],isDynamic:f.isDynamic,pattern:f.pattern,method:f.method[C]};return{path:f.path,handler:f.handler,isDynamic:f.isDynamic,pattern:f.pattern,method:f.method[C]}}}function j(w){let{time:F=60000,max:f=100,message:R="Rate limit exceeded. Please try again later."}=w,$=new Map;return(E)=>{let C=new Date,z=E.ip;if(!$.has(z))$.set(z,{count:0,startTime:C});let L=$.get(z);if(L)if(C-L.startTime>F)L.count=1,L.startTime=C;else L.count++;if(L&&L.count>f)return E.json({error:R},429)}}function N(w){switch(w.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var M=(w,F,f,R)=>{if(f>R)return!1;let $=f+(R-f)/2;if(w[$]==F)return!0;if(w[$]>F)return M(w,F,f,$-1);return M(w,F,$+1,R)};function X(w,F,f){let R=new Headers({"Cache-Control":"no-cache"}),$=null,E=null,C=null,z=null,L={};return{req:w,server:F,url:f,setHeader(J,x){return R.set(J,x),this},removeHeader(J){return R.delete(J),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!$)try{$=Object.fromEntries(this.url.searchParams)}catch(J){throw new Error("Failed to parse query parameters")}return $},get params(){if(!E&&this.req.routePattern)try{E=T(this.req.routePattern,this.url.pathname)}catch(J){throw new Error("Failed to extract route parameters")}return E??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!z)z=(async()=>{let J=await B(this.req);if(J.error)throw new Error(J.error);return Object.keys(J).length===0?null:J})();return z},set(J,x){return L[J]=x,this},get(J){return L[J]},text(J,x=200){if(!R.has("Content-Type"))R.set("Content-Type","text/plain; charset=utf-8");return new Response(J,{status:x,headers:R})},send(J,x=200){let A=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),G=J instanceof Uint8Array?"Uint8Array":J instanceof ArrayBuffer?"ArrayBuffer":typeof J;if(!R.has("Content-Type"))R.set("Content-Type",A.get(G)??"text/plain; charset=utf-8");let _=G==="object"&&J!==null?JSON.stringify(J):J;return new Response(_,{status:x,headers:R})},json(J,x=200){if(!R.has("Content-Type"))R.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(J),{status:x,headers:R})},file(J,x=200,A){let G=Bun.file(J);if(!R.has("Content-Type"))R.set("Content-Type",A??N(J));return new Response(G,{status:x,headers:R})},redirect(J,x=302){return R.set("Location",J),new Response(null,{status:x,headers:R})},setCookie(J,x,A={}){let G=`${encodeURIComponent(J)}=${encodeURIComponent(x)}`;if(A.maxAge)G+=`; Max-Age=${A.maxAge}`;if(A.expires)G+=`; Expires=${A.expires.toUTCString()}`;if(A.path)G+=`; Path=${A.path}`;if(A.domain)G+=`; Domain=${A.domain}`;if(A.secure)G+="; Secure";if(A.httpOnly)G+="; HttpOnly";if(A.sameSite)G+=`; SameSite=${A.sameSite}`;return R.append("Set-Cookie",G),this},get cookies(){if(!C){let J=this.req.headers.get("cookie");C=J?D(J):{}}return C}}}function D(w){return Object.fromEntries(w.split(";").map((F)=>{let[f,...R]=F.trim().split("=");return[f,decodeURIComponent(R.join("="))]}))}function T(w,F){let f={},R=w.split("/"),[$]=F.split("?"),E=$.split("/");if(R.length!==E.length)return null;for(let C=0;C<R.length;C++)if(R[C].startsWith(":"))f[R[C].slice(1)]=E[C];return f}async function B(w){let F=w.headers.get("Content-Type");if(!F)return{};if(w.headers.get("Content-Length")==="0"||!w.body)return{};try{if(F.startsWith("application/json"))return await w.json();if(F.startsWith("application/x-www-form-urlencoded")){let R=await w.text();return Object.fromEntries(new URLSearchParams(R))}if(F.startsWith("multipart/form-data")){let R=await w.formData(),$={};for(let[E,C]of R.entries())$[E]=C;return $}return{error:"Unknown request body type"}}catch(R){return{error:"Invalid request body format"}}}async function Z(w,F,f,R){let $=X(w,F,f),E=R.trie.search(f.pathname,w.method);if(w.routePattern=E?.path,R.hasFilterEnabled){let L=w.routePattern??f.pathname,J=await Q(R,L,$,F);if(J)return J}if(R.hasMiddleware){let L=await V(R.globalMiddlewares,$,F);if(L)return L;let J=R.middlewares.get(f.pathname)||[],x=await V(J,$,F);if(x)return x}if(!E?.handler||E.method!==w.method){if(R.staticPath){let L=await P(R,f.pathname,$);if(L)return L;let J=R.trie.search("*",w.method);if(J?.handler)return await J.handler($)}if(R.hooks.routeNotFound&&!E?.handler){let L=await R.hooks.routeNotFound($);if(L)return L}if(!E||!E?.handler?.length)return Y(404,`Route not found for ${f.pathname}`);if(E?.method!==w.method)return Y(405,"Method not allowed")}if(R.hooks.preHandler){let L=await R.hooks.preHandler($);if(L)return L}let C=E.handler($),z=C instanceof Promise?await C:C;if(R.hooks.postHandler)await R.hooks.postHandler($);if(R.hooks.onSend){let L=await R.hooks.onSend($,z);if(L)return L}return z??Y(204,"No response from this handler")}async function V(w,F,f){for(let R of w){let $=await R(F,f);if($)return $}return null}async function Q(w,F,f,R){if(!w.filters.has(F))if(w.filterFunction.length)for(let $ of w.filterFunction){let E=await $(f,R);if(E)return E}else return f.json({error:!0,message:"Protected route, authentication required",status:401},401)}function Y(w,F){return new Response(JSON.stringify({error:!0,message:F,status:w}),{status:w,headers:{"Content-Type":"application/json"}})}async function P(w,F,f){if(!w.staticPath)return null;let R=`${w.staticPath}${F}`;if(await Bun.file(R).exists()){let E=N(R);return f.file(R,200,E)}return null}class W{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new K,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null,routeNotFound:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...w)=>{return this.FilterRoutes=w,this.setupFilter()},permitAll:()=>{for(let w of this?.FilterRoutes)this.filters.add(w);return this.FilterRoutes=null,this.setupFilter()},authenticate:(w)=>{if(w?.length)for(let F of w)this.filterFunction.push(F)}}}serveStatic(w){this.staticPath=w}static(w={}){return this.staticFiles={...this.staticFiles,...w},this}addHooks(w,F){if(typeof w!=="string")throw new Error("hookName must be a string");if(typeof F!=="function")throw new Error("callback must be a instance of function");switch(w){case"onRequest":this.hooks.onRequest=F;break;case"preHandler":this.hooks.preHandler=F;break;case"postHandler":this.hooks.postHandler=F;break;case"onSend":this.hooks.onSend=F;break;case"onError":this.hooks.onError=F;break;case"onClose":this.hooks.onClose=F;break;case"routeNotFound":this.hooks.routeNotFound=F;break;default:throw new Error(`Unknown hook type: ${w}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[w,F]of this.middlewares.entries())if(F.length>0){this.hasMiddleware=!0;break}this.tempRoutes=new Map}listen(w,...F){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let f="0.0.0.0",R=void 0,$={};for(let C of F)if(typeof C==="string")f=C;else if(typeof C==="function")R=C;else if(typeof C==="object"&&C!==null)$=C;let E={port:w,hostname:f,fetch:async(C,z)=>{let L=new URL(C.url);try{if(this.hooks.onRequest)this.hooks.onRequest(C,L,z);return await Z(C,z,L,this)}catch(J){return this.hooks.onError?this.hooks.onError(J,C,L,z):new Response(JSON.stringify({message:"Internal Server Error",error:J.message,status:500}),{status:500})}},static:this.staticFiles,development:!0};if($.sslCert&&$.sslKey)E.certFile=$.sslCert,E.keyFile=$.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(E),R)return R();if($.sslCert&&$.sslKey)console.log(`HTTPS server is running on https://localhost:${w}`);else console.log(`HTTP server is running on http://localhost:${w}`);return this.serverInstance}close(w){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,w?w():console.log("Server has been stopped");else console.warn("Server is not running.")}route(w,F){if(!w||typeof w!=="string")throw new Error("Path must be a string");let f=Object.fromEntries(F.tempRoutes);return Object.entries(f).forEach(([$,E])=>{let C=`${w}${$}`;if(!this.middlewares.has(C))this.middlewares.set(C,[]);E.handlers.slice(0,-1).forEach((x)=>{if(!this.middlewares.get(C)?.includes(x))this.middlewares.get(C)?.push(x)});let L=E.handlers[E.handlers.length-1],J=E.method;try{this.trie.insert(C,{handler:L,method:J})}catch(x){console.error(`Error inserting ${C}:`,x)}}),F=null,this}register(w,F){return this.route(w,F)}addRoute(w,F,f){if(typeof F!=="string")throw new Error(`Error in ${f[f.length-1]}: Path must be a string. Received: ${typeof F}`);if(typeof w!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof w}`);this.tempRoutes.set(F,{method:w,handlers:f});let R=f.slice(0,-1),$=f[f.length-1];if(!this.middlewares.has(F))this.middlewares.set(F,[]);R.forEach((E)=>{if(F==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...R])];else if(!this.middlewares.get(F)?.includes(E))this.middlewares.get(F)?.push(E)});try{if(w==="ANY"){let E=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let C of E)this.trie.insert(F,{handler:$,method:C})}this.trie.insert(F,{handler:$,method:w})}catch(E){console.error(`Error inserting ${F}:`,E)}}use(w,F){if(Array.isArray(w))w.forEach((R)=>{if(typeof R==="function")this.globalMiddlewares.push(R)});if(typeof w==="function"){if(this.globalMiddlewares.push(w),Array.isArray(F))F.forEach((R)=>{this.globalMiddlewares.push(R)});return}return(Array.isArray(w)?w.filter((R)=>typeof R==="string"):[w].filter((R)=>typeof R==="string")).forEach((R)=>{if(!this.middlewares.has(R))this.middlewares.set(R,[]);if(F)(Array.isArray(F)?F:[F]).forEach((E)=>{this.middlewares.get(R)?.push(E)})}),this}get(w,...F){return this.addRoute("GET",w,F),this}post(w,...F){return this.addRoute("POST",w,F),this}put(w,...F){return this.addRoute("PUT",w,F),this}patch(w,...F){return this.addRoute("PATCH",w,F),this}delete(w,...F){return this.addRoute("DELETE",w,F),this}any(w,...F){return this.addRoute("ANY",w,F),this}head(w,...F){return this.addRoute("HEAD",w,F),this}options(w,...F){return this.addRoute("OPTIONS",w,F),this}propfind(w,...F){return this.addRoute("PROPFIND",w,F),this}}export{W as default};
