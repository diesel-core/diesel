var o=Object.create;var{getPrototypeOf:l,defineProperty:O,getOwnPropertyNames:d}=Object;var s=Object.prototype.hasOwnProperty;var a=(A,G,K)=>{K=A!=null?o(l(A)):{};let X=G||!A||!A.__esModule?O(K,"default",{value:A,enumerable:!0}):K;for(let $ of d(A))if(!s.call(X,$))O(X,$,{get:()=>A[$],enumerable:!0});return X};var r=((A)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(A,{get:(G,K)=>(typeof require!=="undefined"?require:G)[K]}):A)(function(A){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+A+'" is not supported')});class f{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class C{root;constructor(){this.root=new f}insert(A,G){let K=this.root,X=A.split("/").filter(Boolean);if(A==="/"){K.isEndOfWord=!0,K.handler.push(G.handler),K.path=A,K.method.push(G.method);return}for(let $ of X){let V=!1,z=$;if($.startsWith(":"))V=!0,z=":";if(!K.children[z])K.children[z]=new f;K=K.children[z],K.isDynamic=V,K.pattern=$}K.isEndOfWord=!0,K.path=A,K.method.push(G.method),K.handler.push(G.handler)}search(A,G){let K=this.root,X=A.split("/").filter(Boolean),$=X.length;for(let Y of X){let v=Y;if(!K.children[v])if(K.children[":"])K=K.children[":"];else return null;else K=K.children[v]}let V=K.path.split("/").filter(Boolean);if($!==V.length)return null;let z=K.method.indexOf(G);if(z!==-1)return{path:K.path,handler:K.handler[z],isDynamic:K.isDynamic,pattern:K.pattern,method:K.method[z]};return{path:K.path,handler:K.handler,isDynamic:K.isDynamic,pattern:K.pattern,method:K.method[z]}}}function L(A){switch(A.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function g(A,G,K){let X=null,$=null,V=null,z=null,Y={};return{req:A,server:G,url:K,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(v,Z){return this.headers.set(v,Z),this},removeHeader(v){return this.headers.delete(v),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!X)try{X=Object.fromEntries(this.url.searchParams)}catch(v){throw new Error("Failed to parse query parameters")}return X},get params(){if(!$&&this.req.routePattern)try{$=e(this.req.routePattern,this.url.pathname)}catch(v){throw new Error("Failed to extract route parameters")}return $??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!z)z=(async()=>{let v=await A1(this.req);if(v.error)throw new Error(v.error);return Object.keys(v).length===0?null:v})();return z},set(v,Z){return Y[v]=Z,this},get(v){return Y[v]},text(v,Z){if(Z)this.status=Z;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(v,{status:this.status,headers:this.headers})},send(v,Z){if(Z)this.status=Z;let N=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),b;if(v instanceof Uint8Array)b="Uint8Array";else if(v instanceof ArrayBuffer)b="ArrayBuffer";else b=typeof v;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",N.get(b)??"text/plain; charset=utf-8");let J=b==="object"&&v!==null?JSON.stringify(v):v;return new Response(J,{status:this.status,headers:this.headers})},json(v,Z){if(Z)this.status=Z;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(v,{status:this.status,headers:this.headers})},file(v,Z,N){if(N)this.status=N;let b=Bun.file(v);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",Z??L(v));return new Response(b,{status:this.status,headers:this.headers})},async ejs(v,Z={},N){if(N)this.status=N;let b;try{b=await import("ejs"),b=b.default||b}catch(J){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let J=await Bun.file(v).text(),W=b.render(J,Z),B=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(W,{status:this.status,headers:B})}catch(J){return console.error("EJS Rendering Error:",J),new Response("Error rendering template",{status:500})}},redirect(v,Z){if(Z)this.status=Z;else this.status=302;return this.headers.set("Location",v),new Response(null,{status:this.status,headers:this.headers})},stream(v){let Z=new Headers(this.headers),N=new ReadableStream({async start(b){await v(b),b.close()}});return new Response(N,{headers:Z})},yieldStream(v){return new Response({async*[Symbol.asyncIterator](){yield*v()}},{headers:this.headers})},setCookie(v,Z,N={}){let b=`${encodeURIComponent(v)}=${encodeURIComponent(Z)}`;if(N.maxAge)b+=`; Max-Age=${N.maxAge}`;if(N.expires)b+=`; Expires=${N.expires.toUTCString()}`;if(N.path)b+=`; Path=${N.path}`;if(N.domain)b+=`; Domain=${N.domain}`;if(N.secure)b+="; Secure";if(N.httpOnly)b+="; HttpOnly";if(N.sameSite)b+=`; SameSite=${N.sameSite}`;return this.headers.append("Set-Cookie",b),this},get cookies(){if(!V){let v=this.req.headers.get("cookie");V=v?t(v):{}}return V}}}function t(A){return Object.fromEntries(A.split(";").map((G)=>{let[K,...X]=G.trim().split("=");return[K,decodeURIComponent(X.join("="))]}))}function e(A,G){let K={},X=A.split("/"),[$]=G.split("?"),V=$.split("/");if(X.length!==V.length)return null;for(let z=0;z<X.length;z++)if(X[z].startsWith(":"))K[X[z].slice(1)]=V[z];return K}async function A1(A){let G=A.headers.get("Content-Type");if(!G)return{};if(A.headers.get("Content-Length")==="0"||!A.body)return{};try{if(G.startsWith("application/json"))return await A.json();if(G.startsWith("application/x-www-form-urlencoded")){let X=await A.text();return Object.fromEntries(new URLSearchParams(X))}if(G.startsWith("multipart/form-data")){let X=await A.formData(),$={};for(let[V,z]of X.entries())$[V]=z;return $}return{error:"Unknown request body type"}}catch(X){return{error:"Invalid request body format"}}}async function y(A,G,K,X){let $=g(A,G,K),V=X.trie.search(K.pathname,A.method);A.routePattern=V?.path;try{if(X.hasFilterEnabled){let v=A.routePattern??K.pathname,Z=await z1(X,v,$,G),N=Z instanceof Promise?await Z:Z;if(N)return N}if(X.hasMiddleware){if(X.globalMiddlewares.length){let Z=await P(X.globalMiddlewares,$,G);if(Z)return Z}let v=X.middlewares.get(K.pathname)||[];if(v?.length){let Z=await P(v,$,G);if(Z)return Z}}if(!V?.handler||V.method!==A.method){if(X.staticPath){let v=await v1(X,K.pathname,$);if(v)return v;let Z=X.trie.search("*",A.method);if(Z?.handler)return await Z.handler($)}if(X.hooks.routeNotFound&&Array.isArray(X.hooks.routeNotFound)&&!V?.handler){let v=X.hooks.routeNotFound;for(let Z=0;Z<v.length;Z++){let N=v[Z]($),b=N instanceof Promise?await N:N;if(b)return b}}if(!V||!V?.handler?.length)return T(404,`Route not found for ${K.pathname}`);if(V?.method!==A.method)return T(405,"Method not allowed")}if(X.hooks.preHandler?.length&&Array.isArray(X.hooks.preHandler)){let v=X.hooks.preHandler;for(let Z=0;Z<v.length;Z++){let N=v[Z]($),b=N instanceof Promise?await N:N;if(b)return b}}let z=V.handler($);return(z instanceof Promise?await z:z)??T(204,"")}catch(z){if(X.hooks.onError&&Array.isArray(X.hooks.onError)){let Y=X.hooks.onError;for(let v=0;v<Y.length;v++){let Z=X.hooks.onError[v](z,A,K,G),N=Z instanceof Promise?await Z:Z;if(N)return N}}return T(500,"Internal Server Error")}finally{if(X.hooks.onSend&&Array.isArray(X.hooks.onSend)){let z=X.hooks.onSend;for(let Y=0;Y<z.length;Y++){let v=z[Y]($),Z=v instanceof Promise?await v:v;if(Z)return Z}}}}async function P(A,G,K){for(let X of A){let $=await X(G,K);if($)return $}return null}async function j(A,G,K){for(let X of A){let $=await X(G,K);if($)return $}}async function z1(A,G,K,X){if(!A.filters.has(G))if(A.filterFunction.length)for(let $ of A.filterFunction){let V=await $(K,X);if(V)return V}else return Response.json({error:!0,message:"Protected route, authentication required",status:401},{status:401})}async function j1(A,G,K,X){if(!A.filters.has(G))if(A.filterFunction.length)for(let $ of A.filterFunction){let V=await $(K,X);if(V)return V}else return Response.json({error:!0,message:"Protected route, authentication required",status:401},{status:401})}function T(A,G){return new Response(JSON.stringify({error:!0,message:G,status:A}),{status:A,headers:{"Content-Type":"application/json"}})}async function v1(A,G,K){if(!A.staticPath)return null;let X=`${A.staticPath}${G}`;if(await Bun.file(X).exists()){let V=L(X);return K.file(X,V,200)}return null}var{create:G1,defineProperty:m,getOwnPropertyDescriptor:K1,getOwnPropertyNames:X1,getPrototypeOf:Y1}=Object,Z1=Object.prototype.hasOwnProperty,$1=(A,G)=>()=>(G||A((G={exports:{}}).exports,G),G.exports),b1=(A,G,K,X)=>{if(G&&typeof G=="object"||typeof G=="function")for(let $ of X1(G))!Z1.call(A,$)&&$!==K&&m(A,$,{get:()=>G[$],enumerable:!(X=K1(G,$))||X.enumerable});return A},V1=(A,G,K)=>(K=A!=null?G1(Y1(A)):{},b1(G||!A||!A.__esModule?m(K,"default",{value:A,enumerable:!0}):K,A)),N1=$1((A,G)=>{function K(z){if(typeof z!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(z))}function X(z,Y){for(var v="",Z=0,N=-1,b=0,J,W=0;W<=z.length;++W){if(W<z.length)J=z.charCodeAt(W);else{if(J===47)break;J=47}if(J===47){if(!(N===W-1||b===1))if(N!==W-1&&b===2){if(v.length<2||Z!==2||v.charCodeAt(v.length-1)!==46||v.charCodeAt(v.length-2)!==46){if(v.length>2){var B=v.lastIndexOf("/");if(B!==v.length-1){B===-1?(v="",Z=0):(v=v.slice(0,B),Z=v.length-1-v.lastIndexOf("/")),N=W,b=0;continue}}else if(v.length===2||v.length===1){v="",Z=0,N=W,b=0;continue}}Y&&(v.length>0?v+="/..":v="..",Z=2)}else v.length>0?v+="/"+z.slice(N+1,W):v=z.slice(N+1,W),Z=W-N-1;N=W,b=0}else J===46&&b!==-1?++b:b=-1}return v}function $(z,Y){var v=Y.dir||Y.root,Z=Y.base||(Y.name||"")+(Y.ext||"");return v?v===Y.root?v+Z:v+z+Z:Z}var V={resolve:function(){for(var z="",Y=!1,v,Z=arguments.length-1;Z>=-1&&!Y;Z--){var N;Z>=0?N=arguments[Z]:(v===void 0&&(v=process.cwd()),N=v),K(N),N.length!==0&&(z=N+"/"+z,Y=N.charCodeAt(0)===47)}return z=X(z,!Y),Y?z.length>0?"/"+z:"/":z.length>0?z:"."},normalize:function(z){if(K(z),z.length===0)return".";var Y=z.charCodeAt(0)===47,v=z.charCodeAt(z.length-1)===47;return z=X(z,!Y),z.length===0&&!Y&&(z="."),z.length>0&&v&&(z+="/"),Y?"/"+z:z},isAbsolute:function(z){return K(z),z.length>0&&z.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var z,Y=0;Y<arguments.length;++Y){var v=arguments[Y];K(v),v.length>0&&(z===void 0?z=v:z+="/"+v)}return z===void 0?".":V.normalize(z)},relative:function(z,Y){if(K(z),K(Y),z===Y||(z=V.resolve(z),Y=V.resolve(Y),z===Y))return"";for(var v=1;v<z.length&&z.charCodeAt(v)===47;++v);for(var Z=z.length,N=Z-v,b=1;b<Y.length&&Y.charCodeAt(b)===47;++b);for(var J=Y.length,W=J-b,B=N<W?N:W,D=-1,Q=0;Q<=B;++Q){if(Q===B){if(W>B){if(Y.charCodeAt(b+Q)===47)return Y.slice(b+Q+1);if(Q===0)return Y.slice(b+Q)}else N>B&&(z.charCodeAt(v+Q)===47?D=Q:Q===0&&(D=0));break}var w=z.charCodeAt(v+Q),h=Y.charCodeAt(b+Q);if(w!==h)break;w===47&&(D=Q)}var U="";for(Q=v+D+1;Q<=Z;++Q)(Q===Z||z.charCodeAt(Q)===47)&&(U.length===0?U+="..":U+="/..");return U.length>0?U+Y.slice(b+D):(b+=D,Y.charCodeAt(b)===47&&++b,Y.slice(b))},_makeLong:function(z){return z},dirname:function(z){if(K(z),z.length===0)return".";for(var Y=z.charCodeAt(0),v=Y===47,Z=-1,N=!0,b=z.length-1;b>=1;--b)if(Y=z.charCodeAt(b),Y===47){if(!N){Z=b;break}}else N=!1;return Z===-1?v?"/":".":v&&Z===1?"//":z.slice(0,Z)},basename:function(z,Y){if(Y!==void 0&&typeof Y!="string")throw new TypeError('"ext" argument must be a string');K(z);var v=0,Z=-1,N=!0,b;if(Y!==void 0&&Y.length>0&&Y.length<=z.length){if(Y.length===z.length&&Y===z)return"";var J=Y.length-1,W=-1;for(b=z.length-1;b>=0;--b){var B=z.charCodeAt(b);if(B===47){if(!N){v=b+1;break}}else W===-1&&(N=!1,W=b+1),J>=0&&(B===Y.charCodeAt(J)?--J===-1&&(Z=b):(J=-1,Z=W))}return v===Z?Z=W:Z===-1&&(Z=z.length),z.slice(v,Z)}else{for(b=z.length-1;b>=0;--b)if(z.charCodeAt(b)===47){if(!N){v=b+1;break}}else Z===-1&&(N=!1,Z=b+1);return Z===-1?"":z.slice(v,Z)}},extname:function(z){K(z);for(var Y=-1,v=0,Z=-1,N=!0,b=0,J=z.length-1;J>=0;--J){var W=z.charCodeAt(J);if(W===47){if(!N){v=J+1;break}continue}Z===-1&&(N=!1,Z=J+1),W===46?Y===-1?Y=J:b!==1&&(b=1):Y!==-1&&(b=-1)}return Y===-1||Z===-1||b===0||b===1&&Y===Z-1&&Y===v+1?"":z.slice(Y,Z)},format:function(z){if(z===null||typeof z!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof z);return $("/",z)},parse:function(z){K(z);var Y={root:"",dir:"",base:"",ext:"",name:""};if(z.length===0)return Y;var v=z.charCodeAt(0),Z=v===47,N;Z?(Y.root="/",N=1):N=0;for(var b=-1,J=0,W=-1,B=!0,D=z.length-1,Q=0;D>=N;--D){if(v=z.charCodeAt(D),v===47){if(!B){J=D+1;break}continue}W===-1&&(B=!1,W=D+1),v===46?b===-1?b=D:Q!==1&&(Q=1):b!==-1&&(Q=-1)}return b===-1||W===-1||Q===0||Q===1&&b===W-1&&b===J+1?W!==-1&&(J===0&&Z?Y.base=Y.name=z.slice(1,W):Y.base=Y.name=z.slice(J,W)):(J===0&&Z?(Y.name=z.slice(1,b),Y.base=z.slice(1,W)):(Y.name=z.slice(J,b),Y.base=z.slice(J,W)),Y.ext=z.slice(b,W)),J>0?Y.dir=z.slice(0,J-1):Z&&(Y.dir="/"),Y},sep:"/",delimiter:":",win32:null,posix:null};V.posix=V,G.exports=V}),q=V1(N1()),E=q,W1=q,k=function(A){return A},c=function(){throw new Error("Not implemented")};E.parse??=c;W1.parse??=c;var I={resolve:E.resolve.bind(E),normalize:E.normalize.bind(E),isAbsolute:E.isAbsolute.bind(E),join:E.join.bind(E),relative:E.relative.bind(E),toNamespacedPath:k,dirname:E.dirname.bind(E),basename:E.basename.bind(E),extname:E.extname.bind(E),format:E.format.bind(E),parse:E.parse.bind(E),sep:"/",delimiter:":",win32:void 0,posix:void 0,_makeLong:k},x={sep:"\\",delimiter:";",win32:void 0,...I,posix:I};I.win32=x.win32=x;I.posix=I;var F=I;var{default:S}=(()=>({}));var _={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},H=(A,G,K)=>{let X=_[A]||_.reset,$=K?.method?_.method[K.method]||_.reset:_.reset,V=K?.status?K.status>=500?_.error:K.status>=400?_.warn:_.info:_.reset;console.log(`
${X}[${A.toUpperCase()}]${_.reset} ${G} - ${$}${K?.method||""}${_.reset}`);let z={timestamp:new Date().toISOString(),...K,status:K?.status?`${V}${K.status}${_.reset}`:void 0,method:K?.method?`${$}${K.method}${_.reset}`:void 0};console.log(JSON.stringify(z,null,2)+`
`)},R=(A)=>{let{app:G,logger:K,logLevel:X="info",onRequest:$,onSend:V,onError:z,routeNotFound:Y}=A||{};G?.addHooks("onRequest",(v,Z)=>{v.startTime=Date.now(),K?.()??H(X,"Incoming Request",{method:v.method,url:Z.toString(),headers:{"user-agent":v.headers.get("user-agent"),"content-type":v.headers.get("content-type")}}),$?.(v,Z)}),G?.addHooks("onSend",async(v)=>{let Z=`${Date.now()-v.req.startTime}ms`;K?.()??H(X,"Response Sent",{method:v.req.method,url:v.url.toString(),status:v.status,duration:Z,headers:{"content-type":v.headers.get("content-type")}});let N=await V?.(v);if(N instanceof Response)return N}),G?.addHooks("onError",async(v,Z,N)=>{K?.()??H("error","Unhandled Error",{method:Z.method,url:N.toString(),status:500,error:v.message});let b=await z?.(v,Z,N);if(b instanceof Response)return b})},M=(A,G,K,X=0,$)=>{let V=_.method[G]||_.reset,z=X>=500?_.error:X>=400?_.warn:_.info,Y=A==="<--"?`${A} ${V}${G}${_.reset} ${K}`:`${A} ${V}${G}${_.reset} ${K} ${z}${X}${_.reset} ${$||""}`;console.log(Y)},J1=(A)=>{let G=Date.now()-A;return G<1000?`${G}ms`:`${Math.round(G/1000)}s`},u=(A)=>{let{app:G,log:K,onRequest:X,onSend:$,onError:V,routeNotFound:z}=A;G.addHooks("onRequest",(Y,v)=>{Y.startTime=Date.now(),K?.()??M("<--",Y.method,v.pathname),X?.(Y,v)}),G.addHooks("onSend",async(Y)=>{let{method:v,url:Z}=Y.req,N=new URL(Z).pathname;K?.()??M("-->",v,N,Y.status,J1(Y.req.startTime));let b=await $?.(Y);if(b instanceof Response)return b}),G.addHooks("onError",async(Y,v,Z)=>{K?.()??M(Y.message,v.method,Z.toString(),500);let N=await V?.(Y,v,Z);if(N instanceof Response)return N})};function i(A,G){if(!A)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(K)=>{try{let X=K.cookies?.accessToken??K.req?.headers?.get("Authorization");if(!X)return K.json({message:"Unauthorized",error:"No token provided"},401);if(X.startsWith("Bearer "))X=X.slice(7);let $=A?.verify(X,G);if(!$)return K.json({message:"Unauthorized",error:"Token could not be decoded"},401);K.set("user",$)}catch(X){let $="Invalid token";if(X.name==="TokenExpiredError")$="Token expired";else if(X.name==="JsonWebTokenError")$="Malformed or tampered token";return K.json({message:"Unauthorized",error:$},401)}}}function n(A,G,K){if(!A)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!G)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(X)=>{try{let $=X.cookies?.accessToken??X.req?.headers?.get("Authorization");if(!$)return X.json({message:"Unauthorized",error:"No token provided"},401);if($.startsWith("Bearer "))$=$.slice(7);let V=A?.verify($,K);if(!V)return X.json({message:"Unauthorized",error:"Token could not be decoded"},401);let z=await G.findById(V._id).select("-password -refreshToken");if(!z)return X.json({message:"Unauthorized: User not found"},404);X.set("user",z);return}catch($){let V="Invalid token";if($.name==="TokenExpiredError")V="Token expired";else if($.name==="JsonWebTokenError")V="Malformed or tampered token";return X.json({message:"Unauthorized",error:V},401)}}}class p{routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;constructor({jwtSecret:A,baseApiUrl:G,enableFileRouting:K,idleTimeOut:X}={}){this.routes={},this.idleTimeOut=X??10,this.enableFileRouter=K??!1,this.baseApiUrl=G||"",this.user_jwt_secret=A||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new C,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[],routeNotFound:[]},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...A)=>{return this.FilterRoutes=A,this.setupFilter()},permitAll:()=>{for(let A of this?.FilterRoutes)this.filters.add(A);return this.FilterRoutes=null,this.setupFilter()},authenticate:(A)=>{if(A?.length)for(let G of A)this.filterFunction.push(G)},authenticateJwt:(A)=>{this.filterFunction.push(i(A,this.user_jwt_secret))},authenticateJwtDB:(A,G)=>{this.filterFunction.push(n(A,G,this.user_jwt_secret))}}}redirect(A,G,K){return this.any(A,(X)=>{let $=X.params,V=G;if($)for(let Y in $)V=V.replace(`:${Y}`,$[Y]);let z=X.url.search;if(z)V+=z;return X.redirect(V,K)}),this}serveStatic(A){return this.staticPath=A,this}staticHtml(A){return this.staticFiles={...this.staticFiles,...A},this}addHooks(A,G){if(typeof A!=="string")throw new Error("hookName must be a string");if(typeof G!=="function")throw new Error("callback must be a instance of function");switch(A){case"onRequest":this.hooks.onRequest?.push(G);break;case"preHandler":this.hooks.preHandler?.push(G);break;case"postHandler":this.hooks.postHandler?.push(G);break;case"onSend":this.hooks.onSend?.push(G);break;case"onError":this.hooks.onError?.push(G);break;case"onClose":this.hooks.onClose?.push(G);break;case"routeNotFound":this.hooks.routeNotFound?.push(G);break;default:throw new Error(`Unknown hook type: ${A}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[A,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}if(this.enableFileRouter){let A=process.cwd(),G=F.join(A,"src","routes");if(S?.existsSync(G))this.loadRoutes(G,"")}setTimeout(()=>{this.tempRoutes=null},2000)}async registerFileRoutes(A,G,K){let X=await import(A),$;if(K===".ts")$=F.basename(A,".ts");else if(K===".js")$=F.basename(A,".js");let V=G+"/"+$;if(V.endsWith("/index"))V=G;else if(V.endsWith("/api"))V=G;V=V.replace(/\[(.*?)\]/g,":$1");let z=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let Y of z)if(X[Y]){let v=Y.toLowerCase(),Z=X[Y];this[v](`${this.baseApiUrl}${V}`,Z)}}async loadRoutes(A,G){let K=await S.promises.readdir(A);for(let X of K){let $=F.join(A,X);if((await S.promises.stat($)).isDirectory())this.loadRoutes($,G+"/"+X);else if(X.endsWith(".ts"))this.registerFileRoutes($,G,".ts");else if(X.endsWith(".js"))this.registerFileRoutes($,G,".js")}}useLogger(A){return u(A),this}useAdvancedLogger(A){return R(A),this}BunRoute(A,G,...K){if(!G||typeof G!=="string")throw new Error("give a path in string format");if(K.length===1){let X=K[0];this.routes[G]=async($,V)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let v=await j(this.globalMiddlewares,$,V);if(v)return v}let Y=this.middlewares.get(G)||[];if(Y?.length){let v=await j(Y,$,V);if(v)return v}}if(A!==$.method)return new Response("Method Not Allowed",{status:405});let z=await X($,V);if(z instanceof Promise)return await z??new Response("Not Found",{status:404});return z??new Response("Not Found",{status:404})}}else this.routes[G]=async(X,$)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let z=await j(this.globalMiddlewares,X,$);if(z)return z}let V=this.middlewares.get(G)||[];if(V?.length){let z=await j(V,X,$);if(z)return z}}if(A!==X.method)return new Response("Method Not Allowed",{status:405});for(let V=0;V<K.length;V++){let z=K[V](X,$);if(z instanceof Promise)return await z??new Response("Not Found",{status:404});return z??new Response("Not Found",{status:404})}}}listen(A,...G){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let K="0.0.0.0",X=void 0,$={};for(let z of G)if(typeof z==="string")K=z;else if(typeof z==="function")X=z;else if(typeof z==="object"&&z!==null)$=z;this.compile();let V={port:A,hostname:K,idleTimeOut:this.idleTimeOut,fetch:async(z,Y)=>{let v=new URL(z.url);if(this.hooks.onRequest){let Z=this.hooks.onRequest;for(let N=0;N<Z.length;N++)await Z[N](z,v,Y)}return y(z,Y,v,this)},static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)console.log(this.routes),V.routes=this.routes;if($.sslCert&&$.sslKey)V.certFile=$.sslCert,V.keyFile=$.sslKey;if(this.serverInstance=Bun?.serve(V),$.sslCert&&$.sslKey)console.log(`HTTPS server is running on https://localhost:${A}`);if(X)return X();return this.serverInstance}close(A){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,A?A():console.log("Server has been stopped");else console.warn("Server is not running.")}route(A,G){if(!A||typeof A!=="string")throw new Error("Path must be a string");let K=Object.fromEntries(G.tempRoutes);return Object.entries(K).forEach(([$,V])=>{let z=$.replace(/::\w+$/,""),Y=`${A}${z}`;if(!this.middlewares.has(Y))this.middlewares.set(Y,[]);V.handlers.slice(0,-1).forEach((b)=>{if(!this.middlewares.get(Y)?.includes(b))this.middlewares.get(Y)?.push(b)});let Z=V.handlers[V.handlers.length-1],N=V.method;try{this.trie.insert(Y,{handler:Z,method:N})}catch(b){console.error(`Error inserting ${Y}:`,b)}}),G=null,this}register(A,G){return this.route(A,G)}addRoute(A,G,K){if(typeof G!=="string")throw new Error(`Error in ${K[K.length-1]}: Path must be a string. Received: ${typeof G}`);if(typeof A!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof A}`);this.tempRoutes?.set(G+"::"+A,{method:A,handlers:K});let X=K.slice(0,-1),$=K[K.length-1];if(!this.middlewares.has(G))this.middlewares.set(G,[]);X.forEach((V)=>{if(G==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...X])];else if(!this.middlewares.get(G)?.includes(V))this.middlewares.get(G)?.push(V)});try{if(A==="ANY"){let V=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let z of V)this.trie.insert(G,{handler:$,method:z})}this.trie.insert(G,{handler:$,method:A})}catch(V){console.error(`Error inserting ${G}:`,V)}}use(A,G){if(Array.isArray(A))A.forEach((X)=>{if(typeof X==="function")this.globalMiddlewares.push(X)});if(typeof A==="function"){if(this.globalMiddlewares.push(A),Array.isArray(G))G.forEach((X)=>{this.globalMiddlewares.push(X)});return}return(Array.isArray(A)?A.filter((X)=>typeof X==="string"):[A].filter((X)=>typeof X==="string")).forEach((X)=>{if(!this.middlewares.has(X))this.middlewares.set(X,[]);if(G)(Array.isArray(G)?G:[G]).forEach((V)=>{this.middlewares.get(X)?.push(V)})}),this}get(A,...G){return this.addRoute("GET",A,G),this}post(A,...G){return this.addRoute("POST",A,G),this}put(A,...G){return this.addRoute("PUT",A,G),this}patch(A,...G){return this.addRoute("PATCH",A,G),this}delete(A,...G){return this.addRoute("DELETE",A,G),this}any(A,...G){return this.addRoute("ANY",A,G),this}head(A,...G){return this.addRoute("HEAD",A,G),this}options(A,...G){return this.addRoute("OPTIONS",A,G),this}propfind(A,...G){return this.addRoute("PROPFIND",A,G),this}}export{p as default};
