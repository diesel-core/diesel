class B{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class D{root;constructor(){this.root=new B}insert(z,G){let L=this.root,J=z.split("/").filter(Boolean);if(z==="/"){L.isEndOfWord=!0,L.handler.push(G.handler),L.path=z,L.method.push(G.method);return}for(let Y of J){let U=!1,X=Y;if(Y.startsWith(":"))U=!0,X=":";if(!L.children[X])L.children[X]=new B;L=L.children[X],L.isDynamic=U,L.pattern=Y,L.method.push(G.method),L.handler.push(G.handler),L.path=z}L.isEndOfWord=!0,L.method.push(G.method),L.handler.push(G.handler),L.path=z}search(z,G){let L=this.root,J=z.split("/").filter(Boolean),Y=J.length;for(let $ of J){let K=$;if(!L.children[K])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[K]}let U=L.path.split("/").filter(Boolean);if(Y!==U.length)return null;let X=L.method.indexOf(G);if(X!==-1)return{path:L.path,handler:L.handler[X],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[X]};return{path:L.path,handler:L.handler,isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[X]}}}function Q(z){switch(z.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function j(z,G,L){let J=new Headers({"X-Powered-By":"DieselJS","Cache-Control":"no-cache"});J.set("X-Powered-By","DieselJS");let Y={},U=!1,X,$=null,K,E,_={};return{req:z,server:G,url:L,setHeader(Z,W){return J.set(Z,W),this},getUser(){return _},setUser(Z){if(Z)_=Z},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!E)E=await b(z);if(E.error)return new Response(JSON.stringify({error:E.error}),{status:400});return E},set(Z,W){if(typeof Z!=="string")throw new Error("Key must be string type!");if(!W)throw new Error("value paramter is missing pls pass value after key");return Y[Z]=W,this},get(Z){return Z?Y[Z]:null},setAuth(Z){return U=Z,this},getAuth(){return U},text(Z,W){if(!J.has("Content-Type"))J.set("Content-Type","text/plain; charset=utf-8");return new Response(Z,{status:W,headers:J})},send(Z,W){if(typeof Z==="string"){if(!J.has("Content-Type"))J.set("Content-Type","text/plain; charset=utf-8")}else if(typeof Z==="object"){if(!J.has("Content-Type"))J.set("Content-Type","application/json; charset=utf-8");Z=JSON.stringify(Z)}else if(Z instanceof Uint8Array||Z instanceof ArrayBuffer){if(!J.has("Content-Type"))J.set("Content-Type","application/octet-stream")}return new Response(Z,{status:W,headers:J})},json(Z,W){if(!J.has("Content-Type"))J.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(Z),{status:W,headers:J})},file(Z,W=200,F){let A=Q(Z),M=Bun.file(Z),V=new Headers;if(!V.has("Content-Type"))V.set("Content-Type",F??A);return new Response(M,{status:W,headers:V})},redirect(Z,W){return J.set("Location",Z),new Response(null,{status:W??302,headers:J})},setCookie(Z,W,F={}){let A=`${encodeURIComponent(Z)}=${encodeURIComponent(W)}`;if(F.maxAge)A+=`; Max-Age=${F.maxAge}`;if(F.expires)A+=`; Expires=${F.expires.toUTCString()}`;if(F.path)A+=`; Path=${F.path}`;if(F.domain)A+=`; Domain=${F.domain}`;if(F.secure)A+="; Secure";if(F.httpOnly)A+="; HttpOnly";if(F.sameSite)A+=`; SameSite=${F.sameSite}`;return J?.append("Set-Cookie",A),this},getParams(Z){if(!K&&z?.routePattern)K=I(z?.routePattern,L?.pathname);if(Z)if(K)return K[Z];else return;if(K)return Z;else return},getQuery(Z){try{if(!X)X=Object.fromEntries(L.searchParams);if(Z)return X[Z]??void 0;return X}catch(W){return}},getCookie(Z){if(!$){let W=z.headers.get("cookie");if(W)$=T(W);else return}if(!$)return;if(Z)return $[Z]??void 0;else return $}}}function T(z){let G={},L=z?.split(";");for(let J=0;J<L?.length;J++){let[Y,...U]=L[J].trim().split("="),X=U?.join("=").trim();if(Y)G[Y.trim()]=decodeURIComponent(X)}return G}function I(z,G){let L={},J=z.split("/"),[Y]=G.split("?"),U=Y.split("/");if(J.length!==U.length)return null;for(let X=0;X<J.length;X++)if(J[X].startsWith(":"))L[J[X].slice(1)]=U[X];return L}async function b(z){let G=z.headers.get("Content-Type");if(!G)return{};try{if(G.startsWith("application/json"))return await z.json();if(G.startsWith("application/x-www-form-urlencoded")){let L=await z.text();return Object.fromEntries(new URLSearchParams(L))}if(G.startsWith("multipart/form-data")){let L=await z.formData(),J={};for(let[Y,U]of L.entries())J[Y]=U;return J}return{error:"Unknown request body type"}}catch(L){return{error:"Invalid request body format"}}}async function N(z,G,L,J){let Y=J.trie.search(L.pathname,z.method);if(Y?.isDynamic)z.routePattern=Y.path;let U=j(z,G,L);if(J.corsConfig){let $=R(z,U,J.corsConfig);if($)return $}if(J.hasOnReqHook&&J.hooks.onRequest)J.hooks.onRequest(z,L,G);if(J.hasFilterEnabled){let $=z.routePattern??L.pathname,K=await S(J,$,U,G);if(K)return K}if(J.hasMiddleware){let $=J.globalMiddlewares;for(let E=0;E<$.length;E++){let _=await $[E](U,G);if(_)return _}let K=J.middlewares.get(L.pathname)||[];for(let E=0;E<K.length;E++){let _=await K[E](U,G);if(_)return _}}if(!Y||Y.method!==z.method){let $=J.trie.search("*",z.method);if($){if(!J.staticFiles)throw new Error("Static files directory is not configured.");if(L.pathname.endsWith(".js")||L.pathname.endsWith(".css")||L.pathname.endsWith(".html")){let Z=`${J.staticFiles}${L.pathname}`,W=Q(Z);return U.file(Z,200,W)}return await $.handler(U)}let K=Y?405:404,E=Y?"Method not allowed":`Route not found for ${L.pathname}`;return new Response(JSON.stringify({error:!0,message:E,status:K}),{status:K,headers:{"Content-Type":"application/json"}})}if(J.hasPreHandlerHook&&J.hooks.preHandler){let $=await J.hooks.preHandler(U);if($)return $}let X=await Y.handler(U);if(J.hasPostHandlerHook&&J.hooks.postHandler)await J.hooks.postHandler(U);if(J.hasOnSendHook&&J.hooks.onSend){let $=await J.hooks.onSend(U,X);if($)return $}return X??U.json({error:!0,message:"No response from this handler",status:204},204)}function R(z,G,L={}){let J=z.headers.get("origin")??"*",Y=L?.origin,U=L?.allowedHeaders??["Content-Type","Authorization"],X=L?.methods??["GET","POST","PUT","DELETE","OPTIONS"],$=L?.credentials??!1,K=L?.exposedHeaders??[];if(G.setHeader("Access-Control-Allow-Methods",X),G.setHeader("Access-Control-Allow-Headers",U),G.setHeader("Access-Control-Allow-Credentials",$),K.length)G.setHeader("Access-Control-Expose-Headers",K);if(Y==="*"||J==="*")G.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(Y))if(J&&Y.includes(J))G.setHeader("Access-Control-Allow-Origin",J);else if(Y.includes("*"))G.setHeader("Access-Control-Allow-Origin","*");else return G.json({message:"CORS not allowed"},403);else if(typeof Y==="string")if(J===Y)G.setHeader("Access-Control-Allow-Origin",J);else return G.json({message:"CORS not allowed"},403);else return G.json({message:"CORS not allowed"},403);if(G.setHeader("Access-Control-Allow-Origin",J),z.method==="OPTIONS")return G.setHeader("Access-Control-Max-Age","86400"),G.text("",204);return null}async function S(z,G,L,J){if(!z.filters.has(G))if(z.filterFunction.length)for(let Y of z.filterFunction){let U=await Y(L,J);if(U)return U}else return L.json({error:!0,message:"Protected route,authentication required",status:401},401)}class C{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticFiles=null}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...z)=>{return this.FilterRoutes=z,this.setupFilter()},permitAll:()=>{for(let z of this?.FilterRoutes)this.filters.add(z);return this.FilterRoutes=null,this.setupFilter()},authenticate:(z)=>{if(z?.length)for(let G of z)this.filterFunction.push(G)}}}cors(z){return this.corsConfig=z,this}static(z){this.staticFiles=z}addHooks(z,G){if(typeof z!=="string")throw new Error("hookName must be a string");if(typeof G!=="function")throw new Error("callback must be a instance of function");switch(z){case"onRequest":this.hooks.onRequest=G,this.hasOnReqHook=!0;break;case"preHandler":this.hooks.preHandler=G,this.hasPreHandlerHook=!0;break;case"postHandler":this.hooks.postHandler=G,this.hasPostHandlerHook=!0;break;case"onSend":this.hooks.onSend=G,this.hasOnSendHook=!0;break;case"onError":this.hooks.onError=G,this.hasOnError=!0;break;case"onClose":this.hooks.onClose=G;break;default:throw new Error(`Unknown hook type: ${z}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[z,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0;if(this.hooks.onError)this.hasOnError=!0;this.tempRoutes=new Map}listen(z=3000,...G){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(!z||typeof z!=="number")throw new Error("port is required and should be a number type");let L="0.0.0.0",J=void 0,Y={};for(let X of G)if(typeof X==="string")L=X;else if(typeof X==="function")J=X;else if(typeof X==="object"&&X!==null)Y=X;let U={port:z,hostname:L,fetch:async(X,$)=>{let K=new URL(X.url);try{return await N(X,$,K,this)}catch(E){if(this.hasOnError&&this.hooks.onError){let _=await this.hooks.onError(E,X,K,$);if(_)return _}return new Response(JSON.stringify({message:"Internal Server Error",error:E.message,staus:500}),{status:500})}}};if(Y.sslCert&&Y.sslKey)U.certFile=Y.sslCert,U.keyFile=Y.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(U),J)return J();if(Y.sslCert&&Y.sslKey)console.log(`HTTPS server is running on https://localhost:${z}`);else console.log(`HTTP server is running on http://localhost:${z}`);return this.serverInstance}close(){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,console.log("Server has been stopped.");else console.warn("Server is not running.")}route(z,G){if(!z||typeof z!=="string")throw new Error("Path must be a string");let L=Object.fromEntries(G.tempRoutes);return Object.entries(L).forEach(([Y,U])=>{let X=`${z}${Y}`;if(!this.middlewares.has(X))this.middlewares.set(X,[]);U.handlers.slice(0,-1).forEach((_)=>{if(!this.middlewares.get(X)?.includes(_))this.middlewares.get(X)?.push(_)});let K=U.handlers[U.handlers.length-1],E=U.method;try{this.trie.insert(X,{handler:K,method:E})}catch(_){console.error(`Error inserting ${X}:`,_)}}),G=null,this}register(z,G){return this.route(z,G)}addRoute(z,G,L){if(typeof G!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof G}`);if(typeof z!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof z}`);this.tempRoutes.set(G,{method:z,handlers:L});let J=L.slice(0,-1),Y=L[L.length-1];if(!this.middlewares.has(G))this.middlewares.set(G,[]);J.forEach((U)=>{if(G==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...J])];else if(!this.middlewares.get(G)?.includes(U))this.middlewares.get(G)?.push(U)});try{if(z==="ANY"){let U=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD"];for(let X of U)this.trie.insert(G,{handler:Y,method:X})}this.trie.insert(G,{handler:Y,method:z})}catch(U){console.error(`Error inserting ${G}:`,U)}}use(z,G){if(Array.isArray(z))z.forEach((J)=>{if(typeof J==="function")this.globalMiddlewares.push(J)});if(typeof z==="function"){if(this.globalMiddlewares.push(z),Array.isArray(G))G.forEach((J)=>{this.globalMiddlewares.push(J)});return}return(Array.isArray(z)?z.filter((J)=>typeof J==="string"):[z].filter((J)=>typeof J==="string")).forEach((J)=>{if(!this.middlewares.has(J))this.middlewares.set(J,[]);if(G)(Array.isArray(G)?G:[G]).forEach((U)=>{this.middlewares.get(J)?.push(U)})}),this}get(z,...G){return this.addRoute("GET",z,G),this}post(z,...G){return this.addRoute("POST",z,G),this}put(z,...G){return this.addRoute("PUT",z,G),this}patch(z,...G){return this.addRoute("PATCH",z,G),this}delete(z,...G){return this.addRoute("DELETE",z,G),this}any(z,...G){return this.addRoute("ANY",z,G),this}head(z,...G){return this.addRoute("HEAD",z,G),this}options(z,...G){return this.addRoute("OPTIONS",z,G),this}}export{C as default};
