class U{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class K{root;constructor(){this.root=new U}insert(w,F){let $=this.root,R=w.split("/").filter(Boolean);if(w==="/"){$.isEndOfWord=!0,$.handler.push(F.handler),$.path=w,$.method.push(F.method);return}for(let f of R){let J=!1,C=f;if(f.startsWith(":"))J=!0,C=":";if(!$.children[C])$.children[C]=new U;$=$.children[C],$.isDynamic=J,$.pattern=f,$.method.push(F.method),$.handler.push(F.handler),$.path=w}$.isEndOfWord=!0,$.method.push(F.method),$.handler.push(F.handler),$.path=w}search(w,F){let $=this.root,R=w.split("/").filter(Boolean),f=R.length;for(let z of R){let L=z;if(!$.children[L])if($.children[":"])$=$.children[":"];else return null;else $=$.children[L]}let J=$.path.split("/").filter(Boolean);if(f!==J.length)return null;let C=$.method.indexOf(F);if(C!==-1)return{path:$.path,handler:$.handler[C],isDynamic:$.isDynamic,pattern:$.pattern,method:$.method[C]};return{path:$.path,handler:$.handler,isDynamic:$.isDynamic,pattern:$.pattern,method:$.method[C]}}}function j(w){let{time:F=60000,max:$=100,message:R="Rate limit exceeded. Please try again later."}=w,f=new Map;return(J)=>{let C=new Date,z=J.ip;if(!f.has(z))f.set(z,{count:0,startTime:C});let L=f.get(z);if(L)if(C-L.startTime>F)L.count=1,L.startTime=C;else L.count++;if(L&&L.count>$)return J.json({error:R},429)}}function N(w){switch(w.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var M=(w,F,$,R)=>{if($>R)return!1;let f=$+(R-$)/2;if(w[f]==F)return!0;if(w[f]>F)return M(w,F,$,f-1);return M(w,F,f+1,R)};function X(w,F,$){let R=new Headers({"Cache-Control":"no-cache"}),f=null,J=null,C=null,z=null,L={};return{req:w,server:F,url:$,setHeader(E,x){return R.set(E,x),this},removeHeader(E){return R.delete(E),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!f)try{f=Object.fromEntries(this.url.searchParams)}catch(E){throw new Error("Failed to parse query parameters")}return f},get params(){if(!J&&this.req.routePattern)try{J=T(this.req.routePattern,this.url.pathname)}catch(E){throw new Error("Failed to extract route parameters")}return J??{}},get body(){if(!z)z=(async()=>{let E=await B(this.req);if(E.error)throw new Error(E.error);return Object.keys(E).length===0?null:E})();return z},set(E,x){return L[E]=x,this},get(E){return L[E]},text(E,x=200){if(!R.has("Content-Type"))R.set("Content-Type","text/plain; charset=utf-8");return new Response(E,{status:x,headers:R})},send(E,x=200){let A=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),G=E instanceof Uint8Array?"Uint8Array":E instanceof ArrayBuffer?"ArrayBuffer":typeof E;if(!R.has("Content-Type"))R.set("Content-Type",A.get(G)??"text/plain; charset=utf-8");let _=G==="object"&&E!==null?JSON.stringify(E):E;return new Response(_,{status:x,headers:R})},json(E,x=200){if(!R.has("Content-Type"))R.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(E),{status:x,headers:R})},file(E,x=200,A){let G=Bun.file(E);if(!R.has("Content-Type"))R.set("Content-Type",A??N(E));return new Response(G,{status:x,headers:R})},redirect(E,x=302){return R.set("Location",E),new Response(null,{status:x,headers:R})},setCookie(E,x,A={}){let G=`${encodeURIComponent(E)}=${encodeURIComponent(x)}`;if(A.maxAge)G+=`; Max-Age=${A.maxAge}`;if(A.expires)G+=`; Expires=${A.expires.toUTCString()}`;if(A.path)G+=`; Path=${A.path}`;if(A.domain)G+=`; Domain=${A.domain}`;if(A.secure)G+="; Secure";if(A.httpOnly)G+="; HttpOnly";if(A.sameSite)G+=`; SameSite=${A.sameSite}`;return R.append("Set-Cookie",G),this},get cookies(){if(!C){let E=this.req.headers.get("cookie");C=E?D(E):{}}return C}}}function D(w){return Object.fromEntries(w.split(";").map((F)=>{let[$,...R]=F.trim().split("=");return[$,decodeURIComponent(R.join("="))]}))}function T(w,F){let $={},R=w.split("/"),[f]=F.split("?"),J=f.split("/");if(R.length!==J.length)return null;for(let C=0;C<R.length;C++)if(R[C].startsWith(":"))$[R[C].slice(1)]=J[C];return $}async function B(w){let F=w.headers.get("Content-Type");if(!F)return{};if(w.headers.get("Content-Length")==="0"||!w.body)return{};try{if(F.startsWith("application/json"))return await w.json();if(F.startsWith("application/x-www-form-urlencoded")){let R=await w.text();return Object.fromEntries(new URLSearchParams(R))}if(F.startsWith("multipart/form-data")){let R=await w.formData(),f={};for(let[J,C]of R.entries())f[J]=C;return f}return{error:"Unknown request body type"}}catch(R){return{error:"Invalid request body format"}}}async function Z(w,F,$,R){let f=X(w,F,$),J=R.trie.search($.pathname,w.method);if(w.routePattern=J?.path,R.hasFilterEnabled){let L=w.routePattern??$.pathname,E=await Q(R,L,f,F);if(E)return E}if(R.hasMiddleware){let L=await V(R.globalMiddlewares,f,F);if(L)return L;let E=R.middlewares.get($.pathname)||[],x=await V(E,f,F);if(x)return x}if(!J?.handler||J.method!==w.method){if(R.staticPath){let L=await P(R,$.pathname,f);if(L)return L;let E=R.trie.search("*",w.method);if(E?.handler)return await E.handler(f)}if(R.hooks.routeNotFound&&!J?.handler){let L=await R.hooks.routeNotFound(f);if(L)return L}if(!J||!J?.handler?.length)return Y(404,`Route not found for ${$.pathname}`);return Y(405,"Method not allowed")}if(R.hooks.preHandler){let L=await R.hooks.preHandler(f);if(L)return L}let C=J.handler(f),z=C instanceof Promise?await C:C;if(R.hooks.postHandler)await R.hooks.postHandler(f);if(R.hooks.onSend){let L=await R.hooks.onSend(f,z);if(L)return L}return z??Y(204,"No response from this handler")}async function V(w,F,$){for(let R of w){let f=await R(F,$);if(f)return f}return null}async function Q(w,F,$,R){if(!w.filters.has(F))if(w.filterFunction.length)for(let f of w.filterFunction){let J=await f($,R);if(J)return J}else return $.json({error:!0,message:"Protected route, authentication required",status:401},401)}function Y(w,F){return new Response(JSON.stringify({error:!0,message:F,status:w}),{status:w,headers:{"Content-Type":"application/json"}})}async function P(w,F,$){if(!w.staticPath)return null;let R=`${w.staticPath}${F}`;if(await Bun.file(R).exists()){let J=N(R);return $.file(R,200,J)}return null}class W{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new K,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null,routeNotFound:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...w)=>{return this.FilterRoutes=w,this.setupFilter()},permitAll:()=>{for(let w of this?.FilterRoutes)this.filters.add(w);return this.FilterRoutes=null,this.setupFilter()},authenticate:(w)=>{if(w?.length)for(let F of w)this.filterFunction.push(F)}}}serveStatic(w){this.staticPath=w}static(w={}){return this.staticFiles={...this.staticFiles,...w},this}addHooks(w,F){if(typeof w!=="string")throw new Error("hookName must be a string");if(typeof F!=="function")throw new Error("callback must be a instance of function");switch(w){case"onRequest":this.hooks.onRequest=F;break;case"preHandler":this.hooks.preHandler=F;break;case"postHandler":this.hooks.postHandler=F;break;case"onSend":this.hooks.onSend=F;break;case"onError":this.hooks.onError=F;break;case"onClose":this.hooks.onClose=F;break;case"routeNotFound":this.hooks.routeNotFound=F;break;default:throw new Error(`Unknown hook type: ${w}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[w,F]of this.middlewares.entries())if(F.length>0){this.hasMiddleware=!0;break}this.tempRoutes=new Map}listen(w=3000,...F){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(!w||typeof w!=="number")throw new Error("port is required and should be a number type");let $="0.0.0.0",R=void 0,f={};for(let C of F)if(typeof C==="string")$=C;else if(typeof C==="function")R=C;else if(typeof C==="object"&&C!==null)f=C;let J={port:w,hostname:$,fetch:async(C,z)=>{let L=new URL(C.url);try{if(this.hooks.onRequest)this.hooks.onRequest(C,L,z);return await Z(C,z,L,this)}catch(E){return this.hooks.onError?this.hooks.onError(E,C,L,z):new Response(JSON.stringify({message:"Internal Server Error",error:E.message,status:500}),{status:500})}},static:this.staticFiles,development:!0};if(f.sslCert&&f.sslKey)J.certFile=f.sslCert,J.keyFile=f.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(J),R){process.nextTick(()=>R);return}if(f.sslCert&&f.sslKey)console.log(`HTTPS server is running on https://localhost:${w}`);else console.log(`HTTP server is running on http://localhost:${w}`);return this.serverInstance}close(w){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,w?w():console.log("Server has been stopped");else console.warn("Server is not running.")}route(w,F){if(!w||typeof w!=="string")throw new Error("Path must be a string");let $=Object.fromEntries(F.tempRoutes);return Object.entries($).forEach(([f,J])=>{let C=`${w}${f}`;if(!this.middlewares.has(C))this.middlewares.set(C,[]);J.handlers.slice(0,-1).forEach((x)=>{if(!this.middlewares.get(C)?.includes(x))this.middlewares.get(C)?.push(x)});let L=J.handlers[J.handlers.length-1],E=J.method;try{this.trie.insert(C,{handler:L,method:E})}catch(x){console.error(`Error inserting ${C}:`,x)}}),F=null,this}register(w,F){return this.route(w,F)}addRoute(w,F,$){if(typeof F!=="string")throw new Error(`Error in ${$[$.length-1]}: Path must be a string. Received: ${typeof F}`);if(typeof w!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof w}`);this.tempRoutes.set(F,{method:w,handlers:$});let R=$.slice(0,-1),f=$[$.length-1];if(!this.middlewares.has(F))this.middlewares.set(F,[]);R.forEach((J)=>{if(F==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...R])];else if(!this.middlewares.get(F)?.includes(J))this.middlewares.get(F)?.push(J)});try{if(w==="ANY"){let J=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let C of J)this.trie.insert(F,{handler:f,method:C})}this.trie.insert(F,{handler:f,method:w})}catch(J){console.error(`Error inserting ${F}:`,J)}}use(w,F){if(Array.isArray(w))w.forEach((R)=>{if(typeof R==="function")this.globalMiddlewares.push(R)});if(typeof w==="function"){if(this.globalMiddlewares.push(w),Array.isArray(F))F.forEach((R)=>{this.globalMiddlewares.push(R)});return}return(Array.isArray(w)?w.filter((R)=>typeof R==="string"):[w].filter((R)=>typeof R==="string")).forEach((R)=>{if(!this.middlewares.has(R))this.middlewares.set(R,[]);if(F)(Array.isArray(F)?F:[F]).forEach((J)=>{this.middlewares.get(R)?.push(J)})}),this}get(w,...F){return this.addRoute("GET",w,F),this}post(w,...F){return this.addRoute("POST",w,F),this}put(w,...F){return this.addRoute("PUT",w,F),this}patch(w,...F){return this.addRoute("PATCH",w,F),this}delete(w,...F){return this.addRoute("DELETE",w,F),this}any(w,...F){return this.addRoute("ANY",w,F),this}head(w,...F){return this.addRoute("HEAD",w,F),this}options(w,...F){return this.addRoute("OPTIONS",w,F),this}propfind(w,...F){return this.addRoute("PROPFIND",w,F),this}}export{W as default};
