class B{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class Q{root;constructor(){this.root=new B}insert(G,z){let F=this.root;const J=G.split("/").filter(Boolean);if(G==="/"){F.isEndOfWord=!0,F.handler.push(z.handler),F.path=G,F.method.push(z.method);return}for(let U of J){let X=!1,Y=U;if(U.startsWith(":"))X=!0,Y=":";if(!F.children[Y])F.children[Y]=new B;F=F.children[Y],F.isDynamic=X,F.pattern=U}F.isEndOfWord=!0,F.method.push(z.method),F.handler.push(z.handler),F.path=G}search(G,z){let F=this.root;const J=G.split("/").filter(Boolean);for(let X of J){let Y=X;if(!F.children[Y])if(F.children[":"])F=F.children[":"];else return null;else F=F.children[Y]}let U=F.method.indexOf(z);if(U!==-1)return{path:F.path,handler:F.handler[U],isDynamic:F.isDynamic,pattern:F.pattern,method:F.method[U]};return{path:F.path,handler:F.handler,isDynamic:F.isDynamic,pattern:F.pattern,method:F.method[U]}}}async function D(G){const z={};if(!G)return z;return G.split(";").forEach((J)=>{const[U,X]=J?.trim()?.split("=");if(U&&X)z[U.trim()]=X.split(" ")[0].trim()}),z}function N(G,z){const F={},J=G.split("/"),[U]=z.split("?"),X=U.split("/");if(J.length!==X.length)return null;return J.forEach((Y,_)=>{if(Y.startsWith(":")){const $=Y.slice(1);F[$]=X[_]}}),F}async function b(G){const z=G.headers.get("Content-Type")||"";if(!z)return{};try{if(z.startsWith("application/json"))return await G.json();if(z.startsWith("application/x-www-form-urlencoded")){const F=await G.text();return Object.fromEntries(new URLSearchParams(F))}if(z.startsWith("multipart/form-data")){const F=await G.formData();return T(F)}return{error:"Unknown request body type"}}catch(F){return{error:"Invalid request body format"}}}function T(G){const z={};for(let[F,J]of G.entries())z[F]=J;return z}function K(G,z,F){let J=new Headers,U={},X=!1,Y=null,_=null,$=null,A,V=200;return{req:G,server:z,url:F,next:()=>{},status(Z){return V=Z,this},getIP(){return this.server.requestIP(this.req)},async body(){if(!A)A=await b(G);if(A.error)return new Response(JSON.stringify({error:A.error}),{status:400});return A},setHeader(Z,E){return J.set(Z,E),this},set(Z,E){return U[Z]=E,this},get(Z){return U[Z]||null},setAuth(Z){return X=Z,this},getAuth(){return X},text(Z,E){return new Response(Z,{status:E??V,headers:J})},json(Z,E){return new Response(JSON.stringify(Z),{status:E??V,headers:J})},html(Z,E){return new Response(Bun.file(Z),{status:E??V,headers:J})},file(Z,E){return new Response(Bun.file(Z),{status:E??V,headers:J})},redirect(Z,E){return J.set("Location",Z),new Response(null,{status:E??302,headers:J})},getParams(Z){if(!$)$=N(G?.routePattern,F?.pathname);return Z?$[Z]||null:$},getQuery(Z){if(!Y)Y=Object.fromEntries(F.searchParams);return Z?Y[Z]||null:Y},async cookie(Z,E,L={}){let W=`${encodeURIComponent(Z)}=${encodeURIComponent(E)}`;if(L.maxAge)W+=`; Max-Age=${L.maxAge}`;if(L.expires)W+=`; Expires=${L.expires.toUTCString()}`;if(L.path)W+=`; Path=${L.path}`;if(L.domain)W+=`; Domain=${L.domain}`;if(L.secure)W+="; Secure";if(L.httpOnly)W+="; HttpOnly";if(L.sameSite)W+=`; SameSite=${L.sameSite}`;return J?.append("Set-Cookie",W),this},async getCookie(Z){if(!_){const E=G.headers.get("cookie");if(E)_=await D(E)}return Z?_[Z]||null:_}}}async function C(G,z,F){for(let J of G){const U=await J(z,F);if(U)return U}}async function v(G,z,F={}){const J=G.headers.get("origin")??"*",U=F?.origin,X=F?.allowedHeaders??["Content-Type","Authorization"],Y=F?.methods??["GET","POST","PUT","DELETE","OPTIONS"],_=F?.credentials??!1,$=F?.exposedHeaders??[];if(z.setHeader("Access-Control-Allow-Methods",Y),z.setHeader("Access-Control-Allow-Headers",X),z.setHeader("Access-Control-Allow-Credentials",_),$.length)z.setHeader("Access-Control-Expose-Headers",$);if(U==="*")z.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(U))if(J&&U.includes(J))z.setHeader("Access-Control-Allow-Origin",J);else if(U.includes("*"))z.setHeader("Access-Control-Allow-Origin","*");else return z.status(403).json({message:"CORS not allowed"});else if(typeof U==="string")if(J===U)z.setHeader("Access-Control-Allow-Origin",J);else return z.status(403).json({message:"CORS not allowed"});else return z.status(403).json({message:"CORS not allowed"});if(z.setHeader("Access-Control-Allow-Origin",J),G.method==="OPTIONS")return z.setHeader("Access-Control-Max-Age","86400"),z.status(204).text("");return null}var j={};async function M(G,z,F,J){const U=K(G,z,F);if(J.corsConfig){const Y=await v(G,U,J.corsConfig);if(Y)return Y}if(J.hasOnReqHook&&J.hooks.onRequest)await J.hooks.onRequest(U,z);if(J.hasMiddleware){const Y=[...J.globalMiddlewares,...J.middlewares.get(F.pathname)||[]],_=await C(Y,U,z);if(_)return _}let X;if(j[F.pathname+G.method])X=j[F.pathname+G.method];else X=J.trie.search(F.pathname,G.method),j[F.pathname+G.method]=X;if(!X||!X.handler)return new Response(`Route not found for ${F.pathname}`,{status:404});if(X.method!==G.method)return new Response("Method not allowed",{status:405});if(X.isDynamic)G.routePattern=X.path;if(J.hasPreHandlerHook&&J.hooks.preHandler){const Y=await J.hooks.preHandler(U);if(Y)return Y}try{const Y=await X.handler(U);if(J.hasPostHandlerHook&&J.hooks.postHandler)await J.hooks.postHandler(U);if(J.hasOnSendHook&&J.hooks.onSend){const _=await J.hooks.onSend(U,Y);if(_)return _}return Y??new Response("No response from handler",{status:204})}catch(Y){return new Response("Internal Server Error",{status:500})}}function g(G){const{time:z=60000,max:F=100,message:J="Rate limit exceeded. Please try again later."}=G,U=new Map;return(X)=>{const Y=new Date,_=X.getIP().address;if(!U.has(_))U.set(_,{count:0,startTime:Y});const $=U.get(_);if($)if(Y-$.startTime>z)$.count=1,$.startTime=Y;else $.count++;if($&&$.count>F)return X.status(429).json({error:J});X.next()}}class R{routes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hooks;corsConfig;constructor(){this.routes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new Q,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null}}cors(G){this.corsConfig=G}addHooks(G,z){if(typeof G!=="string")throw new Error("hookName must be a string");if(typeof z!=="function")throw new Error("callback must be a instance of function");if(this.hooks.hasOwnProperty(G))this.hooks[G]=z;else throw new Error(`Unknown hook type: ${G}`)}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[G,z]of this.middlewares.entries())if(z.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0}listen(G,z,{sslCert:F=null,sslKey:J=null}={}){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(typeof G!=="number")throw new Error("Port must be a numeric value");this.compile();const U=this,X={port:G,fetch:async(_,$)=>{const A=new URL(_.url);try{return await M(_,$,A,this)}catch(V){return new Response("Internal Server Error",{status:500})}},onClose(){console.log("Server is shutting down...")}};if(F&&J)X.certFile=F,X.keyFile=J;const Y=Bun.serve(X);if(typeof z==="function")return z();if(F&&J)console.log(`HTTPS server is running on https://localhost:${G}`);else console.log(`HTTP server is running on http://localhost:${G}`);return Y}register(G,z){if(typeof G!=="string")throw new Error("path must be a string");if(typeof z!=="object")throw new Error("handler parameter should be a instance of router object",z);const F=Object.entries(z.trie.root.children);z.trie.root.subMiddlewares.forEach((J,U)=>{if(!this.middlewares.has(G+U))this.middlewares.set(G+U,[]);J?.forEach((X)=>{if(!this.middlewares.get(G+U)?.includes(X))this.middlewares.get(G+U)?.push(X)})});for(let[J,U]of F){const X=G+U?.path,Y=U.handler[0],_=U.method[0];this.trie.insert(X,{handler:Y,method:_})}z.trie=new Q}#z(G,z,F){if(typeof z!=="string")throw new Error("Path must be a string type");if(typeof G!=="string")throw new Error("method must be a string type");const J=F.slice(0,-1),U=F[F.length-1];if(!this.middlewares.has(z))this.middlewares.set(z,[]);J.forEach((X)=>{if(z==="/"){if(!this.globalMiddlewares.includes(X))this.globalMiddlewares.push(X)}else if(!this.middlewares.get(z)?.includes(X))this.middlewares.get(z)?.push(X)}),this.trie.insert(z,{handler:U,method:G})}use(G,z){if(typeof G==="function"){if(!this.globalMiddlewares.includes(G))this.globalMiddlewares.push(G);return}const F=G;if(!this.middlewares.has(F))this.middlewares.set(F,[]);if(z){if(!this.middlewares.get(F)?.includes(z))this.middlewares.get(F)?.push(z)}}get(G,...z){return this.#z("GET",G,z),this}post(G,...z){return this.#z("POST",G,z),this}put(G,...z){return this.#z("PUT",G,z),this}patch(G,...z){return this.#z("PATCH",G,z),this}delete(G,...z){return this.#z("DELETE",G,z),this}}export{g as rateLimit,R as Diesel};
