class Q{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class D{root;constructor(){this.root=new Q}insert(J,G){let L=this.root,z=J.split("/").filter(Boolean);if(J==="/"){L.isEndOfWord=!0,L.handler.push(G.handler),L.path=J,L.method.push(G.method);return}for(let X of z){let Y=!1,U=X;if(X.startsWith(":"))Y=!0,U=":";if(!L.children[U])L.children[U]=new Q;L=L.children[U],L.isDynamic=Y,L.pattern=X,L.method.push(G.method),L.handler.push(G.handler),L.path=J}L.isEndOfWord=!0,L.method.push(G.method),L.handler.push(G.handler),L.path=J}search(J,G){let L=this.root,z=J.split("/").filter(Boolean),X=z.length;for(let _ of z){let $=_;if(!L.children[$])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[$]}let Y=L.path.split("/").filter(Boolean);if(X!==Y.length)return null;let U=L.method.indexOf(G);if(U!==-1)return{path:L.path,handler:L.handler[U],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[U]};return{path:L.path,handler:L.handler,isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[U]}}}function V(J,G,L){let z=new Headers({"X-Powered-By":"DieselJS","Cache-Control":"no-cache"});z.set("X-Powered-By","DieselJS");let X={},Y=!1,U,_=null,$,K,W={};return{req:J,server:G,url:L,setHeader(Z,F){return z.set(Z,F),this},getUser(){return W},setUser(Z){if(Z)W=Z},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!K)K=await N(J);if(K.error)return new Response(JSON.stringify({error:K.error}),{status:400});return K},set(Z,F){if(typeof Z!=="string")throw new Error("Key must be string type!");if(!F)throw new Error("value paramter is missing pls pass value after key");return X[Z]=F,this},get(Z){return Z?X[Z]:null},setAuth(Z){return Y=Z,this},getAuth(){return Y},text(Z,F){if(!z.has("Content-Type"))z.set("Content-Type","text/plain; charset=utf-8");return new Response(Z,{status:F,headers:z})},send(Z,F){if(typeof Z==="string"){if(!z.has("Content-Type"))z.set("Content-Type","text/plain; charset=utf-8")}else if(typeof Z==="object"){if(!z.has("Content-Type"))z.set("Content-Type","application/json; charset=utf-8");Z=JSON.stringify(Z)}else if(Z instanceof Uint8Array||Z instanceof ArrayBuffer){if(!z.has("Content-Type"))z.set("Content-Type","application/octet-stream")}return new Response(Z,{status:F,headers:z})},json(Z,F){if(!z.has("Content-Type"))z.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(Z),{status:F,headers:z})},file(Z,F){let E=Bun.file(Z).type||"application/octet-stream";if(!z.has("Content-Type"))z.set("Content-Type",E);return new Response(Bun.file(Z),{status:F,headers:z})},redirect(Z,F){return z.set("Location",Z),new Response(null,{status:F??302,headers:z})},setCookie(Z,F,E={}){let A=`${encodeURIComponent(Z)}=${encodeURIComponent(F)}`;if(E.maxAge)A+=`; Max-Age=${E.maxAge}`;if(E.expires)A+=`; Expires=${E.expires.toUTCString()}`;if(E.path)A+=`; Path=${E.path}`;if(E.domain)A+=`; Domain=${E.domain}`;if(E.secure)A+="; Secure";if(E.httpOnly)A+="; HttpOnly";if(E.sameSite)A+=`; SameSite=${E.sameSite}`;return z?.append("Set-Cookie",A),this},getParams(Z){if(!$&&J?.routePattern)$=M(J?.routePattern,L?.pathname);if(Z)if($)return $[Z];else return;if($)return Z;else return},getQuery(Z){try{if(!U)U=Object.fromEntries(L.searchParams);if(Z)return U[Z]??void 0;return U}catch(F){return}},getCookie(Z){if(!_){let F=J.headers.get("cookie");if(F)_=I(F);else return}if(!_)return;if(Z)return _[Z]??void 0;else return _}}}function I(J){let G={},L=J?.split(";");for(let z=0;z<L?.length;z++){let[X,...Y]=L[z].trim().split("="),U=Y?.join("=").trim();if(X)G[X.trim()]=decodeURIComponent(U)}return G}function M(J,G){let L={},z=J.split("/"),[X]=G.split("?"),Y=X.split("/");if(z.length!==Y.length)return null;for(let U=0;U<z.length;U++)if(z[U].startsWith(":"))L[z[U].slice(1)]=Y[U];return L}async function N(J){let G=J.headers.get("Content-Type");if(!G)return{};try{if(G.startsWith("application/json"))return await J.json();if(G.startsWith("application/x-www-form-urlencoded")){let L=await J.text();return Object.fromEntries(new URLSearchParams(L))}if(G.startsWith("multipart/form-data")){let L=await J.formData(),z={};for(let[X,Y]of L.entries())z[X]=Y;return z}return{error:"Unknown request body type"}}catch(L){return{error:"Invalid request body format"}}}async function B(J,G,L,z){let X=z.trie.search(L.pathname,J.method);if(X?.isDynamic)J.routePattern=X.path;let Y=V(J,G,L);if(z.corsConfig){let _=T(J,Y,z.corsConfig);if(_)return _}if(z.hasOnReqHook&&z.hooks.onRequest)z.hooks.onRequest(J,L,G);if(z.hasFilterEnabled){let _=J.routePattern??L.pathname;if(!z.filters.has(_))if(z.filterFunction){let $=await z.filterFunction(Y,G);if($)return $}else return Y.json({error:!0,message:"Protected route,authentication required",status:400},400)}if(z.hasMiddleware){let _=z.globalMiddlewares;for(let K=0;K<_.length;K++){let W=await _[K](Y,G);if(W)return W}let $=z.middlewares.get(L.pathname)||[];for(let K=0;K<$.length;K++){let W=await $[K](Y,G);if(W)return W}}if(!X||X.method!==J.method){let _=X?405:404,$=X?"Method not allowed":`Route not found for ${L.pathname}`;return new Response(JSON.stringify({error:!0,message:$,status:_}),{status:_,headers:{"Content-Type":"application/json"}})}if(z.hasPreHandlerHook&&z.hooks.preHandler){let _=await z.hooks.preHandler(Y);if(_)return _}let U=await X.handler(Y);if(z.hasPostHandlerHook&&z.hooks.postHandler)await z.hooks.postHandler(Y);if(z.hasOnSendHook&&z.hooks.onSend){let _=await z.hooks.onSend(Y,U);if(_)return _}return U??Y.json({error:!0,message:"No response from this handler",status:204},204)}function T(J,G,L={}){let z=J.headers.get("origin")??"*",X=L?.origin,Y=L?.allowedHeaders??["Content-Type","Authorization"],U=L?.methods??["GET","POST","PUT","DELETE","OPTIONS"],_=L?.credentials??!1,$=L?.exposedHeaders??[];if(G.setHeader("Access-Control-Allow-Methods",U),G.setHeader("Access-Control-Allow-Headers",Y),G.setHeader("Access-Control-Allow-Credentials",_),$.length)G.setHeader("Access-Control-Expose-Headers",$);if(X==="*"||z==="*")G.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(X))if(z&&X.includes(z))G.setHeader("Access-Control-Allow-Origin",z);else if(X.includes("*"))G.setHeader("Access-Control-Allow-Origin","*");else return G.json({message:"CORS not allowed"},403);else if(typeof X==="string")if(z===X)G.setHeader("Access-Control-Allow-Origin",z);else return G.json({message:"CORS not allowed"},403);else return G.json({message:"CORS not allowed"},403);if(G.setHeader("Access-Control-Allow-Origin",z),J.method==="OPTIONS")return G.setHeader("Access-Control-Max-Age","86400"),G.text("",204);return null}class j{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=null,this.hasFilterEnabled=!1,this.serverInstance=null}filter(){return this.hasFilterEnabled=!0,{routeMatcher:(...J)=>{return this.FilterRoutes=J,this.filter()},permitAll:()=>{for(let J of this?.FilterRoutes)this.filters.add(J);return this.FilterRoutes=null,this.filter()},require:(J)=>{if(J)this.filterFunction=J}}}cors(J){return this.corsConfig=J,this}addHooks(J,G){if(typeof J!=="string")throw new Error("hookName must be a string");if(typeof G!=="function")throw new Error("callback must be a instance of function");switch(J){case"onRequest":this.hooks.onRequest=G,this.hasOnReqHook=!0;break;case"preHandler":this.hooks.preHandler=G,this.hasPreHandlerHook=!0;break;case"postHandler":this.hooks.postHandler=G,this.hasPostHandlerHook=!0;break;case"onSend":this.hooks.onSend=G,this.hasOnSendHook=!0;break;case"onError":this.hooks.onError=G,this.hasOnError=!0;break;case"onClose":this.hooks.onClose=G;break;default:throw new Error(`Unknown hook type: ${J}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[J,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0;if(this.hooks.onError)this.hasOnError=!0;this.tempRoutes=new Map}listen(J=3000,...G){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(!J||typeof J!=="number")throw new Error("port is required and should be a number type");let L="0.0.0.0",z=void 0,X={};for(let U of G)if(typeof U==="string")L=U;else if(typeof U==="function")z=U;else if(typeof U==="object"&&U!==null)X=U;let Y={port:J,hostname:L,fetch:async(U,_)=>{let $=new URL(U.url);try{return await B(U,_,$,this)}catch(K){if(this.hasOnError&&this.hooks.onError){let W=await this.hooks.onError(K,U,$,_);if(W)return W}return new Response(JSON.stringify({message:"Internal Server Error",error:K.message,staus:500}),{status:500})}}};if(X.sslCert&&X.sslKey)Y.certFile=X.sslCert,Y.keyFile=X.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(Y),z)return z();if(X.sslCert&&X.sslKey)console.log(`HTTPS server is running on https://localhost:${J}`);else console.log(`HTTP server is running on http://localhost:${J}`);return this.serverInstance}close(){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,console.log("Server has been stopped.");else console.warn("Server is not running.")}route(J,G){if(!J||typeof J!=="string")throw new Error("Path must be a string");let L=Object.fromEntries(G.tempRoutes);return Object.entries(L).forEach(([X,Y])=>{let U=`${J}${X}`;if(!this.middlewares.has(U))this.middlewares.set(U,[]);Y.handlers.slice(0,-1).forEach((W)=>{if(!this.middlewares.get(U)?.includes(W))this.middlewares.get(U)?.push(W)});let $=Y.handlers[Y.handlers.length-1],K=Y.method;try{this.trie.insert(U,{handler:$,method:K})}catch(W){console.error(`Error inserting ${U}:`,W)}}),G=null,this}register(J,G){return this.route(J,G)}addRoute(J,G,L){if(typeof G!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof G}`);if(typeof J!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof J}`);this.tempRoutes.set(G,{method:J,handlers:L});let z=L.slice(0,-1),X=L[L.length-1];if(!this.middlewares.has(G))this.middlewares.set(G,[]);z.forEach((Y)=>{if(G==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...z])];else if(!this.middlewares.get(G)?.includes(Y))this.middlewares.get(G)?.push(Y)});try{this.trie.insert(G,{handler:X,method:J})}catch(Y){console.error(`Error inserting ${G}:`,Y)}}use(J,G){if(Array.isArray(J))J.forEach((z)=>{if(typeof z==="function")this.globalMiddlewares.push(z)});if(typeof J==="function"){if(this.globalMiddlewares.push(J),Array.isArray(G))G.forEach((z)=>{this.globalMiddlewares.push(z)});return}return(Array.isArray(J)?J.filter((z)=>typeof z==="string"):[J].filter((z)=>typeof z==="string")).forEach((z)=>{if(!this.middlewares.has(z))this.middlewares.set(z,[]);if(G)(Array.isArray(G)?G:[G]).forEach((Y)=>{this.middlewares.get(z)?.push(Y)})}),this}get(J,...G){return this.addRoute("GET",J,G),this}post(J,...G){return this.addRoute("POST",J,G),this}put(J,...G){return this.addRoute("PUT",J,G),this}patch(J,...G){return this.addRoute("PATCH",J,G),this}delete(J,...G){return this.addRoute("DELETE",J,G),this}options(J,...G){return this.addRoute("OPTIONS",J,G),this}}export{j as default};
