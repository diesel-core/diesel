class F{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class _{root;constructor(){this.root=new F}insert(z,A){let J=this.root,G=z.split("/").filter(Boolean);if(z==="/"){J.isEndOfWord=!0,J.handler.push(A.handler),J.path=z,J.method.push(A.method);return}for(let Y of G){let X=!1,L=Y;if(Y.startsWith(":"))X=!0,L=":";if(!J.children[L])J.children[L]=new F;J=J.children[L],J.isDynamic=X,J.pattern=Y,J.method.push(A.method),J.handler.push(A.handler),J.path=z}J.isEndOfWord=!0,J.method.push(A.method),J.handler.push(A.handler),J.path=z}search(z,A){let J=this.root,G=z.split("/").filter(Boolean),Y=G.length;for(let V of G){let $=V;if(!J.children[$])if(J.children[":"])J=J.children[":"];else return null;else J=J.children[$]}let X=J.path.split("/").filter(Boolean);if(Y!==X.length)return null;let L=J.method.indexOf(A);if(L!==-1)return{path:J.path,handler:J.handler[L],isDynamic:J.isDynamic,pattern:J.pattern,method:J.method[L]};return{path:J.path,handler:J.handler,isDynamic:J.isDynamic,pattern:J.pattern,method:J.method[L]}}}function E(z){switch(z.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function Q(z,A,J){let G=new Headers({"Cache-Control":"no-cache"}),Y=null,X=null,L=null,V=null,$={};return{req:z,server:A,url:J,setHeader(K,Z){return G.set(K,Z),this},removeHeader(K){return G.delete(K),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!Y)try{Y=Object.fromEntries(this.url.searchParams)}catch(K){throw new Error("Failed to parse query parameters")}return Y},get params(){if(!X&&this.req.routePattern)try{X=M(this.req.routePattern,this.url.pathname)}catch(K){throw new Error("Failed to extract route parameters")}return X??{}},get body(){if(!V)V=(async()=>{let K=await T(this.req);if(K.error)throw new Error(K.error);return Object.keys(K).length===0?null:K})();return V},set(K,Z){return $[K]=Z,this},get(K){return $[K]},text(K,Z=200){if(!G.has("Content-Type"))G.set("Content-Type","text/plain; charset=utf-8");return new Response(K,{status:Z,headers:G})},send(K,Z=200){let U=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),W=K instanceof Uint8Array?"Uint8Array":K instanceof ArrayBuffer?"ArrayBuffer":typeof K;if(!G.has("Content-Type"))G.set("Content-Type",U.get(W)??"text/plain; charset=utf-8");let D=W==="object"&&K!==null?JSON.stringify(K):K;return new Response(D,{status:Z,headers:G})},json(K,Z=200){if(!G.has("Content-Type"))G.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(K),{status:Z,headers:G})},file(K,Z=200,U){let W=Bun.file(K);if(!G.has("Content-Type"))G.set("Content-Type",U??E(K));return new Response(W,{status:Z,headers:G})},redirect(K,Z=302){return G.set("Location",K),new Response(null,{status:Z,headers:G})},setCookie(K,Z,U={}){let W=`${encodeURIComponent(K)}=${encodeURIComponent(Z)}`;if(U.maxAge)W+=`; Max-Age=${U.maxAge}`;if(U.expires)W+=`; Expires=${U.expires.toUTCString()}`;if(U.path)W+=`; Path=${U.path}`;if(U.domain)W+=`; Domain=${U.domain}`;if(U.secure)W+="; Secure";if(U.httpOnly)W+="; HttpOnly";if(U.sameSite)W+=`; SameSite=${U.sameSite}`;return G.append("Set-Cookie",W),this},get cookies(){if(!L){let K=this.req.headers.get("cookie");L=K?C(K):{}}return L}}}function C(z){return Object.fromEntries(z.split(";").map((A)=>{let[J,...G]=A.trim().split("=");return[J,decodeURIComponent(G.join("="))]}))}function M(z,A){let J={},G=z.split("/"),[Y]=A.split("?"),X=Y.split("/");if(G.length!==X.length)return null;for(let L=0;L<G.length;L++)if(G[L].startsWith(":"))J[G[L].slice(1)]=X[L];return J}async function T(z){let A=z.headers.get("Content-Type");if(!A)return{};if(z.headers.get("Content-Length")==="0"||!z.body)return{};try{if(A.startsWith("application/json"))return await z.json();if(A.startsWith("application/x-www-form-urlencoded")){let G=await z.text();return Object.fromEntries(new URLSearchParams(G))}if(A.startsWith("multipart/form-data")){let G=await z.formData(),Y={};for(let[X,L]of G.entries())Y[X]=L;return Y}return{error:"Unknown request body type"}}catch(G){return{error:"Invalid request body format"}}}async function B(z,A,J,G){let Y=G.trie.search(J.pathname,z.method);z.routePattern=Y?.path;let X=Q(z,A,J);if(G.hasFilterEnabled){let $=z.routePattern??J.pathname,K=await w(G,$,X,A);if(K)return K}if(G.hasMiddleware){let $=G.globalMiddlewares;for(let Z=0;Z<$.length;Z++){let U=await $[Z](X,A);if(U)return U}let K=G.middlewares.get(J.pathname)||[];for(let Z=0;Z<K.length;Z++){let U=await K[Z](X,A);if(U)return U}}if(!Y?.handler||Y.method!==z.method){let $=G.trie.search("*",z.method);if($){let K=await I(G,J.pathname,X);if(K)return K;return await $.handler(X)}if(G.hooks.routeNotFound){let K=await G.hooks.routeNotFound(X);if(K)return K}if(!Y||!Y.handler.length)return j(404,`Route not found for ${J.pathname}`);return j(405,"Method not allowed")}if(G.hooks.preHandler){let $=await G.hooks.preHandler(X);if($)return $}let L=Y.handler(X),V=L instanceof Promise?await L:L;if(G.hooks.postHandler)await G.hooks.postHandler(X);if(G.hooks.onSend){let $=await G.hooks.onSend(X,V);if($)return $}return V??j(204,"No response from this handler")}async function w(z,A,J,G){if(!z.filters.has(A))if(z.filterFunction.length)for(let Y of z.filterFunction){let X=await Y(J,G);if(X)return X}else return J.json({error:!0,message:"Protected route, authentication required",status:401},401)}function j(z,A){return new Response(JSON.stringify({error:!0,message:A,status:z}),{status:z,headers:{"Content-Type":"application/json"}})}async function I(z,A,J){if(!z.UseStaticFiles)throw new Error("Static files directory is not configured.");let G=`${z.UseStaticFiles}${A}`;if(/\.(js|css|html)$/.test(A)){let Y=E(G);return J.file(G,200,Y)}return null}class N{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;UseStaticFiles;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new _,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null,routeNotFound:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.UseStaticFiles=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...z)=>{return this.FilterRoutes=z,this.setupFilter()},permitAll:()=>{for(let z of this?.FilterRoutes)this.filters.add(z);return this.FilterRoutes=null,this.setupFilter()},authenticate:(z)=>{if(z?.length)for(let A of z)this.filterFunction.push(A)}}}UseStatic(z){this.UseStaticFiles=z}static(z,A){if(!Array.isArray(z)&&!Array.isArray(A))this.staticFiles[z]=A;else for(let J=0;J<z.length;J++)this.staticFiles[z[J]]=A[J];return this}addHooks(z,A){if(typeof z!=="string")throw new Error("hookName must be a string");if(typeof A!=="function")throw new Error("callback must be a instance of function");switch(z){case"onRequest":this.hooks.onRequest=A;break;case"preHandler":this.hooks.preHandler=A;break;case"postHandler":this.hooks.postHandler=A;break;case"onSend":this.hooks.onSend=A;break;case"onError":this.hooks.onError=A;break;case"onClose":this.hooks.onClose=A;break;case"routeNotFound":this.hooks.routeNotFound=A;break;default:throw new Error(`Unknown hook type: ${z}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[z,A]of this.middlewares.entries())if(A.length>0){this.hasMiddleware=!0;break}this.tempRoutes=new Map}listen(z=3000,...A){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(!z||typeof z!=="number")throw new Error("port is required and should be a number type");let J="0.0.0.0",G=void 0,Y={};for(let L of A)if(typeof L==="string")J=L;else if(typeof L==="function")G=L;else if(typeof L==="object"&&L!==null)Y=L;let X={port:z,hostname:J,fetch:async(L,V)=>{let $=new URL(L.url);try{if(this.hooks.onRequest)this.hooks.onRequest(L,$,V);return await B(L,V,$,this)}catch(K){return this.hooks.onError?this.hooks.onError(K,L,$,V):new Response(JSON.stringify({message:"Internal Server Error",error:K.message,status:500}),{status:500})}},static:this.staticFiles,development:!0};if(Y.sslCert&&Y.sslKey)X.certFile=Y.sslCert,X.keyFile=Y.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(X),G)return G();if(Y.sslCert&&Y.sslKey)console.log(`HTTPS server is running on https://localhost:${z}`);else console.log(`HTTP server is running on http://localhost:${z}`);return this.serverInstance}close(z){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,z?z():console.log("Server has been stopped");else console.warn("Server is not running.")}route(z,A){if(!z||typeof z!=="string")throw new Error("Path must be a string");let J=Object.fromEntries(A.tempRoutes);return Object.entries(J).forEach(([Y,X])=>{let L=`${z}${Y}`;if(!this.middlewares.has(L))this.middlewares.set(L,[]);X.handlers.slice(0,-1).forEach((Z)=>{if(!this.middlewares.get(L)?.includes(Z))this.middlewares.get(L)?.push(Z)});let $=X.handlers[X.handlers.length-1],K=X.method;try{this.trie.insert(L,{handler:$,method:K})}catch(Z){console.error(`Error inserting ${L}:`,Z)}}),A=null,this}register(z,A){return this.route(z,A)}addRoute(z,A,J){if(typeof A!=="string")throw new Error(`Error in ${J[J.length-1]}: Path must be a string. Received: ${typeof A}`);if(typeof z!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof z}`);this.tempRoutes.set(A,{method:z,handlers:J});let G=J.slice(0,-1),Y=J[J.length-1];if(!this.middlewares.has(A))this.middlewares.set(A,[]);G.forEach((X)=>{if(A==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...G])];else if(!this.middlewares.get(A)?.includes(X))this.middlewares.get(A)?.push(X)});try{if(z==="ANY"){let X=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let L of X)this.trie.insert(A,{handler:Y,method:L})}this.trie.insert(A,{handler:Y,method:z})}catch(X){console.error(`Error inserting ${A}:`,X)}}use(z,A){if(Array.isArray(z))z.forEach((G)=>{if(typeof G==="function")this.globalMiddlewares.push(G)});if(typeof z==="function"){if(this.globalMiddlewares.push(z),Array.isArray(A))A.forEach((G)=>{this.globalMiddlewares.push(G)});return}return(Array.isArray(z)?z.filter((G)=>typeof G==="string"):[z].filter((G)=>typeof G==="string")).forEach((G)=>{if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(A)(Array.isArray(A)?A:[A]).forEach((X)=>{this.middlewares.get(G)?.push(X)})}),this}get(z,...A){return this.addRoute("GET",z,A),this}post(z,...A){return this.addRoute("POST",z,A),this}put(z,...A){return this.addRoute("PUT",z,A),this}patch(z,...A){return this.addRoute("PATCH",z,A),this}delete(z,...A){return this.addRoute("DELETE",z,A),this}any(z,...A){return this.addRoute("ANY",z,A),this}head(z,...A){return this.addRoute("HEAD",z,A),this}options(z,...A){return this.addRoute("OPTIONS",z,A),this}propfind(z,...A){return this.addRoute("PROPFIND",z,A),this}}export{N as default};
