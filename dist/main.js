var h=Object.create;var{getPrototypeOf:t,defineProperty:o,getOwnPropertyNames:s}=Object;var r=Object.prototype.hasOwnProperty;var l=(g,C,v)=>{v=g!=null?h(t(g)):{};let A=C||!g||!g.__esModule?o(v,"default",{value:g,enumerable:!0}):v;for(let b of s(g))if(!r.call(A,b))o(A,b,{get:()=>g[b],enumerable:!0});return A};var d=((g)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(g,{get:(C,v)=>(typeof require!=="undefined"?require:C)[v]}):g)(function(g){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+g+'" is not supported')});class T{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class F{root;constructor(){this.root=new T}insert(g,C){let v=this.root,A=g.split("/").filter(Boolean);if(g==="/"){v.isEndOfWord=!0,v.handler.push(C.handler),v.path=g,v.method.push(C.method);return}for(let b of A){let z=!1,$=b;if(b.startsWith(":"))z=!0,$=":";if(!v.children[$])v.children[$]=new T;v=v.children[$],v.isDynamic=z,v.pattern=b}v.isEndOfWord=!0,v.path=g,v.method.push(C.method),v.handler.push(C.handler)}search(g,C){let v=this.root,A=g.split("/").filter(Boolean),b=A.length;for(let f of A){let L=f;if(!v.children[L])if(v.children[":"])v=v.children[":"];else return null;else v=v.children[L]}let z=v.path.split("/").filter(Boolean);if(b!==z.length)return null;let $=v.method.indexOf(C);if($!==-1)return{path:v.path,handler:v.handler[$],isDynamic:v.isDynamic,pattern:v.pattern,method:v.method[$]};return{path:v.path,handler:v.handler,isDynamic:v.isDynamic,pattern:v.pattern,method:v.method[$]}}}function J(g){switch(g.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function _(g,C,v){let A=null,b=null,z=null,$=null,f={};return{req:g,server:C,url:v,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(L,E){return this.headers.set(L,E),this},removeHeader(L){return this.headers.delete(L),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!A)try{A=Object.fromEntries(this.url.searchParams)}catch(L){throw new Error("Failed to parse query parameters")}return A},get params(){if(!b&&this.req.routePattern)try{b=e(this.req.routePattern,this.url.pathname)}catch(L){throw new Error("Failed to extract route parameters")}return b??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!$)$=(async()=>{let L=await g1(this.req);if(L.error)throw new Error(L.error);return Object.keys(L).length===0?null:L})();return $},set(L,E){return f[L]=E,this},get(L){return f[L]},text(L,E){if(E)this.status=E;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(L,{status:this.status,headers:this.headers})},send(L,E){if(E)this.status=E;let N=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),m;if(L instanceof Uint8Array)m="Uint8Array";else if(L instanceof ArrayBuffer)m="ArrayBuffer";else m=typeof L;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",N.get(m)??"text/plain; charset=utf-8");let O=m==="object"&&L!==null?JSON.stringify(L):L;return new Response(O,{status:this.status,headers:this.headers})},json(L,E){if(E)this.status=E;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(L,{status:this.status,headers:this.headers})},file(L,E,N){if(N)this.status=N;let m=Bun.file(L);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",E??J(L));return new Response(m,{status:this.status,headers:this.headers})},async ejs(L,E={},N){if(N)this.status=N;let m;try{m=await import("ejs"),m=m.default||m}catch(O){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let O=await Bun.file(L).text(),U=m.render(O,E),K=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(U,{status:this.status,headers:K})}catch(O){return console.error("EJS Rendering Error:",O),new Response("Error rendering template",{status:500})}},redirect(L,E){if(E)this.status=E;else this.status=302;return this.headers.set("Location",L),new Response(null,{status:this.status,headers:this.headers})},stream(L){let E=new Headers(this.headers),N=new ReadableStream({async start(m){await L(m),m.close()}});return new Response(N,{headers:E})},yieldStream(L){return new Response({async*[Symbol.asyncIterator](){yield*L()}},{headers:this.headers})},setCookie(L,E,N={}){let m=`${encodeURIComponent(L)}=${encodeURIComponent(E)}`;if(N.maxAge)m+=`; Max-Age=${N.maxAge}`;if(N.expires)m+=`; Expires=${N.expires.toUTCString()}`;if(N.path)m+=`; Path=${N.path}`;if(N.domain)m+=`; Domain=${N.domain}`;if(N.secure)m+="; Secure";if(N.httpOnly)m+="; HttpOnly";if(N.sameSite)m+=`; SameSite=${N.sameSite}`;return this.headers.append("Set-Cookie",m),this},get cookies(){if(!z){let L=this.req.headers.get("cookie");z=L?a(L):{}}return z}}}function a(g){return Object.fromEntries(g.split(";").map((C)=>{let[v,...A]=C.trim().split("=");return[v,decodeURIComponent(A.join("="))]}))}function e(g,C){let v={},A=g.split("/"),[b]=C.split("?"),z=b.split("/");if(A.length!==z.length)return null;for(let $=0;$<A.length;$++)if(A[$].startsWith(":"))v[A[$].slice(1)]=z[$];return v}async function g1(g){let C=g.headers.get("Content-Type");if(!C)return{};if(g.headers.get("Content-Length")==="0"||!g.body)return{};try{if(C.startsWith("application/json"))return await g.json();if(C.startsWith("application/x-www-form-urlencoded")){let A=await g.text();return Object.fromEntries(new URLSearchParams(A))}if(C.startsWith("multipart/form-data")){let A=await g.formData(),b={};for(let[z,$]of A.entries())b[z]=$;return b}return{error:"Unknown request body type"}}catch(A){return{error:"Invalid request body format"}}}async function B(g,C,v,A){let b=_(g,C,v),z=A.trie.search(v.pathname,g.method);g.routePattern=z?.path;try{if(A.hasFilterEnabled){let L=g.routePattern??v.pathname,E=await $1(A,L,b,C),N=E instanceof Promise?await E:E;if(N)return N}if(A.hasMiddleware){if(A.globalMiddlewares.length){let E=await n(A.globalMiddlewares,b,C);if(E)return E}let L=A.middlewares.get(v.pathname)||[];if(L?.length){let E=await n(L,b,C);if(E)return E}}if(!z?.handler||z.method!==g.method){if(A.staticPath){let L=await L1(A,v.pathname,b);if(L)return L;let E=A.trie.search("*",g.method);if(E?.handler)return await E.handler(b)}if(A.hooks.routeNotFound&&Array.isArray(A.hooks.routeNotFound)&&!z?.handler){let L=A.hooks.routeNotFound;for(let E=0;E<L.length;E++){let N=L[E](b),m=N instanceof Promise?await N:N;if(m)return m}}if(!z||!z?.handler?.length)return Q(404,`Route not found for ${v.pathname}`);if(z?.method!==g.method)return Q(405,"Method not allowed")}if(A.hooks.preHandler?.length&&Array.isArray(A.hooks.preHandler)){let L=A.hooks.preHandler;for(let E=0;E<L.length;E++){let N=L[E](b),m=N instanceof Promise?await N:N;if(m)return m}}let $=z.handler(b);return($ instanceof Promise?await $:$)??Q(204,"")}catch($){if(A.hooks.onError&&Array.isArray(A.hooks.onError)){let f=A.hooks.onError;for(let L=0;L<f.length;L++){let E=A.hooks.onError[L]($,g,v,C),N=E instanceof Promise?await E:E;if(N)return N}}return Q(500,"Internal Server Error")}finally{if(A.hooks.onSend&&Array.isArray(A.hooks.onSend)){let $=A.hooks.onSend;for(let f=0;f<$.length;f++){let L=$[f](b),E=L instanceof Promise?await L:L;if(E)return E}}}}async function n(g,C,v){for(let A of g){let b=await A(C,v);if(b)return b}return null}async function V(g,C,v){for(let A of g){let b=await A(C,v);if(b)return b}}async function $1(g,C,v,A){if(!g.filters.has(C))if(g.filterFunction.length)for(let b of g.filterFunction){let z=await b(v,A);if(z)return z}else return Response.json({error:!0,message:"Protected route, authentication required",status:401},{status:401})}async function V1(g,C,v,A){if(!g.filters.has(C))if(g.filterFunction.length)for(let b of g.filterFunction){let z=await b(v,A);if(z)return z}else return Response.json({error:!0,message:"Protected route, authentication required",status:401},{status:401})}function Q(g,C){return new Response(JSON.stringify({error:!0,message:C,status:g}),{status:g,headers:{"Content-Type":"application/json"}})}async function L1(g,C,v){if(!g.staticPath)return null;let A=`${g.staticPath}${C}`;if(await Bun.file(A).exists()){let z=J(A);return v.file(A,z,200)}return null}var{create:C1,defineProperty:w,getOwnPropertyDescriptor:v1,getOwnPropertyNames:A1,getPrototypeOf:f1}=Object,E1=Object.prototype.hasOwnProperty,b1=(g,C)=>()=>(C||g((C={exports:{}}).exports,C),C.exports),m1=(g,C,v,A)=>{if(C&&typeof C=="object"||typeof C=="function")for(let b of A1(C))!E1.call(g,b)&&b!==v&&w(g,b,{get:()=>C[b],enumerable:!(A=v1(C,b))||A.enumerable});return g},z1=(g,C,v)=>(v=g!=null?C1(f1(g)):{},m1(C||!g||!g.__esModule?w(v,"default",{value:g,enumerable:!0}):v,g)),N1=b1((g,C)=>{function v($){if(typeof $!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify($))}function A($,f){for(var L="",E=0,N=-1,m=0,O,U=0;U<=$.length;++U){if(U<$.length)O=$.charCodeAt(U);else{if(O===47)break;O=47}if(O===47){if(!(N===U-1||m===1))if(N!==U-1&&m===2){if(L.length<2||E!==2||L.charCodeAt(L.length-1)!==46||L.charCodeAt(L.length-2)!==46){if(L.length>2){var K=L.lastIndexOf("/");if(K!==L.length-1){K===-1?(L="",E=0):(L=L.slice(0,K),E=L.length-1-L.lastIndexOf("/")),N=U,m=0;continue}}else if(L.length===2||L.length===1){L="",E=0,N=U,m=0;continue}}f&&(L.length>0?L+="/..":L="..",E=2)}else L.length>0?L+="/"+$.slice(N+1,U):L=$.slice(N+1,U),E=U-N-1;N=U,m=0}else O===46&&m!==-1?++m:m=-1}return L}function b($,f){var L=f.dir||f.root,E=f.base||(f.name||"")+(f.ext||"");return L?L===f.root?L+E:L+$+E:E}var z={resolve:function(){for(var $="",f=!1,L,E=arguments.length-1;E>=-1&&!f;E--){var N;E>=0?N=arguments[E]:(L===void 0&&(L=process.cwd()),N=L),v(N),N.length!==0&&($=N+"/"+$,f=N.charCodeAt(0)===47)}return $=A($,!f),f?$.length>0?"/"+$:"/":$.length>0?$:"."},normalize:function($){if(v($),$.length===0)return".";var f=$.charCodeAt(0)===47,L=$.charCodeAt($.length-1)===47;return $=A($,!f),$.length===0&&!f&&($="."),$.length>0&&L&&($+="/"),f?"/"+$:$},isAbsolute:function($){return v($),$.length>0&&$.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var $,f=0;f<arguments.length;++f){var L=arguments[f];v(L),L.length>0&&($===void 0?$=L:$+="/"+L)}return $===void 0?".":z.normalize($)},relative:function($,f){if(v($),v(f),$===f||($=z.resolve($),f=z.resolve(f),$===f))return"";for(var L=1;L<$.length&&$.charCodeAt(L)===47;++L);for(var E=$.length,N=E-L,m=1;m<f.length&&f.charCodeAt(m)===47;++m);for(var O=f.length,U=O-m,K=N<U?N:U,X=-1,D=0;D<=K;++D){if(D===K){if(U>K){if(f.charCodeAt(m+D)===47)return f.slice(m+D+1);if(D===0)return f.slice(m+D)}else N>K&&($.charCodeAt(L+D)===47?X=D:D===0&&(X=0));break}var x=$.charCodeAt(L+D),p=f.charCodeAt(m+D);if(x!==p)break;x===47&&(X=D)}var Z="";for(D=L+X+1;D<=E;++D)(D===E||$.charCodeAt(D)===47)&&(Z.length===0?Z+="..":Z+="/..");return Z.length>0?Z+f.slice(m+X):(m+=X,f.charCodeAt(m)===47&&++m,f.slice(m))},_makeLong:function($){return $},dirname:function($){if(v($),$.length===0)return".";for(var f=$.charCodeAt(0),L=f===47,E=-1,N=!0,m=$.length-1;m>=1;--m)if(f=$.charCodeAt(m),f===47){if(!N){E=m;break}}else N=!1;return E===-1?L?"/":".":L&&E===1?"//":$.slice(0,E)},basename:function($,f){if(f!==void 0&&typeof f!="string")throw new TypeError('"ext" argument must be a string');v($);var L=0,E=-1,N=!0,m;if(f!==void 0&&f.length>0&&f.length<=$.length){if(f.length===$.length&&f===$)return"";var O=f.length-1,U=-1;for(m=$.length-1;m>=0;--m){var K=$.charCodeAt(m);if(K===47){if(!N){L=m+1;break}}else U===-1&&(N=!1,U=m+1),O>=0&&(K===f.charCodeAt(O)?--O===-1&&(E=m):(O=-1,E=U))}return L===E?E=U:E===-1&&(E=$.length),$.slice(L,E)}else{for(m=$.length-1;m>=0;--m)if($.charCodeAt(m)===47){if(!N){L=m+1;break}}else E===-1&&(N=!1,E=m+1);return E===-1?"":$.slice(L,E)}},extname:function($){v($);for(var f=-1,L=0,E=-1,N=!0,m=0,O=$.length-1;O>=0;--O){var U=$.charCodeAt(O);if(U===47){if(!N){L=O+1;break}continue}E===-1&&(N=!1,E=O+1),U===46?f===-1?f=O:m!==1&&(m=1):f!==-1&&(m=-1)}return f===-1||E===-1||m===0||m===1&&f===E-1&&f===L+1?"":$.slice(f,E)},format:function($){if($===null||typeof $!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof $);return b("/",$)},parse:function($){v($);var f={root:"",dir:"",base:"",ext:"",name:""};if($.length===0)return f;var L=$.charCodeAt(0),E=L===47,N;E?(f.root="/",N=1):N=0;for(var m=-1,O=0,U=-1,K=!0,X=$.length-1,D=0;X>=N;--X){if(L=$.charCodeAt(X),L===47){if(!K){O=X+1;break}continue}U===-1&&(K=!1,U=X+1),L===46?m===-1?m=X:D!==1&&(D=1):m!==-1&&(D=-1)}return m===-1||U===-1||D===0||D===1&&m===U-1&&m===O+1?U!==-1&&(O===0&&E?f.base=f.name=$.slice(1,U):f.base=f.name=$.slice(O,U)):(O===0&&E?(f.name=$.slice(1,m),f.base=$.slice(1,U)):(f.name=$.slice(O,m),f.base=$.slice(O,U)),f.ext=$.slice(m,U)),O>0?f.dir=$.slice(0,O-1):E&&(f.dir="/"),f},sep:"/",delimiter:":",win32:null,posix:null};z.posix=z,C.exports=z}),M=z1(N1()),G=M,O1=M,c=function(g){return g},P=function(){throw new Error("Not implemented")};G.parse??=P;O1.parse??=P;var Y={resolve:G.resolve.bind(G),normalize:G.normalize.bind(G),isAbsolute:G.isAbsolute.bind(G),join:G.join.bind(G),relative:G.relative.bind(G),toNamespacedPath:c,dirname:G.dirname.bind(G),basename:G.basename.bind(G),extname:G.extname.bind(G),format:G.format.bind(G),parse:G.parse.bind(G),sep:"/",delimiter:":",win32:void 0,posix:void 0,_makeLong:c},H={sep:"\\",delimiter:";",win32:void 0,...Y,posix:Y};Y.win32=H.win32=H;Y.posix=Y;var W=Y;var{default:y}=(()=>({}));var I={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},S=(g,C,v)=>{let A=I[g]||I.reset,b=v?.method?I.method[v.method]||I.reset:I.reset,z=v?.status?v.status>=500?I.error:v.status>=400?I.warn:I.info:I.reset;console.log(`
${A}[${g.toUpperCase()}]${I.reset} ${C} - ${b}${v?.method||""}${I.reset}`);let $={timestamp:new Date().toISOString(),...v,status:v?.status?`${z}${v.status}${I.reset}`:void 0,method:v?.method?`${b>A}${v.method}${I.reset}`:void 0};console.log(JSON.stringify($,null,2)+`
`)},R=(g)=>{let{app:C,logger:v,logLevel:A="info",onRequest:b,onSend:z,onError:$,routeNotFound:f}=g||{};C?.addHooks("onRequest",(L,E)=>{L.startTime=Date.now(),v?.()??S(A,"Incoming Request",{method:L.method,url:E.toString(),headers:{"user-agent":L.headers.get("user-agent"),"content-type":L.headers.get("content-type")}}),b?.(L,E)}),C?.addHooks("onSend",async(L)=>{let E=`${Date.now()-L.req.startTime}ms`;v?.()??S(A,"Response Sent",{method:L.req.method,url:L.url.toString(),status:L.status,duration:E,reqId:L.get?.("requestId"),headers:{"content-type":L.headers.get("content-type")}});let N=await z?.(L);if(N instanceof Response)return N}),C?.addHooks("routeNotFound",async(L)=>{v?.()&&v();let E=await f?.(L);if(E instanceof Response)return E}),C?.addHooks("onError",async(L,E,N)=>{v?.()??S("error","Unhandled Error",{method:E.method,url:N.toString(),status:500,error:L.message});let m=await $?.(L,E,N);if(m instanceof Response)return m})},j=(g,C,v,A=0,b,z)=>{let $=I.method[C]||I.reset,f=A>=500?I.error:A>=400?I.warn:I.info,L=z?`[${z}] `:"",E=g==="<--"?`${g} ${$}${C}${I.reset} ${v} ${L}`:`${g} ${$}${C}${I.reset} ${v} ${f}${A}${I.reset} ${b??""} ${L}`;console.log(E)},U1=(g)=>{let C=Date.now()-g;return C<1000?`${C}ms`:`${Math.round(C/1000)}s`},q=(g)=>{let{app:C,log:v,onRequest:A,onSend:b,onError:z,routeNotFound:$}=g;C.addHooks("onRequest",(f,L)=>{f.startTime=Date.now(),v?.()??j("<--",f.method,L.pathname),A?.(f,L)}),C.addHooks("onSend",async(f)=>{let{method:L,url:E}=f.req,N=new URL(E).pathname,m=f.get?.("requestId");v?.()??j("-->",L,N,f.status,U1(f.req.startTime),m);let O=await b?.(f);if(O instanceof Response)return O}),C.addHooks("routeNotFound",async(f)=>{v?.()&&v();let L=await $?.(f);if(L instanceof Response)return L}),C.addHooks("onError",async(f,L,E)=>{v?.()??j(f.message,L.method,E.toString(),500);let N=await z?.(f,L,E);if(N instanceof Response)return N})};function k(g,C){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(v)=>{try{let A=v.cookies?.accessToken??v.req?.headers?.get("Authorization");if(!A)return v.json({message:"Unauthorized",error:"No token provided"},401);if(A.startsWith("Bearer "))A=A.slice(7);let b=g?.verify(A,C);if(!b)return v.json({message:"Unauthorized",error:"Token could not be decoded"},401);v.set("user",b)}catch(A){let b="Invalid token";if(A.name==="TokenExpiredError")b="Token expired";else if(A.name==="JsonWebTokenError")b="Malformed or tampered token";return v.json({message:"Unauthorized",error:b},401)}}}function u(g,C,v){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!C)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(A)=>{try{let b=A.cookies?.accessToken??A.req?.headers?.get("Authorization");if(!b)return A.json({message:"Unauthorized",error:"No token provided"},401);if(b.startsWith("Bearer "))b=b.slice(7);let z=g?.verify(b,v);if(!z)return A.json({message:"Unauthorized",error:"Token could not be decoded"},401);let $=await C.findById(z._id).select("-password -refreshToken");if(!$)return A.json({message:"Unauthorized: User not found"},404);A.set("user",$);return}catch(b){let z="Invalid token";if(b.name==="TokenExpiredError")z="Token expired";else if(b.name==="JsonWebTokenError")z="Malformed or tampered token";return A.json({message:"Unauthorized",error:z},401)}}}class i{routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;constructor({jwtSecret:g,baseApiUrl:C,enableFileRouting:v,idleTimeOut:A}={}){this.routes={},this.idleTimeOut=A??10,this.enableFileRouter=v??!1,this.baseApiUrl=C||"",this.user_jwt_secret=g||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new F,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[],routeNotFound:[]},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...g)=>{return this.FilterRoutes=g,this.setupFilter()},permitAll:()=>{for(let g of this?.FilterRoutes)this.filters.add(g);return this.FilterRoutes=null,this.setupFilter()},authenticate:(g)=>{if(g?.length)for(let C of g)this.filterFunction.push(C)},authenticateJwt:(g)=>{this.filterFunction.push(k(g,this.user_jwt_secret))},authenticateJwtDB:(g,C)=>{this.filterFunction.push(u(g,C,this.user_jwt_secret))}}}redirect(g,C,v){return this.any(g,(A)=>{let b=A.params,z=C;if(b)for(let f in b)z=z.replace(`:${f}`,b[f]);let $=A.url.search;if($)z+=$;return A.redirect(z,v)}),this}serveStatic(g){return this.staticPath=g,this}staticHtml(g){return this.staticFiles={...this.staticFiles,...g},this}addHooks(g,C){if(typeof g!=="string")throw new Error("hookName must be a string");if(typeof C!=="function")throw new Error("callback must be a instance of function");switch(g){case"onRequest":this.hooks.onRequest?.push(C);break;case"preHandler":this.hooks.preHandler?.push(C);break;case"postHandler":this.hooks.postHandler?.push(C);break;case"onSend":this.hooks.onSend?.push(C);break;case"onError":this.hooks.onError?.push(C);break;case"onClose":this.hooks.onClose?.push(C);break;case"routeNotFound":this.hooks.routeNotFound?.push(C);break;default:throw new Error(`Unknown hook type: ${g}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[g,C]of this.middlewares.entries())if(C.length>0){this.hasMiddleware=!0;break}if(this.enableFileRouter){let g=process.cwd(),C=W.join(g,"src","routes");if(y?.existsSync(C))this.loadRoutes(C,"")}setTimeout(()=>{this.tempRoutes=null},2000)}async registerFileRoutes(g,C,v){let A=await import(g),b;if(v===".ts")b=W.basename(g,".ts");else if(v===".js")b=W.basename(g,".js");let z=C+"/"+b;if(z.endsWith("/index"))z=C;else if(z.endsWith("/api"))z=C;z=z.replace(/\[(.*?)\]/g,":$1");let $=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let f of $)if(A[f]){let L=f.toLowerCase(),E=A[f];this[L](`${this.baseApiUrl}${z}`,E)}}async loadRoutes(g,C){let v=await y.promises.readdir(g);for(let A of v){let b=W.join(g,A);if((await y.promises.stat(b)).isDirectory())this.loadRoutes(b,C+"/"+A);else if(A.endsWith(".ts"))this.registerFileRoutes(b,C,".ts");else if(A.endsWith(".js"))this.registerFileRoutes(b,C,".js")}}useLogger(g){return q(g),this}useAdvancedLogger(g){return R(g),this}BunRoute(g,C,...v){if(!C||typeof C!=="string")throw new Error("give a path in string format");if(v.length===1){let A=v[0];this.routes[C]=async(b,z)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let L=await V(this.globalMiddlewares,b,z);if(L)return L}let f=this.middlewares.get(C)||[];if(f?.length){let L=await V(f,b,z);if(L)return L}}if(g!==b.method)return new Response("Method Not Allowed",{status:405});let $=await A(b,z);if($ instanceof Promise)return await $??new Response("Not Found",{status:404});return $??new Response("Not Found",{status:404})}}else this.routes[C]=async(A,b)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let $=await V(this.globalMiddlewares,A,b);if($)return $}let z=this.middlewares.get(C)||[];if(z?.length){let $=await V(z,A,b);if($)return $}}if(g!==A.method)return new Response("Method Not Allowed",{status:405});for(let z=0;z<v.length;z++){let $=v[z](A,b);if($ instanceof Promise)return await $??new Response("Not Found",{status:404});return $??new Response("Not Found",{status:404})}}}listen(g,...C){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let v="0.0.0.0",A=void 0,b={};for(let $ of C)if(typeof $==="string")v=$;else if(typeof $==="function")A=$;else if(typeof $==="object"&&$!==null)b=$;this.compile();let z={port:g,hostname:v,idleTimeOut:this.idleTimeOut,fetch:async($,f)=>{let L=new URL($.url);if(this.hooks.onRequest){let E=this.hooks.onRequest;for(let N=0;N<E.length;N++)await E[N]($,L,f)}return B($,f,L,this)},static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)console.log(this.routes),z.routes=this.routes;if(b.cert&&b.key)z.certFile=b.cert,z.keyFile=b.key;if(this.serverInstance=Bun?.serve(z),A)return A();return this.serverInstance}close(g){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,g?g():console.log("Server has been stopped");else console.warn("Server is not running.")}route(g,C){if(!g||typeof g!=="string")throw new Error("Path must be a string");let v=Object.fromEntries(C.tempRoutes);return Object.entries(v).forEach(([b,z])=>{let $=b.replace(/::\w+$/,""),f=`${g}${$}`;if(!this.middlewares.has(f))this.middlewares.set(f,[]);z.handlers.slice(0,-1).forEach((m)=>{if(!this.middlewares.get(f)?.includes(m))this.middlewares.get(f)?.push(m)});let E=z.handlers[z.handlers.length-1],N=z.method;try{this.trie.insert(f,{handler:E,method:N})}catch(m){console.error(`Error inserting ${f}:`,m)}}),C=null,this}register(g,C){return this.route(g,C)}addRoute(g,C,v){if(typeof C!=="string")throw new Error(`Error in ${v[v.length-1]}: Path must be a string. Received: ${typeof C}`);if(typeof g!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof g}`);this.tempRoutes?.set(C+"::"+g,{method:g,handlers:v});let A=v.slice(0,-1),b=v[v.length-1];if(!this.middlewares.has(C))this.middlewares.set(C,[]);A.forEach((z)=>{if(C==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...A])];else if(!this.middlewares.get(C)?.includes(z))this.middlewares.get(C)?.push(z)});try{if(g==="ANY"){let z=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let $ of z)this.trie.insert(C,{handler:b,method:$})}this.trie.insert(C,{handler:b,method:g})}catch(z){console.error(`Error inserting ${C}:`,z)}}use(g,C){if(Array.isArray(g))g.forEach((A)=>{if(typeof A==="function")this.globalMiddlewares.push(A)});if(typeof g==="function"){if(this.globalMiddlewares.push(g),Array.isArray(C))C.forEach((A)=>{this.globalMiddlewares.push(A)});return}return(Array.isArray(g)?g.filter((A)=>typeof A==="string"):[g].filter((A)=>typeof A==="string")).forEach((A)=>{if(!this.middlewares.has(A))this.middlewares.set(A,[]);if(C)(Array.isArray(C)?C:[C]).forEach((z)=>{this.middlewares.get(A)?.push(z)})}),this}get(g,...C){return this.addRoute("GET",g,C),this}post(g,...C){return this.addRoute("POST",g,C),this}put(g,...C){return this.addRoute("PUT",g,C),this}patch(g,...C){return this.addRoute("PATCH",g,C),this}delete(g,...C){return this.addRoute("DELETE",g,C),this}any(g,...C){return this.addRoute("ANY",g,C),this}head(g,...C){return this.addRoute("HEAD",g,C),this}options(g,...C){return this.addRoute("OPTIONS",g,C),this}propfind(g,...C){return this.addRoute("PROPFIND",g,C),this}}export{i as default};
