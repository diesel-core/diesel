class Q{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class V{root;constructor(){this.root=new Q}insert(G,z){let F=this.root,J=G.split("/").filter(Boolean);if(G==="/"){F.isEndOfWord=!0,F.handler.push(z.handler),F.path=G,F.method.push(z.method);return}for(let L of J){let U=!1,Y=L;if(L.startsWith(":"))U=!0,Y=":";if(!F.children[Y])F.children[Y]=new Q;F=F.children[Y],F.isDynamic=U,F.pattern=L,F.method.push(z.method),F.handler.push(z.handler),F.path=G}F.isEndOfWord=!0,F.method.push(z.method),F.handler.push(z.handler),F.path=G}search(G,z){let F=this.root,J=G.split("/").filter(Boolean);for(let U of J){let Y=U;if(!F.children[Y])if(F.children[":"])F=F.children[":"];else return null;else F=F.children[Y]}let L=F.method.indexOf(z);if(L!==-1)return{path:F.path,handler:F.handler[L],isDynamic:F.isDynamic,pattern:F.pattern,method:F.method[L]};return{path:F.path,handler:F.handler,isDynamic:F.isDynamic,pattern:F.pattern,method:F.method[L]}}}function B(G,z,F){let J=new Headers,L={},U=!1,Y,Z=null,_,W,E=200,j={};return{req:G,server:z,url:F,getUser(){return j},setUser(X){if(X)j=X},status(X){return E=X,this},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!W)W=await I(G);if(W.error)return new Response(JSON.stringify({error:W.error}),{status:400});return W},setHeader(X,$){return J.set(X,$),this},set(X,$){return L[X]=$,this},get(X){return L[X]||null},setAuth(X){return U=X,this},getAuth(){return U},text(X,$){return new Response(X,{status:$??E,headers:J})},send(X,$){return new Response(X,{status:$??E,headers:J})},json(X,$){return new Response(JSON.stringify(X),{status:$??E,headers:J})},html(X,$){return new Response(Bun.file(X),{status:$??E,headers:J})},file(X,$){return new Response(Bun.file(X),{status:$??E,headers:J})},redirect(X,$){return J.set("Location",X),new Response(null,{status:$??302,headers:J})},setCookie(X,$,A={}){let D=`${encodeURIComponent(X)}=${encodeURIComponent($)}`;if(A.maxAge)D+=`; Max-Age=${A.maxAge}`;if(A.expires)D+=`; Expires=${A.expires.toUTCString()}`;if(A.path)D+=`; Path=${A.path}`;if(A.domain)D+=`; Domain=${A.domain}`;if(A.secure)D+="; Secure";if(A.httpOnly)D+="; HttpOnly";if(A.sameSite)D+=`; SameSite=${A.sameSite}`;return J?.append("Set-Cookie",D),this},getParams(X){if(!_&&G?.routePattern)_=N(G?.routePattern,F?.pathname);return X?_[X]||{}:_},getQuery(X){try{if(!Y)Y=Object.fromEntries(F.searchParams);return X?Y[X]||{}:Y}catch($){return{}}},getCookie(X){if(!Z){let $=G.headers.get("cookie");if($)Z=T($);else return null}if(!Z)return null;if(X)return Z[X]??null;else return Z}}}function T(G){let z={},F=G?.split(";");for(let J=0;J<F?.length;J++){let[L,...U]=F[J].trim().split("="),Y=U?.join("=").trim();if(L)z[L.trim()]=decodeURIComponent(Y)}return z}function N(G,z){let F={},J=G.split("/"),[L]=z.split("?"),U=L.split("/");if(J.length!==U.length)return null;for(let Y=0;Y<J.length;Y++)if(J[Y].startsWith(":"))F[J[Y].slice(1)]=U[Y];return F}async function I(G){let z=G.headers.get("Content-Type")||"";if(!z)return{};try{if(z.startsWith("application/json"))return await G.json();if(z.startsWith("application/x-www-form-urlencoded")){let F=await G.text();return Object.fromEntries(new URLSearchParams(F))}if(z.startsWith("multipart/form-data")){let F=await G.formData(),J={};for(let[L,U]of F.entries())J[L]=U;return J}return{error:"Unknown request body type"}}catch(F){return{error:"Invalid request body format"}}}async function K(G,z,F,J){let L=J.trie.search(F.pathname,G.method);if(!L||L.method!==G.method){let Z=L?"Method not allowed":`Route not found for ${F.pathname}`,_=L?405:404;return new Response(JSON.stringify({message:Z}),{status:_})}if(L.isDynamic)G.routePattern=L.path;let U=B(G,z,F);if(J.corsConfig){let Z=b(G,U,J.corsConfig);if(Z)return Z}if(J.hasOnReqHook&&J.hooks.onRequest)J.hooks.onRequest(G,F,z);if(J.hasFilterEnabled){let Z=G.routePattern??F.pathname;if(!J.filters.has(Z))if(J.filterFunction)try{let _=await J.filterFunction(U,z);if(_)return _}catch(_){return console.error("Error in filterFunction:",_),U.status(500).json({message:"Internal Server Error",error:_.message})}else return U.status(400).json({message:"Authentication required"})}if(J.hasMiddleware){let Z=J.globalMiddlewares;for(let W=0;W<Z.length;W++){let E=await Z[W](U,z);if(E)return E}let _=J.middlewares.get(F.pathname)||[];for(let W=0;W<_.length;W++){let E=await _[W](U,z);if(E)return E}}if(J.hasPreHandlerHook&&J.hooks.preHandler){let Z=await J.hooks.preHandler(U);if(Z)return Z}let Y=await L.handler(U);if(J.hasPostHandlerHook&&J.hooks.postHandler)await J.hooks.postHandler(U);if(J.hasOnSendHook&&J.hooks.onSend){let Z=await J.hooks.onSend(U,Y);if(Z)return Z}return Y??U.status(204).json({message:"No response from this handler"})}function b(G,z,F={}){let J=G.headers.get("origin")??"*",L=F?.origin,U=F?.allowedHeaders??["Content-Type","Authorization"],Y=F?.methods??["GET","POST","PUT","DELETE","OPTIONS"],Z=F?.credentials??!1,_=F?.exposedHeaders??[];if(z.setHeader("Access-Control-Allow-Methods",Y),z.setHeader("Access-Control-Allow-Headers",U),z.setHeader("Access-Control-Allow-Credentials",Z),_.length)z.setHeader("Access-Control-Expose-Headers",_);if(L==="*")z.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(L))if(J&&L.includes(J))z.setHeader("Access-Control-Allow-Origin",J);else if(L.includes("*"))z.setHeader("Access-Control-Allow-Origin","*");else return z.status(403).json({message:"CORS not allowed"});else if(typeof L==="string")if(J===L)z.setHeader("Access-Control-Allow-Origin",J);else return z.status(403).json({message:"CORS not allowed"});else return z.status(403).json({message:"CORS not allowed"});if(z.setHeader("Access-Control-Allow-Origin",J),G.method==="OPTIONS")return z.setHeader("Access-Control-Max-Age","86400"),z.status(204).text("");return null}class M{globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;constructor(){this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new V,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=null,this.hasFilterEnabled=!1}filter(){return this.hasFilterEnabled=!0,{routeMatcher:(...G)=>{return this.FilterRoutes=G,this.filter()},permitAll:()=>{for(let G of this?.FilterRoutes)this.filters.add(G);return this.FilterRoutes=null,this.filter()},require:(G)=>{if(G)this.filterFunction=G}}}cors(G){this.corsConfig=G}addHooks(G,z){if(typeof G!=="string")throw new Error("hookName must be a string");if(typeof z!=="function")throw new Error("callback must be a instance of function");switch(G){case"onRequest":this.hooks.onRequest=z,this.hasOnReqHook=!0;break;case"preHandler":this.hooks.preHandler=z,this.hasPreHandlerHook=!0;break;case"postHandler":this.hooks.postHandler=z,this.hasPostHandlerHook=!0;break;case"onSend":this.hooks.onSend=z,this.hasOnSendHook=!0;break;case"onError":this.hooks.onError=z,this.hasOnError=!0;break;case"onClose":this.hooks.onClose=z;break;default:throw new Error(`Unknown hook type: ${G}`)}}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[G,z]of this.middlewares.entries())if(z.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0;if(this.hooks.onError)this.hasOnError=!0}listen(G,z,{sslCert:F=null,sslKey:J=null}={}){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(typeof G!=="number")throw new Error("Port must be a numeric value");this.compile();let L={port:G,fetch:async(Y,Z)=>{let _=new URL(Y.url);try{return await K(Y,Z,_,this)}catch(W){if(this.hasOnError&&this.hooks.onError){let E=await this.hooks.onError(W,Y,_,Z);if(E)return E}return new Response(JSON.stringify({message:"Internal Server Error",error:W.message}),{status:500})}}};if(F&&J)L.certFile=F,L.keyFile=J;let U=Bun?.serve(L);if(typeof z==="function")return z();if(F&&J)console.log(`HTTPS server is running on https://localhost:${G}`);else console.log(`HTTP server is running on http://localhost:${G}`);return U}register(G,z){if(typeof G!=="string")throw new Error("path must be a string");if(typeof z!=="object")throw new Error("handler parameter should be a instance of router object",z);let F=Object.entries(z.trie.root.children);z.trie.root.subMiddlewares.forEach((J,L)=>{if(!this.middlewares.has(G+L))this.middlewares.set(G+L,[]);J?.forEach((U)=>{if(!this.middlewares.get(G+L)?.includes(U))this.middlewares.get(G+L)?.push(U)})});for(let[J,L]of F){let U=G+L?.path,Y=L.handler[0],Z=L.method[0];this.trie.insert(U,{handler:Y,method:Z})}z.trie=new V}addRoute(G,z,F){if(typeof z!=="string")throw new Error("Path must be a string type");if(typeof G!=="string")throw new Error("method must be a string type");let J=F.slice(0,-1),L=F[F.length-1];if(!this.middlewares.has(z))this.middlewares.set(z,[]);J.forEach((U)=>{if(z==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...J])];else if(!this.middlewares.get(z)?.includes(U))this.middlewares.get(z)?.push(U)}),this.trie.insert(z,{handler:L,method:G})}use(G,z){if(typeof G==="function"){if(!this.globalMiddlewares.includes(G))this.globalMiddlewares.push(G);return}let F=G;if(!this.middlewares.has(F))this.middlewares.set(F,[]);if(z){if(!this.middlewares.get(F)?.includes(z))this.middlewares.get(F)?.push(z)}}get(G,...z){return this.addRoute("GET",G,z),this}post(G,...z){return this.addRoute("POST",G,z),this}put(G,...z){return this.addRoute("PUT",G,z),this}patch(G,...z){return this.addRoute("PATCH",G,z),this}delete(G,...z){return this.addRoute("DELETE",G,z),this}}export{M as default};
