class B{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class D{root;constructor(){this.root=new B}insert(z,G){let J=this.root,L=z.split("/").filter(Boolean);if(z==="/"){J.isEndOfWord=!0,J.handler.push(G.handler),J.path=z,J.method.push(G.method);return}for(let U of L){let X=!1,Y=U;if(U.startsWith(":"))X=!0,Y=":";if(!J.children[Y])J.children[Y]=new B;J=J.children[Y],J.isDynamic=X,J.pattern=U,J.method.push(G.method),J.handler.push(G.handler),J.path=z}J.isEndOfWord=!0,J.method.push(G.method),J.handler.push(G.handler),J.path=z}search(z,G){let J=this.root,L=z.split("/").filter(Boolean),U=L.length;for(let $ of L){let K=$;if(!J.children[K])if(J.children[":"])J=J.children[":"];else return null;else J=J.children[K]}let X=J.path.split("/").filter(Boolean);if(U!==X.length)return null;let Y=J.method.indexOf(G);if(Y!==-1)return{path:J.path,handler:J.handler[Y],isDynamic:J.isDynamic,pattern:J.pattern,method:J.method[Y]};return{path:J.path,handler:J.handler,isDynamic:J.isDynamic,pattern:J.pattern,method:J.method[Y]}}}function Q(z){switch(z.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function j(z,G,J){let L=new Headers({"X-Powered-By":"DieselJS","Cache-Control":"no-cache"});L.set("X-Powered-By","DieselJS");let U={},X=!1,Y,$=null,K,E,A={};return{req:z,server:G,url:J,setHeader(Z,W){return L.set(Z,W),this},getUser(){return A},setUser(Z){if(Z)A=Z},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!E)E=await w(z);if(E.error)return new Response(JSON.stringify({error:E.error}),{status:400});return E},set(Z,W){if(typeof Z!=="string")throw new Error("Key must be string type!");if(!W)throw new Error("value paramter is missing pls pass value after key");return U[Z]=W,this},get(Z){return Z?U[Z]:null},setAuth(Z){return X=Z,this},getAuth(){return X},text(Z,W){if(!L.has("Content-Type"))L.set("Content-Type","text/plain; charset=utf-8");return new Response(Z,{status:W,headers:L})},send(Z,W){if(typeof Z==="string"){if(!L.has("Content-Type"))L.set("Content-Type","text/plain; charset=utf-8")}else if(typeof Z==="object"){if(!L.has("Content-Type"))L.set("Content-Type","application/json; charset=utf-8");Z=JSON.stringify(Z)}else if(Z instanceof Uint8Array||Z instanceof ArrayBuffer){if(!L.has("Content-Type"))L.set("Content-Type","application/octet-stream")}return new Response(Z,{status:W,headers:L})},json(Z,W){if(!L.has("Content-Type"))L.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(Z),{status:W,headers:L})},file(Z,W=200,_){let F=Q(Z),T=Bun.file(Z),V=new Headers;if(!V.has("Content-Type"))V.set("Content-Type",_??F);return new Response(T,{status:W,headers:V})},redirect(Z,W){return L.set("Location",Z),new Response(null,{status:W??302,headers:L})},setCookie(Z,W,_={}){let F=`${encodeURIComponent(Z)}=${encodeURIComponent(W)}`;if(_.maxAge)F+=`; Max-Age=${_.maxAge}`;if(_.expires)F+=`; Expires=${_.expires.toUTCString()}`;if(_.path)F+=`; Path=${_.path}`;if(_.domain)F+=`; Domain=${_.domain}`;if(_.secure)F+="; Secure";if(_.httpOnly)F+="; HttpOnly";if(_.sameSite)F+=`; SameSite=${_.sameSite}`;return L?.append("Set-Cookie",F),this},getParams(Z){if(!K&&z?.routePattern)K=S(z?.routePattern,J?.pathname);if(Z)if(K)return K[Z];else return;if(K)return Z;else return},getQuery(Z){try{if(!Y)Y=Object.fromEntries(J.searchParams);if(Z)return Y[Z]??void 0;return Y}catch(W){return}},getCookie(Z){if(!$){let W=z.headers.get("cookie");if(W)$=I(W);else return}if(!$)return;if(Z)return $[Z]??void 0;else return $}}}function I(z){let G={},J=z?.split(";");for(let L=0;L<J?.length;L++){let[U,...X]=J[L].trim().split("="),Y=X?.join("=").trim();if(U)G[U.trim()]=decodeURIComponent(Y)}return G}function S(z,G){let J={},L=z.split("/"),[U]=G.split("?"),X=U.split("/");if(L.length!==X.length)return null;for(let Y=0;Y<L.length;Y++)if(L[Y].startsWith(":"))J[L[Y].slice(1)]=X[Y];return J}async function w(z){let G=z.headers.get("Content-Type");if(!G)return{};try{if(G.startsWith("application/json"))return await z.json();if(G.startsWith("application/x-www-form-urlencoded")){let J=await z.text();return Object.fromEntries(new URLSearchParams(J))}if(G.startsWith("multipart/form-data")){let J=await z.formData(),L={};for(let[U,X]of J.entries())L[U]=X;return L}return{error:"Unknown request body type"}}catch(J){return{error:"Invalid request body format"}}}async function N(z,G,J,L){let U=L.trie.search(J.pathname,z.method);if(U?.isDynamic)z.routePattern=U.path;let X=j(z,G,J);if(L.corsConfig){let $=b(z,X,L.corsConfig);if($)return $}if(L.hooks.onRequest)L.hooks.onRequest(z,J,G);if(L.hasFilterEnabled){let $=z.routePattern??J.pathname,K=await v(L,$,X,G);if(K)return K}if(L.hasMiddleware){let $=L.globalMiddlewares;for(let E=0;E<$.length;E++){let A=await $[E](X,G);if(A)return A}let K=L.middlewares.get(J.pathname)||[];for(let E=0;E<K.length;E++){let A=await K[E](X,G);if(A)return A}}if(!U||U.method!==z.method){let $=L.trie.search("*",z.method);if($){let K=await O(L,J.pathname,X);if(K)return K;return await $.handler(X)}return C(U?405:404,U?"Method not allowed":`Route not found for ${J.pathname}`)}if(L.hooks.preHandler){let $=await L.hooks.preHandler(X);if($)return $}let Y=await U.handler(X);if(L.hooks.postHandler)await L.hooks.postHandler(X);if(L.hooks.onSend){let $=await L.hooks.onSend(X,Y);if($)return $}return Y??C(204,"No response from this handler")}function b(z,G,J={}){let L=z.headers.get("origin")??"*",U=J?.origin,X=J?.allowedHeaders??["Content-Type","Authorization"],Y=J?.methods??["GET","POST","PUT","DELETE","OPTIONS"],$=J?.credentials??!1,K=J?.exposedHeaders??[];if(G.setHeader("Access-Control-Allow-Methods",Y),G.setHeader("Access-Control-Allow-Headers",X),G.setHeader("Access-Control-Allow-Credentials",$),K.length)G.setHeader("Access-Control-Expose-Headers",K);if(U==="*"||L==="*")G.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(U))if(L&&U.includes(L))G.setHeader("Access-Control-Allow-Origin",L);else if(U.includes("*"))G.setHeader("Access-Control-Allow-Origin","*");else return G.json({message:"CORS not allowed"},403);else if(typeof U==="string")if(L===U)G.setHeader("Access-Control-Allow-Origin",L);else return G.json({message:"CORS not allowed"},403);else return G.json({message:"CORS not allowed"},403);if(G.setHeader("Access-Control-Allow-Origin",L),z.method==="OPTIONS")return G.setHeader("Access-Control-Max-Age","86400"),G.text("",204);return null}async function v(z,G,J,L){if(!z.filters.has(G)){if(z.filterFunction.length)for(let U of z.filterFunction){let X=await U(J,L);if(X)return X}return J.json({error:!0,message:"Protected route, authentication required",status:401},401)}}function C(z,G){return new Response(JSON.stringify({error:!0,message:G,status:z}),{status:z,headers:{"Content-Type":"application/json"}})}async function O(z,G,J){if(!z.UseStaticFiles)throw new Error("Static files directory is not configured.");let L=`${z.UseStaticFiles}${G}`;if(/\.(js|css|html)$/.test(G)){let U=Q(L);return J.file(L,200,U)}return null}class M{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;UseStaticFiles;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.UseStaticFiles=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...z)=>{return this.FilterRoutes=z,this.setupFilter()},permitAll:()=>{for(let z of this?.FilterRoutes)this.filters.add(z);return this.FilterRoutes=null,this.setupFilter()},authenticate:(z)=>{if(z?.length)for(let G of z)this.filterFunction.push(G)}}}cors(z){return this.corsConfig=z,this}UseStatic(z){this.UseStaticFiles=z}static(z,G){if(!Array.isArray(z)&&!Array.isArray(G))this.staticFiles[z]=G;else for(let J=0;J<z.length;J++)this.staticFiles[z[J]]=G[J];return this}addHooks(z,G){if(typeof z!=="string")throw new Error("hookName must be a string");if(typeof G!=="function")throw new Error("callback must be a instance of function");switch(z){case"onRequest":this.hooks.onRequest=G;break;case"preHandler":this.hooks.preHandler=G;break;case"postHandler":this.hooks.postHandler=G;break;case"onSend":this.hooks.onSend=G;break;case"onError":this.hooks.onError=G;break;case"onClose":this.hooks.onClose=G;break;default:throw new Error(`Unknown hook type: ${z}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[z,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}this.tempRoutes=new Map}listen(z=3000,...G){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(!z||typeof z!=="number")throw new Error("port is required and should be a number type");let J="0.0.0.0",L=void 0,U={};for(let Y of G)if(typeof Y==="string")J=Y;else if(typeof Y==="function")L=Y;else if(typeof Y==="object"&&Y!==null)U=Y;let X={port:z,hostname:J,fetch:async(Y,$)=>{let K=new URL(Y.url);try{return await N(Y,$,K,this)}catch(E){return this.hasOnError&&this.hooks.onError?this.hooks.onError(E,Y,K,$):new Response(JSON.stringify({message:"Internal Server Error",error:E.message,status:500}),{status:500})}},static:this.staticFiles,development:!0};if(U.sslCert&&U.sslKey)X.certFile=U.sslCert,X.keyFile=U.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(X),L)return L();if(U.sslCert&&U.sslKey)console.log(`HTTPS server is running on https://localhost:${z}`);else console.log(`HTTP server is running on http://localhost:${z}`);return this.serverInstance}close(z){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,z?z():console.log("Server has been stopped");else console.warn("Server is not running.")}route(z,G){if(!z||typeof z!=="string")throw new Error("Path must be a string");let J=Object.fromEntries(G.tempRoutes);return Object.entries(J).forEach(([U,X])=>{let Y=`${z}${U}`;if(!this.middlewares.has(Y))this.middlewares.set(Y,[]);X.handlers.slice(0,-1).forEach((A)=>{if(!this.middlewares.get(Y)?.includes(A))this.middlewares.get(Y)?.push(A)});let K=X.handlers[X.handlers.length-1],E=X.method;try{this.trie.insert(Y,{handler:K,method:E})}catch(A){console.error(`Error inserting ${Y}:`,A)}}),G=null,this}register(z,G){return this.route(z,G)}addRoute(z,G,J){if(typeof G!=="string")throw new Error(`Error in ${J[J.length-1]}: Path must be a string. Received: ${typeof G}`);if(typeof z!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof z}`);this.tempRoutes.set(G,{method:z,handlers:J});let L=J.slice(0,-1),U=J[J.length-1];if(!this.middlewares.has(G))this.middlewares.set(G,[]);L.forEach((X)=>{if(G==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...L])];else if(!this.middlewares.get(G)?.includes(X))this.middlewares.get(G)?.push(X)});try{if(z==="ANY"){let X=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let Y of X)this.trie.insert(G,{handler:U,method:Y})}this.trie.insert(G,{handler:U,method:z})}catch(X){console.error(`Error inserting ${G}:`,X)}}use(z,G){if(Array.isArray(z))z.forEach((L)=>{if(typeof L==="function")this.globalMiddlewares.push(L)});if(typeof z==="function"){if(this.globalMiddlewares.push(z),Array.isArray(G))G.forEach((L)=>{this.globalMiddlewares.push(L)});return}return(Array.isArray(z)?z.filter((L)=>typeof L==="string"):[z].filter((L)=>typeof L==="string")).forEach((L)=>{if(!this.middlewares.has(L))this.middlewares.set(L,[]);if(G)(Array.isArray(G)?G:[G]).forEach((X)=>{this.middlewares.get(L)?.push(X)})}),this}get(z,...G){return this.addRoute("GET",z,G),this}post(z,...G){return this.addRoute("POST",z,G),this}put(z,...G){return this.addRoute("PUT",z,G),this}patch(z,...G){return this.addRoute("PATCH",z,G),this}delete(z,...G){return this.addRoute("DELETE",z,G),this}any(z,...G){return this.addRoute("ANY",z,G),this}head(z,...G){return this.addRoute("HEAD",z,G),this}options(z,...G){return this.addRoute("OPTIONS",z,G),this}propfind(z,...G){return this.addRoute("PROPFIND",z,G),this}}export{M as default};
