var T=Object.create;var{getPrototypeOf:S,defineProperty:j,getOwnPropertyNames:b}=Object;var w=Object.prototype.hasOwnProperty;var v=(z,A,J)=>{J=z!=null?T(S(z)):{};let G=A||!z||!z.__esModule?j(J,"default",{value:z,enumerable:!0}):J;for(let K of b(z))if(!w.call(G,K))j(G,K,{get:()=>z[K],enumerable:!0});return G};var H=((z)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(z,{get:(A,J)=>(typeof require!=="undefined"?require:A)[J]}):z)(function(z){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+z+'" is not supported')});class B{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class _{root;constructor(){this.root=new B}insert(z,A){let J=this.root,G=z.split("/").filter(Boolean);if(z==="/"){J.isEndOfWord=!0,J.handler.push(A.handler),J.path=z,J.method.push(A.method);return}for(let K of G){let L=!1,Y=K;if(K.startsWith(":"))L=!0,Y=":";if(!J.children[Y])J.children[Y]=new B;J=J.children[Y],J.isDynamic=L,J.pattern=K,J.method.push(A.method),J.handler.push(A.handler),J.path=z}J.isEndOfWord=!0,J.method.push(A.method),J.handler.push(A.handler),J.path=z}search(z,A){let J=this.root,G=z.split("/").filter(Boolean),K=G.length;for(let U of G){let Z=U;if(!J.children[Z])if(J.children[":"])J=J.children[":"];else return null;else J=J.children[Z]}let L=J.path.split("/").filter(Boolean);if(K!==L.length)return null;let Y=J.method.indexOf(A);if(Y!==-1)return{path:J.path,handler:J.handler[Y],isDynamic:J.isDynamic,pattern:J.pattern,method:J.method[Y]};return{path:J.path,handler:J.handler,isDynamic:J.isDynamic,pattern:J.pattern,method:J.method[Y]}}}function x(z){let{time:A=60000,max:J=100,message:G="Rate limit exceeded. Please try again later."}=z,K=new Map;return(L)=>{let Y=new Date,U=L.ip;if(!K.has(U))K.set(U,{count:0,startTime:Y});let Z=K.get(U);if(Z)if(Y-Z.startTime>A)Z.count=1,Z.startTime=Y;else Z.count++;if(Z&&Z.count>J)return L.json({error:G},429)}}function E(z){switch(z.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var C=(z,A,J,G)=>{if(J>G)return!1;let K=J+(G-J)/2;if(z[K]==A)return!0;if(z[K]>A)return C(z,A,J,K-1);return C(z,A,K+1,G)};function F(z,A,J){let G=new Headers({"Cache-Control":"no-cache"}),K=null,L=null,Y=null,U=null,Z={};return{req:z,server:A,url:J,setHeader(X,V){return G.set(X,V),this},removeHeader(X){return G.delete(X),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!K)try{K=Object.fromEntries(this.url.searchParams)}catch(X){throw new Error("Failed to parse query parameters")}return K},get params(){if(!L&&this.req.routePattern)try{L=R(this.req.routePattern,this.url.pathname)}catch(X){throw new Error("Failed to extract route parameters")}return L??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!U)U=(async()=>{let X=await q(this.req);if(X.error)throw new Error(X.error);return Object.keys(X).length===0?null:X})();return U},set(X,V){return Z[X]=V,this},get(X){return Z[X]},text(X,V=200){if(!G.has("Content-Type"))G.set("Content-Type","text/plain; charset=utf-8");return new Response(X,{status:V,headers:G})},send(X,V=200){let $=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),W=X instanceof Uint8Array?"Uint8Array":X instanceof ArrayBuffer?"ArrayBuffer":typeof X;if(!G.has("Content-Type"))G.set("Content-Type",$.get(W)??"text/plain; charset=utf-8");let Q=W==="object"&&X!==null?JSON.stringify(X):X;return new Response(Q,{status:V,headers:G})},json(X,V=200){if(!G.has("Content-Type"))G.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(X),{status:V,headers:G})},file(X,V=200,$){let W=Bun.file(X);if(!G.has("Content-Type"))G.set("Content-Type",$??E(X));return new Response(W,{status:V,headers:G})},async ejs(X,V={}){let $;try{$=await import("ejs"),$=$.default||$}catch(W){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let W=await Bun.file(X).text(),Q=$.render(W,V),O=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(Q,{status:200,headers:O})}catch(W){return console.error("EJS Rendering Error:",W),new Response("Error rendering template",{status:500})}},redirect(X,V=302){return G.set("Location",X),new Response(null,{status:V,headers:G})},setCookie(X,V,$={}){let W=`${encodeURIComponent(X)}=${encodeURIComponent(V)}`;if($.maxAge)W+=`; Max-Age=${$.maxAge}`;if($.expires)W+=`; Expires=${$.expires.toUTCString()}`;if($.path)W+=`; Path=${$.path}`;if($.domain)W+=`; Domain=${$.domain}`;if($.secure)W+="; Secure";if($.httpOnly)W+="; HttpOnly";if($.sameSite)W+=`; SameSite=${$.sameSite}`;return G.append("Set-Cookie",W),this},get cookies(){if(!Y){let X=this.req.headers.get("cookie");Y=X?P(X):{}}return Y}}}function P(z){return Object.fromEntries(z.split(";").map((A)=>{let[J,...G]=A.trim().split("=");return[J,decodeURIComponent(G.join("="))]}))}function R(z,A){let J={},G=z.split("/"),[K]=A.split("?"),L=K.split("/");if(G.length!==L.length)return null;for(let Y=0;Y<G.length;Y++)if(G[Y].startsWith(":"))J[G[Y].slice(1)]=L[Y];return J}async function q(z){let A=z.headers.get("Content-Type");if(!A)return{};if(z.headers.get("Content-Length")==="0"||!z.body)return{};try{if(A.startsWith("application/json"))return await z.json();if(A.startsWith("application/x-www-form-urlencoded")){let G=await z.text();return Object.fromEntries(new URLSearchParams(G))}if(A.startsWith("multipart/form-data")){let G=await z.formData(),K={};for(let[L,Y]of G.entries())K[L]=Y;return K}return{error:"Unknown request body type"}}catch(G){return{error:"Invalid request body format"}}}async function N(z,A,J,G){let K=F(z,A,J),L=G.trie.search(J.pathname,z.method);if(z.routePattern=L?.path,G.hasFilterEnabled){let Z=z.routePattern??J.pathname,X=await y(G,Z,K,A);if(X)return X}if(G.hasMiddleware){let Z=await M(G.globalMiddlewares,K,A);if(Z)return Z;let X=G.middlewares.get(J.pathname)||[],V=await M(X,K,A);if(V)return V}if(!L?.handler||L.method!==z.method){if(G.staticPath){let Z=await k(G,J.pathname,K);if(Z)return Z;let X=G.trie.search("*",z.method);if(X?.handler)return await X.handler(K)}if(G.hooks.routeNotFound&&!L?.handler){let Z=await G.hooks.routeNotFound(K);if(Z)return Z}if(!L||!L?.handler?.length)return D(404,`Route not found for ${J.pathname}`);if(L?.method!==z.method)return D(405,"Method not allowed")}if(G.hooks.preHandler){let Z=await G.hooks.preHandler(K);if(Z)return Z}let Y=L.handler(K),U=Y instanceof Promise?await Y:Y;if(G.hooks.postHandler)await G.hooks.postHandler(K);if(G.hooks.onSend){let Z=await G.hooks.onSend(K,U);if(Z)return Z}return U??D(204,"No response from this handler")}async function M(z,A,J){for(let G of z){let K=await G(A,J);if(K)return K}return null}async function y(z,A,J,G){if(!z.filters.has(A))if(z.filterFunction.length)for(let K of z.filterFunction){let L=await K(J,G);if(L)return L}else return J.json({error:!0,message:"Protected route, authentication required",status:401},401)}function D(z,A){return new Response(JSON.stringify({error:!0,message:A,status:z}),{status:z,headers:{"Content-Type":"application/json"}})}async function k(z,A,J){if(!z.staticPath)return null;let G=`${z.staticPath}${A}`;if(await Bun.file(G).exists()){let L=E(G);return J.file(G,200,L)}return null}class I{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new _,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null,routeNotFound:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={}}setupFilter(){return this.hasFilterEnabled=!0,{routeMatcher:(...z)=>{return this.FilterRoutes=z,this.setupFilter()},permitAll:()=>{for(let z of this?.FilterRoutes)this.filters.add(z);return this.FilterRoutes=null,this.setupFilter()},authenticate:(z)=>{if(z?.length)for(let A of z)this.filterFunction.push(A)}}}redirect(z,A,J){return this.any(z,(G)=>{let K=G.params,L=A;if(K)for(let U in K)L=L.replace(`:${U}`,K[U]);let Y=G.url.search;if(Y)L+=Y;return G.redirect(L,J)}),this}serveStatic(z){this.staticPath=z}static(z={}){return this.staticFiles={...this.staticFiles,...z},this}addHooks(z,A){if(typeof z!=="string")throw new Error("hookName must be a string");if(typeof A!=="function")throw new Error("callback must be a instance of function");switch(z){case"onRequest":this.hooks.onRequest=A;break;case"preHandler":this.hooks.preHandler=A;break;case"postHandler":this.hooks.postHandler=A;break;case"onSend":this.hooks.onSend=A;break;case"onError":this.hooks.onError=A;break;case"onClose":this.hooks.onClose=A;break;case"routeNotFound":this.hooks.routeNotFound=A;break;default:throw new Error(`Unknown hook type: ${z}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[z,A]of this.middlewares.entries())if(A.length>0){this.hasMiddleware=!0;break}this.tempRoutes=null}listen(z,...A){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let J="0.0.0.0",G=void 0,K={};for(let Y of A)if(typeof Y==="string")J=Y;else if(typeof Y==="function")G=Y;else if(typeof Y==="object"&&Y!==null)K=Y;let L={port:z,hostname:J,fetch:async(Y,U)=>{let Z=new URL(Y.url);try{if(this.hooks.onRequest)this.hooks.onRequest(Y,Z,U);return await N(Y,U,Z,this)}catch(X){return this.hooks.onError?this.hooks.onError(X,Y,Z,U):new Response(JSON.stringify({message:"Internal Server Error",error:X.message,status:500}),{status:500})}},static:this.staticFiles,development:!0};if(K.sslCert&&K.sslKey)L.certFile=K.sslCert,L.keyFile=K.sslKey;if(this.compile(),this.serverInstance=Bun?.serve(L),G)return G();if(K.sslCert&&K.sslKey)console.log(`HTTPS server is running on https://localhost:${z}`);else console.log(`HTTP server is running on http://localhost:${z}`);return this.serverInstance}close(z){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,z?z():console.log("Server has been stopped");else console.warn("Server is not running.")}route(z,A){if(!z||typeof z!=="string")throw new Error("Path must be a string");let J=Object.fromEntries(A.tempRoutes);return Object.entries(J).forEach(([K,L])=>{let Y=K.replace(/::\w+$/,""),U=`${z}${Y}`;if(!this.middlewares.has(U))this.middlewares.set(U,[]);L.handlers.slice(0,-1).forEach(($)=>{if(!this.middlewares.get(U)?.includes($))this.middlewares.get(U)?.push($)});let X=L.handlers[L.handlers.length-1],V=L.method;try{this.trie.insert(U,{handler:X,method:V})}catch($){console.error(`Error inserting ${U}:`,$)}}),A=null,this}register(z,A){return this.route(z,A)}addRoute(z,A,J){if(typeof A!=="string")throw new Error(`Error in ${J[J.length-1]}: Path must be a string. Received: ${typeof A}`);if(typeof z!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof z}`);this.tempRoutes?.set(A+"::"+z,{method:z,handlers:J});let G=J.slice(0,-1),K=J[J.length-1];if(!this.middlewares.has(A))this.middlewares.set(A,[]);G.forEach((L)=>{if(A==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...G])];else if(!this.middlewares.get(A)?.includes(L))this.middlewares.get(A)?.push(L)});try{if(z==="ANY"){let L=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let Y of L)this.trie.insert(A,{handler:K,method:Y})}this.trie.insert(A,{handler:K,method:z})}catch(L){console.error(`Error inserting ${A}:`,L)}}use(z,A){if(Array.isArray(z))z.forEach((G)=>{if(typeof G==="function")this.globalMiddlewares.push(G)});if(typeof z==="function"){if(this.globalMiddlewares.push(z),Array.isArray(A))A.forEach((G)=>{this.globalMiddlewares.push(G)});return}return(Array.isArray(z)?z.filter((G)=>typeof G==="string"):[z].filter((G)=>typeof G==="string")).forEach((G)=>{if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(A)(Array.isArray(A)?A:[A]).forEach((L)=>{this.middlewares.get(G)?.push(L)})}),this}get(z,...A){return this.addRoute("GET",z,A),this}post(z,...A){return this.addRoute("POST",z,A),this}put(z,...A){return this.addRoute("PUT",z,A),this}patch(z,...A){return this.addRoute("PATCH",z,A),this}delete(z,...A){return this.addRoute("DELETE",z,A),this}any(z,...A){return this.addRoute("ANY",z,A),this}head(z,...A){return this.addRoute("HEAD",z,A),this}options(z,...A){return this.addRoute("OPTIONS",z,A),this}propfind(z,...A){return this.addRoute("PROPFIND",z,A),this}}export{I as default};
