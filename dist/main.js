class Q{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class D{root;constructor(){this.root=new Q}insert(G,z){let L=this.root,J=G.split("/").filter(Boolean);if(G==="/"){L.isEndOfWord=!0,L.handler=[z.handler],L.path=G,L.method=[z.method];return}for(let U=0;U<J.length;U++){let X=J[U],_=!1,Y=X;if(X.startsWith(":"))_=!0,Y=":";if(!L.children[Y])L.children[Y]=new Q;if(L=L.children[Y],L.isDynamic=_,L.pattern=X,U===J.length-1)L.handler=[z.handler],L.method=[z.method],L.isEndOfWord=!0,L.path=G}}search(G,z){let L=this.root,J=G.split("/").filter(Boolean);for(let X of J){let _=X;if(!L.children[_])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[_]}let U=L.method.indexOf(z);if(L.isEndOfWord&&U!==-1)return{path:L.path,handler:L.handler[U],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[U]};return null}}function V(G,z,L){let J=new Headers,U={},X=!1,_,Y=null,$,F,W={};return{req:G,server:z,url:L,getUser(){return W},setUser(Z){if(Z)W=Z},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!F)F=await T(G);if(F.error)return new Response(JSON.stringify({error:F.error}),{status:400});return F},setHeader(Z,K){return J.set(Z,K),this},set(Z,K){if(typeof Z!=="string")throw new Error("Key must be string type!");if(!K)throw new Error("value paramter is missing pls pass value after key");return U[Z]=K,this},get(Z){return Z?U[Z]:null},setAuth(Z){return X=Z,this},getAuth(){return X},text(Z,K){return new Response(Z,{status:K,headers:J})},json(Z,K){return new Response(JSON.stringify(Z),{status:K,headers:J})},file(Z,K){return new Response(Bun.file(Z),{status:K,headers:J})},redirect(Z,K){return J.set("Location",Z),new Response(null,{status:K??302,headers:J})},setCookie(Z,K,E={}){let A=`${encodeURIComponent(Z)}=${encodeURIComponent(K)}`;if(E.maxAge)A+=`; Max-Age=${E.maxAge}`;if(E.expires)A+=`; Expires=${E.expires.toUTCString()}`;if(E.path)A+=`; Path=${E.path}`;if(E.domain)A+=`; Domain=${E.domain}`;if(E.secure)A+="; Secure";if(E.httpOnly)A+="; HttpOnly";if(E.sameSite)A+=`; SameSite=${E.sameSite}`;return J?.append("Set-Cookie",A),this},getParams(Z){if(!$&&G?.routePattern)$=I(G?.routePattern,L?.pathname);if(Z)return $[Z]??{};return Z},getQuery(Z){try{if(!_)_=Object.fromEntries(L.searchParams);return Z?_[Z]||{}:_}catch(K){return{}}},getCookie(Z){if(!Y){let K=G.headers.get("cookie");if(K)Y=M(K);else return null}if(!Y)return null;if(Z)return Y[Z]??null;else return Y}}}function M(G){let z={},L=G?.split(";");for(let J=0;J<L?.length;J++){let[U,...X]=L[J].trim().split("="),_=X?.join("=").trim();if(U)z[U.trim()]=decodeURIComponent(_)}return z}function I(G,z){let L={},J=G.split("/"),[U]=z.split("?"),X=U.split("/");if(J.length!==X.length)return null;for(let _=0;_<J.length;_++)if(J[_].startsWith(":"))L[J[_].slice(1)]=X[_];return L}async function T(G){let z=G.headers.get("Content-Type");if(!z)return{};try{if(z.startsWith("application/json"))return await G.json();if(z.startsWith("application/x-www-form-urlencoded")){let L=await G.text();return Object.fromEntries(new URLSearchParams(L))}if(z.startsWith("multipart/form-data")){let L=await G.formData(),J={};for(let[U,X]of L.entries())J[U]=X;return J}return{error:"Unknown request body type"}}catch(L){return{error:"Invalid request body format"}}}async function B(G,z,L,J){let U=J.trie.search(L.pathname,G.method);if(U?.isDynamic)G.routePattern=U.path;let X=V(G,z,L);if(J.corsConfig){let Y=N(G,X,J.corsConfig);if(Y)return Y}if(J.hasOnReqHook&&J.hooks.onRequest)J.hooks.onRequest(G,L,z);if(J.hasFilterEnabled){let Y=G.routePattern??L.pathname;if(!J.filters.has(Y))if(J.filterFunction)try{let $=await J.filterFunction(X,z);if($)return $}catch($){return console.error("Error in filterFunction:",$),X.json({message:"Internal Server Error",error:$.message},500)}else return X.json({message:"Authentication required"},400)}if(J.hasMiddleware){let Y=J.globalMiddlewares;for(let F=0;F<Y.length;F++){let W=await Y[F](X,z);if(W)return W}let $=J.middlewares.get(L.pathname)||[];for(let F=0;F<$.length;F++){let W=await $[F](X,z);if(W)return W}}if(!U||U.method!==G.method){let Y=U?"Method not allowed":`Route not found for ${L.pathname}`,$=U?405:404;return new Response(JSON.stringify({message:Y}),{status:$})}if(J.hasPreHandlerHook&&J.hooks.preHandler){let Y=await J.hooks.preHandler(X);if(Y)return Y}let _=await U.handler(X);if(J.hasPostHandlerHook&&J.hooks.postHandler)await J.hooks.postHandler(X);if(J.hasOnSendHook&&J.hooks.onSend){let Y=await J.hooks.onSend(X,_);if(Y)return Y}return _??X.json({message:"No response from this handler"},204)}function N(G,z,L={}){let J=G.headers.get("origin")??"*",U=L?.origin,X=L?.allowedHeaders??["Content-Type","Authorization"],_=L?.methods??["GET","POST","PUT","DELETE","OPTIONS"],Y=L?.credentials??!1,$=L?.exposedHeaders??[];if(z.setHeader("Access-Control-Allow-Methods",_),z.setHeader("Access-Control-Allow-Headers",X),z.setHeader("Access-Control-Allow-Credentials",Y),$.length)z.setHeader("Access-Control-Expose-Headers",$);if(U==="*")z.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(U))if(J&&U.includes(J))z.setHeader("Access-Control-Allow-Origin",J);else if(U.includes("*"))z.setHeader("Access-Control-Allow-Origin","*");else return z.json({message:"CORS not allowed"},403);else if(typeof U==="string")if(J===U)z.setHeader("Access-Control-Allow-Origin",J);else return z.json({message:"CORS not allowed"},403);else return z.json({message:"CORS not allowed"},403);if(z.setHeader("Access-Control-Allow-Origin",J),G.method==="OPTIONS")return z.setHeader("Access-Control-Max-Age","86400"),z.text("",204);return null}class j{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=null,this.hasFilterEnabled=!1}filter(){return this.hasFilterEnabled=!0,{routeMatcher:(...G)=>{return this.FilterRoutes=G,this.filter()},permitAll:()=>{for(let G of this?.FilterRoutes)this.filters.add(G);return this.FilterRoutes=null,this.filter()},require:(G)=>{if(G)this.filterFunction=G}}}cors(G){return this.corsConfig=G,this}addHooks(G,z){if(typeof G!=="string")throw new Error("hookName must be a string");if(typeof z!=="function")throw new Error("callback must be a instance of function");switch(G){case"onRequest":this.hooks.onRequest=z,this.hasOnReqHook=!0;break;case"preHandler":this.hooks.preHandler=z,this.hasPreHandlerHook=!0;break;case"postHandler":this.hooks.postHandler=z,this.hasPostHandlerHook=!0;break;case"onSend":this.hooks.onSend=z,this.hasOnSendHook=!0;break;case"onError":this.hooks.onError=z,this.hasOnError=!0;break;case"onClose":this.hooks.onClose=z;break;default:throw new Error(`Unknown hook type: ${G}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[G,z]of this.middlewares.entries())if(z.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0;if(this.hooks.onError)this.hasOnError=!0;this.tempRoutes=new Map}listen(G=3000,...z){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");if(!G||typeof G!=="number")throw new Error("port is required and should be a number type");let L="0.0.0.0",J=void 0,U={};for(let Y of z)if(typeof Y==="string")L=Y;else if(typeof Y==="function")J=Y;else if(typeof Y==="object"&&Y!==null)U=Y;let X={port:G,hostname:L,fetch:async(Y,$)=>{let F=new URL(Y.url);try{return await B(Y,$,F,this)}catch(W){if(this.hasOnError&&this.hooks.onError){let Z=await this.hooks.onError(W,Y,F,$);if(Z)return Z}return new Response(JSON.stringify({message:"Internal Server Error",error:W.message}),{status:500})}}};if(U.sslCert&&U.sslKey)X.certFile=U.sslCert,X.keyFile=U.sslKey;this.compile();let _=Bun?.serve(X);if(J)return J();if(U.sslCert&&U.sslKey)console.log(`HTTPS server is running on https://localhost:${G}`);else console.log(`HTTP server is running on http://localhost:${G}`);return _}route(G,z){if(!G||typeof G!=="string")throw new Error("Path must be a string");let L=Object.fromEntries(z.tempRoutes);return Object.entries(L).forEach(([U,X])=>{let _=`${G}${U}`;if(!this.middlewares.has(_))this.middlewares.set(_,[]);X.handlers.slice(0,-1).forEach((W)=>{if(!this.middlewares.get(_)?.includes(W))this.middlewares.get(_)?.push(W)});let $=X.handlers[X.handlers.length-1],F=X.method;try{this.trie.insert(_,{handler:$,method:F})}catch(W){console.error(`Error inserting ${_}:`,W)}}),z=null,this}register(G,z){return this.route(G,z)}addRoute(G,z,L){if(typeof z!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof z}`);if(typeof G!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof G}`);this.tempRoutes.set(z,{method:G,handlers:L});let J=L.slice(0,-1),U=L[L.length-1];if(!this.middlewares.has(z))this.middlewares.set(z,[]);J.forEach((X)=>{if(z==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...J])];else if(!this.middlewares.get(z)?.includes(X))this.middlewares.get(z)?.push(X)});try{this.trie.insert(z,{handler:U,method:G})}catch(X){console.error(`Error inserting ${z}:`,X)}}use(G,z){if(Array.isArray(G))G.forEach((J)=>{if(typeof J==="function")this.globalMiddlewares.push(J)});if(typeof G==="function"){if(this.globalMiddlewares.push(G),Array.isArray(z))z.forEach((J)=>{this.globalMiddlewares.push(J)});return}return(Array.isArray(G)?G.filter((J)=>typeof J==="string"):[G].filter((J)=>typeof J==="string")).forEach((J)=>{if(!this.middlewares.has(J))this.middlewares.set(J,[]);if(z)(Array.isArray(z)?z:[z]).forEach((X)=>{this.middlewares.get(J)?.push(X)})}),this}get(G,...z){return this.addRoute("GET",G,z),this}post(G,...z){return this.addRoute("POST",G,z),this}put(G,...z){return this.addRoute("PUT",G,z),this}patch(G,...z){return this.addRoute("PATCH",G,z),this}delete(G,...z){return this.addRoute("DELETE",G,z),this}}export{j as default};
