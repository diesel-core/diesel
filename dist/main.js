class Q{children;isEndOfWord;handler;isDynamic;pattern;path;method;subMiddlewares;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class D{root;constructor(){this.root=new Q}insert(F,z){let G=this.root,J=F.split("/").filter(Boolean);if(F==="/"){G.isEndOfWord=!0,G.handler=[z.handler],G.path=F,G.method=[z.method];return}for(let L=0;L<J.length;L++){let U=J[L],Z=!1,X=U;if(U.startsWith(":"))Z=!0,X=":";if(!G.children[X])G.children[X]=new Q;if(G=G.children[X],G.isDynamic=Z,G.pattern=U,L===J.length-1)G.handler=[z.handler],G.method=[z.method],G.isEndOfWord=!0,G.path=F}}search(F,z){let G=this.root,J=F.split("/").filter(Boolean);for(let U of J){let Z=U;if(!G.children[Z])if(G.children[":"])G=G.children[":"];else return null;else G=G.children[Z]}let L=G.method.indexOf(z);if(G.isEndOfWord&&L!==-1)return{path:G.path,handler:G.handler[L],isDynamic:G.isDynamic,pattern:G.pattern,method:G.method[L]};return null}}function V(F,z,G){let J=new Headers,L={},U=!1,Z,X=null,_,$,W={};return{req:F,server:z,url:G,getUser(){return W},setUser(Y){if(Y)W=Y},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!$)$=await T(F);if($.error)return new Response(JSON.stringify({error:$.error}),{status:400});return $},setHeader(Y,K){return J.set(Y,K),this},set(Y,K){if(typeof Y!=="string")throw new Error("Key must be string type!");if(!K)throw new Error("value paramter is missing pls pass value after key");return L[Y]=K,this},get(Y){return Y?L[Y]:null},setAuth(Y){return U=Y,this},getAuth(){return U},text(Y,K){return new Response(Y,{status:K,headers:J})},json(Y,K){return new Response(JSON.stringify(Y),{status:K,headers:J})},file(Y,K){return new Response(Bun.file(Y),{status:K,headers:J})},redirect(Y,K){return J.set("Location",Y),new Response(null,{status:K??302,headers:J})},setCookie(Y,K,E={}){let A=`${encodeURIComponent(Y)}=${encodeURIComponent(K)}`;if(E.maxAge)A+=`; Max-Age=${E.maxAge}`;if(E.expires)A+=`; Expires=${E.expires.toUTCString()}`;if(E.path)A+=`; Path=${E.path}`;if(E.domain)A+=`; Domain=${E.domain}`;if(E.secure)A+="; Secure";if(E.httpOnly)A+="; HttpOnly";if(E.sameSite)A+=`; SameSite=${E.sameSite}`;return J?.append("Set-Cookie",A),this},getParams(Y){if(!_&&F?.routePattern)_=I(F?.routePattern,G?.pathname);return Y?_[Y]||{}:_},getQuery(Y){try{if(!Z)Z=Object.fromEntries(G.searchParams);return Y?Z[Y]||{}:Z}catch(K){return{}}},getCookie(Y){if(!X){let K=F.headers.get("cookie");if(K)X=M(K);else return null}if(!X)return null;if(Y)return X[Y]??null;else return X}}}function M(F){let z={},G=F?.split(";");for(let J=0;J<G?.length;J++){let[L,...U]=G[J].trim().split("="),Z=U?.join("=").trim();if(L)z[L.trim()]=decodeURIComponent(Z)}return z}function I(F,z){let G={},J=F.split("/"),[L]=z.split("?"),U=L.split("/");if(J.length!==U.length)return null;for(let Z=0;Z<J.length;Z++)if(J[Z].startsWith(":"))G[J[Z].slice(1)]=U[Z];return G}async function T(F){let z=F.headers.get("Content-Type");if(!z)return{};try{if(z.startsWith("application/json"))return await F.json();if(z.startsWith("application/x-www-form-urlencoded")){let G=await F.text();return Object.fromEntries(new URLSearchParams(G))}if(z.startsWith("multipart/form-data")){let G=await F.formData(),J={};for(let[L,U]of G.entries())J[L]=U;return J}return{error:"Unknown request body type"}}catch(G){return{error:"Invalid request body format"}}}async function B(F,z,G,J){let L=J.trie.search(G.pathname,F.method);if(L?.isDynamic)F.routePattern=L.path;let U=V(F,z,G);if(J.corsConfig){let X=N(F,U,J.corsConfig);if(X)return X}if(J.hasOnReqHook&&J.hooks.onRequest)J.hooks.onRequest(F,G,z);if(J.hasFilterEnabled){let X=F.routePattern??G.pathname;if(!J.filters.has(X))if(J.filterFunction)try{let _=await J.filterFunction(U,z);if(_)return _}catch(_){return console.error("Error in filterFunction:",_),U.json({message:"Internal Server Error",error:_.message},500)}else return U.json({message:"Authentication required"},400)}if(J.hasMiddleware){let X=J.globalMiddlewares;for(let $=0;$<X.length;$++){let W=await X[$](U,z);if(W)return W}let _=J.middlewares.get(G.pathname)||[];for(let $=0;$<_.length;$++){let W=await _[$](U,z);if(W)return W}}if(!L||L.method!==F.method){let X=L?"Method not allowed":`Route not found for ${G.pathname}`,_=L?405:404;return new Response(JSON.stringify({message:X}),{status:_})}if(J.hasPreHandlerHook&&J.hooks.preHandler){let X=await J.hooks.preHandler(U);if(X)return X}let Z=await L.handler(U);if(J.hasPostHandlerHook&&J.hooks.postHandler)await J.hooks.postHandler(U);if(J.hasOnSendHook&&J.hooks.onSend){let X=await J.hooks.onSend(U,Z);if(X)return X}return Z??U.json({message:"No response from this handler"},204)}function N(F,z,G={}){let J=F.headers.get("origin")??"*",L=G?.origin,U=G?.allowedHeaders??["Content-Type","Authorization"],Z=G?.methods??["GET","POST","PUT","DELETE","OPTIONS"],X=G?.credentials??!1,_=G?.exposedHeaders??[];if(z.setHeader("Access-Control-Allow-Methods",Z),z.setHeader("Access-Control-Allow-Headers",U),z.setHeader("Access-Control-Allow-Credentials",X),_.length)z.setHeader("Access-Control-Expose-Headers",_);if(L==="*")z.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(L))if(J&&L.includes(J))z.setHeader("Access-Control-Allow-Origin",J);else if(L.includes("*"))z.setHeader("Access-Control-Allow-Origin","*");else return z.json({message:"CORS not allowed"},403);else if(typeof L==="string")if(J===L)z.setHeader("Access-Control-Allow-Origin",J);else return z.json({message:"CORS not allowed"},403);else return z.json({message:"CORS not allowed"},403);if(z.setHeader("Access-Control-Allow-Origin",J),F.method==="OPTIONS")return z.setHeader("Access-Control-Max-Age","86400"),z.text("",204);return null}class j{tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;constructor(){this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:null,preHandler:null,postHandler:null,onSend:null,onError:null,onClose:null},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=null,this.hasFilterEnabled=!1}filter(){return this.hasFilterEnabled=!0,{routeMatcher:(...F)=>{return this.FilterRoutes=F,this.filter()},permitAll:()=>{for(let F of this?.FilterRoutes)this.filters.add(F);return this.FilterRoutes=null,this.filter()},require:(F)=>{if(F)this.filterFunction=F}}}cors(F){return this.corsConfig=F,this}addHooks(F,z){if(typeof F!=="string")throw new Error("hookName must be a string");if(typeof z!=="function")throw new Error("callback must be a instance of function");switch(F){case"onRequest":this.hooks.onRequest=z,this.hasOnReqHook=!0;break;case"preHandler":this.hooks.preHandler=z,this.hasPreHandlerHook=!0;break;case"postHandler":this.hooks.postHandler=z,this.hasPostHandlerHook=!0;break;case"onSend":this.hooks.onSend=z,this.hasOnSendHook=!0;break;case"onError":this.hooks.onError=z,this.hasOnError=!0;break;case"onClose":this.hooks.onClose=z;break;default:throw new Error(`Unknown hook type: ${F}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[F,z]of this.middlewares.entries())if(z.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest)this.hasOnReqHook=!0;if(this.hooks.preHandler)this.hasPreHandlerHook=!0;if(this.hooks.postHandler)this.hasPostHandlerHook=!0;if(this.hooks.onSend)this.hasOnSendHook=!0;if(this.hooks.onError)this.hasOnError=!0;this.tempRoutes=new Map}listen(...F){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let z=3000,G="0.0.0.0",J=void 0,L={};for(let X of F)if(typeof X==="number")z=X;else if(typeof X==="string")G=X;else if(typeof X==="function")J=X;else if(typeof X==="object"&&X!==null)L=X;this.compile();let U={port:z,hostname:G,fetch:async(X,_)=>{let $=new URL(X.url);try{return await B(X,_,$,this)}catch(W){if(this.hasOnError&&this.hooks.onError){let Y=await this.hooks.onError(W,X,$,_);if(Y)return Y}return new Response(JSON.stringify({message:"Internal Server Error",error:W.message}),{status:500})}}};if(L.sslCert&&L.sslKey)U.certFile=L.sslCert,U.keyFile=L.sslKey;let Z=Bun?.serve(U);if(J)return J();if(L.sslCert&&L.sslKey)console.log(`HTTPS server is running on https://localhost:${z}`);else console.log(`HTTP server is running on http://localhost:${z}`);return Z}route(F,z){if(!F||typeof F!=="string")throw new Error("Path must be a string");let G=Object.fromEntries(z.tempRoutes);return Object.entries(G).forEach(([L,U])=>{let Z=`${F}${L}`;if(!this.middlewares.has(Z))this.middlewares.set(Z,[]);U.handlers.slice(0,-1).forEach((W)=>{if(!this.middlewares.get(Z)?.includes(W))this.middlewares.get(Z)?.push(W)});let _=U.handlers[U.handlers.length-1],$=U.method;try{this.trie.insert(Z,{handler:_,method:$})}catch(W){console.error(`Error inserting ${Z}:`,W)}}),z=null,this}register(F,z){return this.route(F,z),this}addRoute(F,z,G){if(typeof z!=="string")throw new Error(`Error in ${G[G.length-1]}: Path must be a string. Received: ${typeof z}`);if(typeof F!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof F}`);this.tempRoutes.set(z,{method:F,handlers:G});let J=G.slice(0,-1),L=G[G.length-1];if(!this.middlewares.has(z))this.middlewares.set(z,[]);J.forEach((U)=>{if(z==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...J])];else if(!this.middlewares.get(z)?.includes(U))this.middlewares.get(z)?.push(U)});try{this.trie.insert(z,{handler:L,method:F})}catch(U){console.error(`Error inserting ${z}:`,U)}}use(F,...z){if(typeof F==="function"){if(!this.globalMiddlewares.includes(F))this.globalMiddlewares.push(F);z.forEach((J)=>{if(!this.globalMiddlewares.includes(J))this.globalMiddlewares.push(J)});return}let G=F;if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(z)z.forEach((J)=>{if(!this.middlewares.get(G)?.includes(J))this.middlewares.get(G)?.push(J)});return this}get(F,...z){return this.addRoute("GET",F,z),this}post(F,...z){return this.addRoute("POST",F,z),this}put(F,...z){return this.addRoute("PUT",F,z),this}patch(F,...z){return this.addRoute("PATCH",F,z),this}delete(F,...z){return this.addRoute("DELETE",F,z),this}}export{j as default};
