class V{constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class M{constructor(){this.root=new V}insert(L,G){let E=this.root;const J=L.split("/").filter(Boolean);if(L==="/"){E.isEndOfWord=!0,E.handler.push(G.handler),E.path=L,E.method.push(G.method);return}for(let U of J){let X=!1,Y=U;if(U.startsWith(":"))X=!0,Y=":";if(!E.children[Y])E.children[Y]=new V;E=E.children[Y],E.isDynamic=X,E.pattern=U}E.isEndOfWord=!0,E.method.push(G.method),E.handler.push(G.handler),E.path=L}insertMidl(L){if(!this.root.subMiddlewares.has(L))this.root.subMiddlewares.set(L)}search(L,G){let E=this.root;const J=L.split("/").filter(Boolean);for(let X of J){let Y=X;if(!E.children[Y])if(E.children[":"])E=E.children[":"];else return null;else E=E.children[Y]}let U=E.method.indexOf(G);if(U!==-1)return{path:E.path,handler:E.handler[U],isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[U]};return{path:E.path,handler:E.handler,isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[U]}}getAllRoutes(){const L=[],G=(E,J)=>{if(E.isEndOfWord)L.push({path:J,handler:E.handler,isImportant:E.isImportant,isDynamic:E.isDynamic,pattern:E.pattern});for(let U in E.children){const X=E.children[U],Y=J+(U===":"?"/:"+X.pattern:"/"+U);G(X,Y)}};return G(this.root,""),L}}async function K(L){const G={};if(!L)return G;return L.split(";").forEach((J)=>{const[U,X]=J.trim().split("=");G[U]=X.split(" ")[0]}),G}function I(L,G){const E={},J=L.split("/"),[U]=G.split("?"),X=U.split("/");if(J.length!==X.length)return null;return J.forEach((Y,$)=>{if(Y.startsWith(":")){const A=Y.slice(1);E[A]=X[$]}}),E}async function v(L){const G=L.headers.get("Content-Type")||"";if(!G)return{};try{if(G.startsWith("application/json"))return await L.json();if(G.startsWith("application/x-www-form-urlencoded")){const E=await L.text();return Object.fromEntries(new URLSearchParams(E))}if(G.startsWith("multipart/form-data")){const E=await L.formData();return C(E)}return new Response({error:"Unknown request body type"})}catch(E){return new Response({error:"Invalid request body format"})}}function C(L){const G={};for(let[E,J]of L.entries())G[E]=J;return G}function B(L,G){let E={},J={},U=!1,X=null,Y=null,$=null,A=null,F=200;return{req:L,url:G,next:()=>{},status(Z){return F=Z,this},async body(){if(!A)A=await v(L);return A},setHeader(Z,_){return E[Z]=_,this},set(Z,_){return J[Z]=_,this},get(Z){return J[Z]},setAuth(Z){return U=Z,this},getAuth(){return U},text(Z,_){if(_)F=_;return new Response(Z,{status:F,headers:E})},json(Z,_){if(_)F=_;return new Response(JSON.stringify(Z),{status:F,headers:{"Content-Type":"application/json",...E}})},html(Z,_){if(_)F=_;return new Response(Bun.file(Z),{status:F,headers:{...E}})},file(Z,_){if(_)F=_;return new Response(Bun.file(Z),{status:F,headers:{...E}})},redirect(Z,_){if(_)F=_;return new Response(null,{status:F,headers:{Location:Z,...E}})},getParams(Z){if(!$)$=I(L.routePattern,G.pathname);return Z?$[Z]:$},getQuery(Z){if(!X)X=Object.fromEntries(G.searchParams);return Z?X[Z]:X},async cookie(Z,_,z={}){let W=`${encodeURIComponent(Z)}=${encodeURIComponent(_)}`;if(z.maxAge)W+=`; Max-Age=${z.maxAge}`;if(z.expires)W+=`; Expires=${z.expires.toUTCString()}`;if(z.path)W+=`; Path=${z.path}`;if(z.domain)W+=`; Domain=${z.domain}`;if(z.secure)W+="; Secure";if(z.httpOnly)W+="; HttpOnly";if(z.sameSite)W+=`; SameSite=${z.sameSite}`;if(E["Set-Cookie"]){const D=Array.isArray(E["Set-Cookie"])?E["Set-Cookie"]:[E["Set-Cookie"]];D.push(W),E["Set-Cookie"]=D}else E["Set-Cookie"]=W;return this},async getCookie(Z){if(!Y)Y=await K(L.headers.get("cookie"));return Z?Y[Z]:Y}}}async function O(L,G){for(let E of L){const J=await E(G);if(J)return J}}function N(L){return new Response(`Route not found for ${L}`,{status:404})}function w(){return new Response("Method not allowed",{status:405})}function R(){return new Response("No response from handler",{status:204})}function P(){return new Response("Internal Server Error",{status:500})}async function Q(L,G,E){const J=B(L,G);if(E.hasOnReqHook)for(let X of E.hooks.onRequest)await X(J);if(E.hasMiddleware){const X=[...E.globalMiddlewares,...E.middlewares.get(G.pathname)||[]],Y=await O(X,J);if(Y)return Y}const U=E.trie.search(G.pathname,L.method);if(!U||!U.handler)return N(G.pathname);if(U.method!==L.method)return w();if(U.isDynamic)L.routePattern=U.path;if(E.hasPreHandlerHook)for(let X of E.hooks.preHandler){const Y=await X(J);if(Y)return Y}try{const X=await U.handler(J);if(E.hasPostHandlerHook)for(let Y of E.hooks.postHandler)await Y(J);if(E.hasOnSendHook)for(let Y of E.hooks.onSend){const $=await Y(X,J);if($)return $}return X??R()}catch(X){return P()}}class T{constructor(){this.routes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new M,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[]}}addHooks(L,G){if(this.hooks[L])this.hooks[L].push(G);else throw new Error(`Unknown hook type: ${type}`)}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[L,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}if(this.hooks.onRequest.length>0)this.hasOnReqHook=!0;if(this.hooks.preHandler.length>0)this.hasPreHandlerHook=!0;if(this.hooks.postHandler.length>0)this.hasPostHandlerHook=!0;if(this.hooks.onSend.length>0)this.hasOnSendHook=!0}listen(L,{sslCert:G=null,sslKey:E=null}={},J){this.compile();const U={port:L,fetch:async(Y)=>{const $=new URL(Y.url);try{return await Q(Y,$,this)}catch(A){return new Response("Internal Server Error",{status:500})}},onClose(){console.log("Server is shutting down...")}};if(G&&E)U.certFile=G,U.keyFile=E;const X=Bun.serve(U);if(typeof J==="function")return J();if(G&&E)console.log(`HTTPS server is running on https://localhost:${L}`);else console.log(`HTTP server is running on http://localhost:${L}`);return X}register(L,G){const E=Object.entries(G.trie.root.children);G.trie.root.subMiddlewares.forEach((J,U)=>{if(!this.middlewares.has(L+U))this.middlewares.set(L+U,[]);if(!this.middlewares.get(L+U).includes(...J))this.middlewares.get(L+U).push(...J)});for(let[J,U]of E){const X=L+U?.path,Y=U.handler[0],$=U.method[0];this.trie.insert(X,{handler:Y,method:$})}G.trie=new M}#E(L,G,E){const J=E.slice(0,-1);if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(G==="/")J.forEach((X)=>{if(!this.globalMiddlewares.includes(X))this.globalMiddlewares.push(X)});else if(!this.middlewares.get(G).includes(...J))this.middlewares.get(G).push(...J);const U=E[E.length-1];this.trie.insert(G,{handler:U,method:L})}use(L,G){if(typeof L==="function"){if(!this.globalMiddlewares.includes(L))return this.globalMiddlewares.push(L)}const E=L;if(!this.middlewares.has(E))this.middlewares.set(E,[]);if(!this.middlewares.get(E).includes(G))this.middlewares.get(E).push(G)}get(L,...G){return this.#E("GET",L,G)}post(L,...G){return this.#E("POST",L,G)}put(L,...G){return this.#E("PUT",L,G)}patch(L,...G){if(G.length>0)return this.#E("PATCH",L,G)}delete(L,...G){return this.#E("DELETE",L,G)}}var b=T;class j extends b{constructor(){super()}#E(L,G,E){if(!this.trie.root.subMiddlewares.has(G))this.trie.root.subMiddlewares.set(G,[]);const J=E.slice(0,-1);if(!this.trie.root.subMiddlewares.get(G).includes(...J))this.trie.root.subMiddlewares.get(G).push(...J);const U=E[E.length-1];this.trie.insert(G,{handler:U,method:L})}get(L,...G){return this.#E("GET",L,G)}post(L,...G){return this.#E("POST",L,G)}put(L,...G){return this.#E("PUT",L,G)}patch(L,...G){if(G.length>0)return this.#E("PATCH",L,G)}delete(L,...G){return this.#E("DELETE",L,G)}}var c=j;export{c as default};
