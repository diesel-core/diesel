class M{constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isImportant=!1,this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class A{constructor(){this.root=new M}insert(L,G){let E=this.root;const U=L.split("/").filter(Boolean);if(L==="/"){E.isEndOfWord=!0,E.handler.push(G.handler),E.isImportant=G.isImportant,E.path=L,E.method.push(G.method);return}for(let J of U){let X=!1,Z=J;if(J.startsWith(":"))X=!0,Z=":";if(!E.children[Z])E.children[Z]=new M;E=E.children[Z],E.isDynamic=X,E.pattern=J}E.isEndOfWord=!0,E.method.push(G.method),E.handler.push(G.handler),E.isImportant=G.isImportant,E.path=L}insertMidl(L){if(!this.root.subMiddlewares.has(L))this.root.subMiddlewares.set(L)}search(L,G){let E=this.root;const U=L.split("/").filter(Boolean);for(let X of U){let Z=X;if(!E.children[Z])if(E.children[":"])E=E.children[":"];else return null;else E=E.children[Z]}let J=E.method.indexOf(G);if(J!==-1)return{path:E.path,handler:E.handler[J],isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[J]};return{path:E.path,handler:E.handler,isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[J]}}getAllRoutes(){const L=[],G=(E,U)=>{if(E.isEndOfWord)L.push({path:U,handler:E.handler,isImportant:E.isImportant,isDynamic:E.isDynamic,pattern:E.pattern});for(let J in E.children){const X=E.children[J],Z=U+(J===":"?"/:"+X.pattern:"/"+J);G(X,Z)}};return G(this.root,""),L}}async function j(L){const G={};if(!L)return G;return L.split(";").forEach((U)=>{const[J,X]=U.trim().split("=");G[J]=X.split(" ")[0]}),G}async function C(L,G){const E={},U=L.split("/"),[J]=G.split("?"),X=J.split("/");if(U.length!==X.length)return null;return U.forEach((Z,$)=>{if(Z.startsWith(":")){const W=Z.slice(1);E[W]=X[$]}}),E}async function O(L){const G=L.headers.get("Content-Type");if(G.includes("application/json"))try{return await L.json()}catch(E){return new Response({error:"Invalid JSON format"})}else if(G.startsWith("application/x-www-form-urlencoded")){const E=await L.text();return Object.fromEntries(new URLSearchParams(E))}else if(G.startsWith("multipart/form-data")){const E=await L.formData();return I(E)}else return new Response({error:"unknown request body"})}function I(L){const G={};for(let[E,U]of L.entries())G[E]=U;return G}function V(L,G){let E={},U={},J=!1,X=null,Z=null,$=null,W=null,F=200;return{req:L,url:G,next:()=>{},status(Y){return F=Y,this},async body(){if(!W)W=await O(L);return W},setHeader(Y,_){return E[Y]=_,this},set(Y,_){return U[Y]=_,this},get(Y){return U[Y]},setAuth(Y){return J=Y,this},getAuth(){return J},text(Y,_){if(_)F=_;return new Response(Y,{status:F,headers:E})},json(Y,_){if(_)F=_;return new Response(JSON.stringify(Y),{status:F,headers:{"Content-Type":"application/json",...E}})},html(Y,_){if(_)F=_;return new Response(Bun.file(Y),{status:F,headers:{...E}})},file(Y,_){if(_)F=_;return new Response(Bun.file(Y),{status:F,headers:{...E}})},redirect(Y,_){if(_)F=_;return new Response(null,{status:F,headers:{Location:Y,...E}})},async getParams(Y){if(!$)$=await C(L.routePattern,G.pathname);return Y?$[Y]:$},getQuery(Y){if(!X)X=Object.fromEntries(G.searchParams.entries());return Y?X[Y]:X},cookie(Y,_,z={}){let K=`${encodeURIComponent(Y)}=${encodeURIComponent(_)}`;if(z.maxAge)K+=`; Max-Age=${z.maxAge}`;if(z.expires)K+=`; Expires=${z.expires.toUTCString()}`;if(z.path)K+=`; Path=${z.path}`;if(z.domain)K+=`; Domain=${z.domain}`;if(z.secure)K+="; Secure";if(z.httpOnly)K+="; HttpOnly";if(z.sameSite)K+=`; SameSite=${z.sameSite}`;if(E["Set-Cookie"]){const Q=Array.isArray(E["Set-Cookie"])?E["Set-Cookie"]:[E["Set-Cookie"]];Q.push(K),E["Set-Cookie"]=Q}else E["Set-Cookie"]=K;return this},async getCookie(Y){if(!Z)Z=await j(L.headers.get("cookie"));return Y?Z[Y]:Z}}}async function v(L,G){for(let E of L){const U=await E(G);if(U)return U}}function N(L){return new Response(`Route not found for ${L}`,{status:404})}function f(){return new Response("Method not allowed",{status:405})}function w(){return new Response("No response from handler",{status:204})}function R(){return new Response("Internal Server Error",{status:500})}async function B(L,G,E){const{pathname:U}=G,{method:J}=L,X=E.trie.search(U,J);if(!X||!X.handler)return N(U);if(X.method!==J)return f();if(X.isDynamic)L.routePattern=X.path;const Z=V(L,G);if(E.hasMiddleware){const $=[...E.globalMiddlewares,...E.middlewares.get(U)||[]],W=await v($,Z);if(W)return W}try{return await X.handler(Z)??w()}catch($){return R()}}class T{constructor(){this.routes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new A,this.hasMiddleware=!1}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[L,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}}listen(L,G){this.compile();const E=Bun.serve({port:L,fetch:async(U)=>{const J=new URL(U.url);try{return await B(U,J,this)}catch(X){return new Response("Internal Server Error",{status:500})}},onClose(){console.log("Server is shutting down...")}});if(typeof G==="function")return G();return console.log(`Server is running on http://localhost:${L}`),E}register(L,G){const E=Object.entries(G.trie.root.children);G.trie.root.subMiddlewares.forEach((U,J)=>{if(!this.middlewares.has(L+J))this.middlewares.set(L+J,[]);if(!this.middlewares.get(L+J).includes(...U))this.middlewares.get(L+J).push(...U)});for(let[U,J]of E){const X=L+J?.path,Z=J.handler[0],$=J.method[0];this.trie.insert(X,{handler:Z,method:$})}G.trie=new A}#E(L,G,E){const U=E.slice(0,-1);if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(G==="/")U.forEach((X)=>{if(!this.globalMiddlewares.includes(X))this.globalMiddlewares.push(X)});else if(!this.middlewares.get(G).includes(...U))this.middlewares.get(G).push(...U);const J=E[E.length-1];this.trie.insert(G,{handler:J,method:L})}use(L,G){if(typeof L==="function"){if(!this.globalMiddlewares.includes(L))return this.globalMiddlewares.push(L)}const E=L;if(!this.middlewares.has(E))this.middlewares.set(E,[]);if(!this.middlewares.get(E).includes(G))this.middlewares.get(E).push(G)}get(L,...G){return this.#E("GET",L,G)}post(L,...G){return this.#E("POST",L,G)}put(L,...G){return this.#E("PUT",L,G)}patch(L,...G){if(G.length>0)return this.#E("PATCH",L,G)}delete(L,...G){return this.#E("DELETE",L,G)}}var D=T;class b extends D{constructor(){super()}#E(L,G,E){if(!this.trie.root.subMiddlewares.has(G))this.trie.root.subMiddlewares.set(G,[]);const U=E.slice(0,-1);if(!this.trie.root.subMiddlewares.get(G).includes(...U))this.trie.root.subMiddlewares.get(G).push(...U);const J=E[E.length-1];this.trie.insert(G,{handler:J,method:L})}get(L,...G){return this.#E("GET",L,G)}post(L,...G){return this.#E("POST",L,G)}put(L,...G){return this.#E("PUT",L,G)}patch(L,...G){if(G.length>0)return this.#E("PATCH",L,G)}delete(L,...G){return this.#E("DELETE",L,G)}}var m=b;export{m as default};
