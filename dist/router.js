class V{constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[],this.subMiddlewares=new Map}}class M{constructor(){this.root=new V}insert(L,G){let E=this.root;const J=L.split("/").filter(Boolean);if(L==="/"){E.isEndOfWord=!0,E.handler.push(G.handler),E.path=L,E.method.push(G.method);return}for(let U of J){let X=!1,Z=U;if(U.startsWith(":"))X=!0,Z=":";if(!E.children[Z])E.children[Z]=new V;E=E.children[Z],E.isDynamic=X,E.pattern=U}E.isEndOfWord=!0,E.method.push(G.method),E.handler.push(G.handler),E.path=L}insertMidl(L){if(!this.root.subMiddlewares.has(L))this.root.subMiddlewares.set(L)}search(L,G){let E=this.root;const J=L.split("/").filter(Boolean);for(let X of J){let Z=X;if(!E.children[Z])if(E.children[":"])E=E.children[":"];else return null;else E=E.children[Z]}let U=E.method.indexOf(G);if(U!==-1)return{path:E.path,handler:E.handler[U],isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[U]};return{path:E.path,handler:E.handler,isDynamic:E.isDynamic,pattern:E.pattern,method:E.method[U]}}getAllRoutes(){const L=[],G=(E,J)=>{if(E.isEndOfWord)L.push({path:J,handler:E.handler,isImportant:E.isImportant,isDynamic:E.isDynamic,pattern:E.pattern});for(let U in E.children){const X=E.children[U],Z=J+(U===":"?"/:"+X.pattern:"/"+U);G(X,Z)}};return G(this.root,""),L}}async function K(L){const G={};if(!L)return G;return L.split(";").forEach((J)=>{const[U,X]=J.trim().split("=");G[U]=X.split(" ")[0]}),G}async function O(L,G){const E={},J=L.split("/"),[U]=G.split("?"),X=U.split("/");if(J.length!==X.length)return null;return J.forEach((Z,$)=>{if(Z.startsWith(":")){const W=Z.slice(1);E[W]=X[$]}}),E}async function I(L){const G=L.headers.get("Content-Type")||"";if(!G)return{};try{if(G.startsWith("application/json"))return await L.json();if(G.startsWith("application/x-www-form-urlencoded")){const E=await L.text();return Object.fromEntries(new URLSearchParams(E))}if(G.startsWith("multipart/form-data")){const E=await L.formData();return v(E)}return new Response({error:"Unknown request body type"})}catch(E){return new Response({error:"Invalid request body format"})}}function v(L){const G={};for(let[E,J]of L.entries())G[E]=J;return G}function B(L,G){let E={},J={},U=!1,X=null,Z=null,$=null,W=null,F=200;return{req:L,url:G,next:()=>{},status(Y){return F=Y,this},async body(){if(!W)W=await I(L);return W},setHeader(Y,_){return E[Y]=_,this},set(Y,_){return J[Y]=_,this},get(Y){return J[Y]},setAuth(Y){return U=Y,this},getAuth(){return U},text(Y,_){if(_)F=_;return new Response(Y,{status:F,headers:E})},json(Y,_){if(_)F=_;return new Response(JSON.stringify(Y),{status:F,headers:{"Content-Type":"application/json",...E}})},html(Y,_){if(_)F=_;return new Response(Bun.file(Y),{status:F,headers:{...E}})},file(Y,_){if(_)F=_;return new Response(Bun.file(Y),{status:F,headers:{...E}})},redirect(Y,_){if(_)F=_;return new Response(null,{status:F,headers:{Location:Y,...E}})},async getParams(Y){if(!$)$=await O(L.routePattern,G.pathname);return Y?$[Y]:$},getQuery(Y){if(!X)X=Object.fromEntries(G.searchParams.entries());return Y?X[Y]:X},async cookie(Y,_,z={}){let A=`${encodeURIComponent(Y)}=${encodeURIComponent(_)}`;if(z.maxAge)A+=`; Max-Age=${z.maxAge}`;if(z.expires)A+=`; Expires=${z.expires.toUTCString()}`;if(z.path)A+=`; Path=${z.path}`;if(z.domain)A+=`; Domain=${z.domain}`;if(z.secure)A+="; Secure";if(z.httpOnly)A+="; HttpOnly";if(z.sameSite)A+=`; SameSite=${z.sameSite}`;if(E["Set-Cookie"]){const D=Array.isArray(E["Set-Cookie"])?E["Set-Cookie"]:[E["Set-Cookie"]];D.push(A),E["Set-Cookie"]=D}else E["Set-Cookie"]=A;return this},async getCookie(Y){if(!Z)Z=await K(L.headers.get("cookie"));return Y?Z[Y]:Z}}}async function C(L,G){for(let E of L){const J=await E(G);if(J)return J}}function N(L){return new Response(`Route not found for ${L}`,{status:404})}function f(){return new Response("Method not allowed",{status:405})}function w(){return new Response("No response from handler",{status:204})}function R(){return new Response("Internal Server Error",{status:500})}async function Q(L,G,E){const{pathname:J}=G,{method:U}=L,X=E.trie.search(J,U);if(!X||!X.handler)return N(J);if(X.method!==U)return f();if(X.isDynamic)L.routePattern=X.path;const Z=B(L,G);if(E.hasMiddleware){const $=[...E.globalMiddlewares,...E.middlewares.get(J)||[]],W=await C($,Z);if(W)return W}try{return await X.handler(Z)??w()}catch($){return R()}}class T{constructor(){this.routes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new M,this.hasMiddleware=!1}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[L,G]of this.middlewares.entries())if(G.length>0){this.hasMiddleware=!0;break}}listen(L,{sslCert:G=null,sslKey:E=null}={},J){this.compile();const U={port:L,fetch:async(Z)=>{const $=new URL(Z.url);try{return await Q(Z,$,this)}catch(W){return new Response("Internal Server Error",{status:500})}},onClose(){console.log("Server is shutting down...")}};if(G&&E)U.certFile=G,U.keyFile=E;const X=Bun.serve(U);if(typeof J==="function")return J();if(G&&E)console.log(`HTTPS server is running on https://localhost:${L}`);else console.log(`HTTP server is running on http://localhost:${L}`);return X}register(L,G){const E=Object.entries(G.trie.root.children);G.trie.root.subMiddlewares.forEach((J,U)=>{if(!this.middlewares.has(L+U))this.middlewares.set(L+U,[]);if(!this.middlewares.get(L+U).includes(...J))this.middlewares.get(L+U).push(...J)});for(let[J,U]of E){const X=L+U?.path,Z=U.handler[0],$=U.method[0];this.trie.insert(X,{handler:Z,method:$})}G.trie=new M}#E(L,G,E){const J=E.slice(0,-1);if(!this.middlewares.has(G))this.middlewares.set(G,[]);if(G==="/")J.forEach((X)=>{if(!this.globalMiddlewares.includes(X))this.globalMiddlewares.push(X)});else if(!this.middlewares.get(G).includes(...J))this.middlewares.get(G).push(...J);const U=E[E.length-1];this.trie.insert(G,{handler:U,method:L})}use(L,G){if(typeof L==="function"){if(!this.globalMiddlewares.includes(L))return this.globalMiddlewares.push(L)}const E=L;if(!this.middlewares.has(E))this.middlewares.set(E,[]);if(!this.middlewares.get(E).includes(G))this.middlewares.get(E).push(G)}get(L,...G){return this.#E("GET",L,G)}post(L,...G){return this.#E("POST",L,G)}put(L,...G){return this.#E("PUT",L,G)}patch(L,...G){if(G.length>0)return this.#E("PATCH",L,G)}delete(L,...G){return this.#E("DELETE",L,G)}}var b=T;class j extends b{constructor(){super()}#E(L,G,E){if(!this.trie.root.subMiddlewares.has(G))this.trie.root.subMiddlewares.set(G,[]);const J=E.slice(0,-1);if(!this.trie.root.subMiddlewares.get(G).includes(...J))this.trie.root.subMiddlewares.get(G).push(...J);const U=E[E.length-1];this.trie.insert(G,{handler:U,method:L})}get(L,...G){return this.#E("GET",L,G)}post(L,...G){return this.#E("POST",L,G)}put(L,...G){return this.#E("PUT",L,G)}patch(L,...G){if(G.length>0)return this.#E("PATCH",L,G)}delete(L,...G){return this.#E("DELETE",L,G)}}var m=j;export{m as default};
