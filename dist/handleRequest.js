function J(l){let{time:R=60000,max:h=100,message:n="Rate limit exceeded. Please try again later."}=l,w=new Map;return(c)=>{let u=new Date,N=c.ip;if(!w.has(N))w.set(N,{count:0,startTime:u});let F=w.get(N);if(F)if(u-F.startTime>R)F.count=1,F.startTime=u;else F.count++;if(F&&F.count>h)return c.json({error:n},429)}}function C(l){switch(l.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var E=(l,R,h,n)=>{if(h>n)return!1;let w=h+(n-h)/2;if(l[w]==R)return!0;if(l[w]>R)return E(l,R,h,w-1);return E(l,R,w+1,n)};function $(l,R,h){let n=new Headers({"Cache-Control":"no-cache"}),w=null,c=null,u=null,N=null,F={};return{req:l,server:R,url:h,setHeader(f,M){return n.set(f,M),this},removeHeader(f){return n.delete(f),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!w)try{w=Object.fromEntries(this.url.searchParams)}catch(f){throw new Error("Failed to parse query parameters")}return w},get params(){if(!c&&this.req.routePattern)try{c=O(this.req.routePattern,this.url.pathname)}catch(f){throw new Error("Failed to extract route parameters")}return c??{}},get body(){if(!N)N=(async()=>{let f=await j(this.req);if(f.error)throw new Error(f.error);return Object.keys(f).length===0?null:f})();return N},set(f,M){return F[f]=M,this},get(f){return F[f]},text(f,M=200){if(!n.has("Content-Type"))n.set("Content-Type","text/plain; charset=utf-8");return new Response(f,{status:M,headers:n})},send(f,M=200){let x=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),H=f instanceof Uint8Array?"Uint8Array":f instanceof ArrayBuffer?"ArrayBuffer":typeof f;if(!n.has("Content-Type"))n.set("Content-Type",x.get(H)??"text/plain; charset=utf-8");let i=H==="object"&&f!==null?JSON.stringify(f):f;return new Response(i,{status:M,headers:n})},json(f,M=200){if(!n.has("Content-Type"))n.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(f),{status:M,headers:n})},file(f,M=200,x){let H=Bun.file(f);if(!n.has("Content-Type"))n.set("Content-Type",x??C(f));return new Response(H,{status:M,headers:n})},redirect(f,M=302){return n.set("Location",f),new Response(null,{status:M,headers:n})},setCookie(f,M,x={}){let H=`${encodeURIComponent(f)}=${encodeURIComponent(M)}`;if(x.maxAge)H+=`; Max-Age=${x.maxAge}`;if(x.expires)H+=`; Expires=${x.expires.toUTCString()}`;if(x.path)H+=`; Path=${x.path}`;if(x.domain)H+=`; Domain=${x.domain}`;if(x.secure)H+="; Secure";if(x.httpOnly)H+="; HttpOnly";if(x.sameSite)H+=`; SameSite=${x.sameSite}`;return n.append("Set-Cookie",H),this},get cookies(){if(!u){let f=this.req.headers.get("cookie");u=f?L(f):{}}return u}}}function L(l){return Object.fromEntries(l.split(";").map((R)=>{let[h,...n]=R.trim().split("=");return[h,decodeURIComponent(n.join("="))]}))}function O(l,R){let h={},n=l.split("/"),[w]=R.split("?"),c=w.split("/");if(n.length!==c.length)return null;for(let u=0;u<n.length;u++)if(n[u].startsWith(":"))h[n[u].slice(1)]=c[u];return h}async function j(l){let R=l.headers.get("Content-Type");if(!R)return{};if(l.headers.get("Content-Length")==="0"||!l.body)return{};try{if(R.startsWith("application/json"))return await l.json();if(R.startsWith("application/x-www-form-urlencoded")){let n=await l.text();return Object.fromEntries(new URLSearchParams(n))}if(R.startsWith("multipart/form-data")){let n=await l.formData(),w={};for(let[c,u]of n.entries())w[c]=u;return w}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function z(l,R,h,n){let w=$(l,R,h),c=n.trie.search(h.pathname,l.method);if(l.routePattern=c?.path,n.hasFilterEnabled){let F=l.routePattern??h.pathname,f=await A(n,F,w,R);if(f)return f}if(n.hasMiddleware){let F=await T(n.globalMiddlewares,w,R);if(F)return F;let f=n.middlewares.get(h.pathname)||[],M=await T(f,w,R);if(M)return M}if(!c?.handler||c.method!==l.method){if(n.staticPath){let F=await G(n,h.pathname,w);if(F)return F;let f=n.trie.search("*",l.method);if(f?.handler)return await f.handler(w)}if(n.hooks.routeNotFound&&!c?.handler){let F=await n.hooks.routeNotFound(w);if(F)return F}if(!c||!c?.handler?.length)return o(404,`Route not found for ${h.pathname}`);return o(405,"Method not allowed")}if(n.hooks.preHandler){let F=await n.hooks.preHandler(w);if(F)return F}let u=c.handler(w),N=u instanceof Promise?await u:u;if(n.hooks.postHandler)await n.hooks.postHandler(w);if(n.hooks.onSend){let F=await n.hooks.onSend(w,N);if(F)return F}return N??o(204,"No response from this handler")}async function T(l,R,h){for(let n of l){let w=await n(R,h);if(w)return w}return null}async function A(l,R,h,n){if(!l.filters.has(R))if(l.filterFunction.length)for(let w of l.filterFunction){let c=await w(h,n);if(c)return c}else return h.json({error:!0,message:"Protected route, authentication required",status:401},401)}function o(l,R){return new Response(JSON.stringify({error:!0,message:R,status:l}),{status:l,headers:{"Content-Type":"application/json"}})}async function G(l,R,h){if(!l.staticPath)return null;let n=`${l.staticPath}${R}`;if(await Bun.file(n).exists()){let c=C(n);return h.file(n,200,c)}return null}export{G as handleStaticFiles,A as handleFilterRequest,o as generateErrorResponse,z as default};
