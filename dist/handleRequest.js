function B(G){let{time:K=60000,max:L=100,message:z="Rate limit exceeded. Please try again later."}=G,J=new Map;return(X)=>{let Y=new Date,V=X.ip;if(!J.has(V))J.set(V,{count:0,startTime:Y});let O=J.get(V);if(O)if(Y-O.startTime>K)O.count=1,O.startTime=Y;else O.count++;if(O&&O.count>L)return X.json({error:z},429)}}function W(G){switch(G.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var E=(G,K,L,z)=>{if(L>z)return!1;let J=L+(z-L)/2;if(G[J]==K)return!0;if(G[J]>K)return E(G,K,L,J-1);return E(G,K,J+1,z)};function j(G,K,L){let z=new Headers({"Cache-Control":"no-cache"}),J=null,X=null,Y=null,V=null,O={};return{req:G,server:K,url:L,setHeader(A,Z){return z.set(A,Z),this},removeHeader(A){return z.delete(A),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!J)try{J=Object.fromEntries(this.url.searchParams)}catch(A){throw new Error("Failed to parse query parameters")}return J},get params(){if(!X&&this.req.routePattern)try{X=F(this.req.routePattern,this.url.pathname)}catch(A){throw new Error("Failed to extract route parameters")}return X??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!V)V=(async()=>{let A=await C(this.req);if(A.error)throw new Error(A.error);return Object.keys(A).length===0?null:A})();return V},set(A,Z){return O[A]=Z,this},get(A){return O[A]},text(A,Z=200){if(!z.has("Content-Type"))z.set("Content-Type","text/plain; charset=utf-8");return new Response(A,{status:Z,headers:z})},send(A,Z=200){let $=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),U=A instanceof Uint8Array?"Uint8Array":A instanceof ArrayBuffer?"ArrayBuffer":typeof A;if(!z.has("Content-Type"))z.set("Content-Type",$.get(U)??"text/plain; charset=utf-8");let Q=U==="object"&&A!==null?JSON.stringify(A):A;return new Response(Q,{status:Z,headers:z})},json(A,Z=200){if(!z.has("Content-Type"))z.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(A),{status:Z,headers:z})},file(A,Z=200,$){let U=Bun.file(A);if(!z.has("Content-Type"))z.set("Content-Type",$??W(A));return new Response(U,{status:Z,headers:z})},redirect(A,Z=302){return z.set("Location",A),new Response(null,{status:Z,headers:z})},setCookie(A,Z,$={}){let U=`${encodeURIComponent(A)}=${encodeURIComponent(Z)}`;if($.maxAge)U+=`; Max-Age=${$.maxAge}`;if($.expires)U+=`; Expires=${$.expires.toUTCString()}`;if($.path)U+=`; Path=${$.path}`;if($.domain)U+=`; Domain=${$.domain}`;if($.secure)U+="; Secure";if($.httpOnly)U+="; HttpOnly";if($.sameSite)U+=`; SameSite=${$.sameSite}`;return z.append("Set-Cookie",U),this},get cookies(){if(!Y){let A=this.req.headers.get("cookie");Y=A?D(A):{}}return Y}}}function D(G){return Object.fromEntries(G.split(";").map((K)=>{let[L,...z]=K.trim().split("=");return[L,decodeURIComponent(z.join("="))]}))}function F(G,K){let L={},z=G.split("/"),[J]=K.split("?"),X=J.split("/");if(z.length!==X.length)return null;for(let Y=0;Y<z.length;Y++)if(z[Y].startsWith(":"))L[z[Y].slice(1)]=X[Y];return L}async function C(G){let K=G.headers.get("Content-Type");if(!K)return{};if(G.headers.get("Content-Length")==="0"||!G.body)return{};try{if(K.startsWith("application/json"))return await G.json();if(K.startsWith("application/x-www-form-urlencoded")){let z=await G.text();return Object.fromEntries(new URLSearchParams(z))}if(K.startsWith("multipart/form-data")){let z=await G.formData(),J={};for(let[X,Y]of z.entries())J[X]=Y;return J}return{error:"Unknown request body type"}}catch(z){return{error:"Invalid request body format"}}}async function b(G,K,L,z){let J=j(G,K,L),X=z.trie.search(L.pathname,G.method);if(G.routePattern=X?.path,z.hasFilterEnabled){let O=G.routePattern??L.pathname,A=await I(z,O,J,K);if(A)return A}if(z.hasMiddleware){let O=await N(z.globalMiddlewares,J,K);if(O)return O;let A=z.middlewares.get(L.pathname)||[],Z=await N(A,J,K);if(Z)return Z}if(!X?.handler||X.method!==G.method){if(z.staticPath){let O=await M(z,L.pathname,J);if(O)return O;let A=z.trie.search("*",G.method);if(A?.handler)return await A.handler(J)}if(z.hooks.routeNotFound&&!X?.handler){let O=await z.hooks.routeNotFound(J);if(O)return O}if(!X||!X?.handler?.length)return _(404,`Route not found for ${L.pathname}`);if(X?.method!==G.method)return _(405,"Method not allowed")}if(z.hooks.preHandler){let O=await z.hooks.preHandler(J);if(O)return O}let Y=X.handler(J),V=Y instanceof Promise?await Y:Y;if(z.hooks.postHandler)await z.hooks.postHandler(J);if(z.hooks.onSend){let O=await z.hooks.onSend(J,V);if(O)return O}return V??_(204,"No response from this handler")}async function N(G,K,L){for(let z of G){let J=await z(K,L);if(J)return J}return null}async function I(G,K,L,z){if(!G.filters.has(K))if(G.filterFunction.length)for(let J of G.filterFunction){let X=await J(L,z);if(X)return X}else return L.json({error:!0,message:"Protected route, authentication required",status:401},401)}function _(G,K){return new Response(JSON.stringify({error:!0,message:K,status:G}),{status:G,headers:{"Content-Type":"application/json"}})}async function M(G,K,L){if(!G.staticPath)return null;let z=`${G.staticPath}${K}`;if(await Bun.file(z).exists()){let X=W(z);return L.file(z,200,X)}return null}export{M as handleStaticFiles,I as handleFilterRequest,_ as generateErrorResponse,b as default};
