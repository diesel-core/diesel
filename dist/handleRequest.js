var b=Object.create;var{getPrototypeOf:z,defineProperty:$,getOwnPropertyNames:G}=Object;var K=Object.prototype.hasOwnProperty;var X=(h,R,o)=>{o=h!=null?b(z(h)):{};let n=R||!h||!h.__esModule?$(o,"default",{value:h,enumerable:!0}):o;for(let r of G(h))if(!K.call(n,r))$(n,r,{get:()=>h[r],enumerable:!0});return n};var Y=((h)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(h,{get:(R,o)=>(typeof require!=="undefined"?require:R)[o]}):h)(function(h){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+h+'" is not supported')});function Z(h){let{time:R=60000,max:o=100,message:n="Rate limit exceeded. Please try again later."}=h,r=new Map;return(F)=>{let A=new Date,E=F.ip;if(!r.has(E))r.set(E,{count:0,startTime:A});let f=r.get(E);if(f)if(A-f.startTime>R)f.count=1,f.startTime=A;else f.count++;if(f&&f.count>o)return F.json({error:n},429)}}function g(h){switch(h.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function S(h,R){if(!h)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(o)=>{try{let n=o.cookies?.accessToken||o.req?.headers?.get("Authorization");if(!n)return o.json({message:"Unauthorized: No token provided"},401);if(n.startsWith("Bearer "))n=n.slice(7);let r=h?.verify(n,R);if(!r)return o.json({message:"Unauthorized: Invalid token"},401);o.set("user",r);return}catch(n){return o.json({message:"Unauthorized: Invalid token",error:n?.message},401)}}}function B(h,R,o){if(!h)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!R)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(n)=>{try{let r=n.cookies?.accessToken||n.req?.headers?.get("Authorization");if(!r)return n.json({message:"Unauthorized: No token provided"},401);if(r.startsWith("Bearer "))r=r.slice(7);let F=h?.verify(r,o);if(!F)return n.json({message:"Unauthorized: Invalid token"},401);let A=await R.findById(F._id).select("-password -refreshToken");if(!A)return n.json({message:"Unauthorized: User not found"},401);n.set("user",A);return}catch(r){return n.json({message:"Unauthorized: Authentication failed",error:r?.message},401)}}}function C(h,R,o){let n=null,r=null,F=null,A=null,E={};return{req:h,server:R,url:o,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(f,l){return this.headers.set(f,l),this},removeHeader(f){return this.headers.delete(f),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!n)try{n=Object.fromEntries(this.url.searchParams)}catch(f){throw new Error("Failed to parse query parameters")}return n},get params(){if(!r&&this.req.routePattern)try{r=T(this.req.routePattern,this.url.pathname)}catch(f){throw new Error("Failed to extract route parameters")}return r??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!A)A=(async()=>{let f=await V(this.req);if(f.error)throw new Error(f.error);return Object.keys(f).length===0?null:f})();return A},set(f,l){return E[f]=l,this},get(f){return E[f]},text(f,l){if(l)this.status=l;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(f,{status:this.status,headers:this.headers})},send(f,l){if(l)this.status=l;let H=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),w=f instanceof Uint8Array?"Uint8Array":f instanceof ArrayBuffer?"ArrayBuffer":typeof f;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",H.get(w)??"text/plain; charset=utf-8");let N=w==="object"&&f!==null?JSON.stringify(f):f;return new Response(N,{status:this.status,headers:this.headers})},json(f,l){if(l)this.status=l;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(f),{status:this.status,headers:this.headers})},file(f,l,H){if(H)this.status=H;let w=Bun.file(f);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",l??g(f));return new Response(w,{status:this.status,headers:this.headers})},async ejs(f,l={},H){if(H)this.status=H;let w;try{w=await import("ejs"),w=w.default||w}catch(N){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let N=await Bun.file(f).text(),L=w.render(N,l),O=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(L,{status:this.status,headers:O})}catch(N){return console.error("EJS Rendering Error:",N),new Response("Error rendering template",{status:500})}},redirect(f,l){if(l)this.status=l;else this.status=302;return this.headers.set("Location",f),new Response(null,{status:this.status,headers:this.headers})},setCookie(f,l,H={}){let w=`${encodeURIComponent(f)}=${encodeURIComponent(l)}`;if(H.maxAge)w+=`; Max-Age=${H.maxAge}`;if(H.expires)w+=`; Expires=${H.expires.toUTCString()}`;if(H.path)w+=`; Path=${H.path}`;if(H.domain)w+=`; Domain=${H.domain}`;if(H.secure)w+="; Secure";if(H.httpOnly)w+="; HttpOnly";if(H.sameSite)w+=`; SameSite=${H.sameSite}`;return this.headers.append("Set-Cookie",w),this},get cookies(){if(!F){let f=this.req.headers.get("cookie");F=f?m(f):{}}return F}}}function m(h){return Object.fromEntries(h.split(";").map((R)=>{let[o,...n]=R.trim().split("=");return[o,decodeURIComponent(n.join("="))]}))}function T(h,R){let o={},n=h.split("/"),[r]=R.split("?"),F=r.split("/");if(n.length!==F.length)return null;for(let A=0;A<n.length;A++)if(n[A].startsWith(":"))o[n[A].slice(1)]=F[A];return o}async function V(h){let R=h.headers.get("Content-Type");if(!R)return{};if(h.headers.get("Content-Length")==="0"||!h.body)return{};try{if(R.startsWith("application/json"))return await h.json();if(R.startsWith("application/x-www-form-urlencoded")){let n=await h.text();return Object.fromEntries(new URLSearchParams(n))}if(R.startsWith("multipart/form-data")){let n=await h.formData(),r={};for(let[F,A]of n.entries())r[F]=A;return r}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function y(h,R,o,n){let r=C(h,R,o),F=n.trie.search(o.pathname,h.method);h.routePattern=F?.path;try{if(n.hasFilterEnabled){let f=h.routePattern??o.pathname,l=await J(n,f,r,R);if(l)return l}if(n.hasMiddleware){if(n.globalMiddlewares.length){let l=await i(n.globalMiddlewares,r,R);if(l)return l}let f=n.middlewares.get(o.pathname)||[];if(f?.length){let l=await i(f,r,R);if(l)return l}}if(!F?.handler||F.method!==h.method){if(n.staticPath){let f=await W(n,o.pathname,r);if(f)return f;let l=n.trie.search("*",h.method);if(l?.handler)return await l.handler(r)}if(n.hooks.routeNotFound?.length&&Array.isArray(n.hooks.routeNotFound)&&!F?.handler)for(let f of n.hooks.routeNotFound){let l=await f(r);if(l)return l}if(!F||!F?.handler?.length)return M(404,`Route not found for ${o.pathname}`);if(F?.method!==h.method)return M(405,"Method not allowed")}if(n.hooks.preHandler?.length&&Array.isArray(n.hooks.preHandler))for(let f of n.hooks.preHandler){let l=await f(r);if(l)return l}let A=F.handler(r),E=A instanceof Promise?await A:A;if(n.hooks.onSend?.length&&Array.isArray(n.hooks.onSend))for(let f of n.hooks.onSend){let l=await f(r,E);if(l)return l}return E??M(204,"No response from this handler")}catch(A){return n.hooks.onError?.length&&Array.isArray(n.hooks.onError)?n.hooks.onError[0](A,h,o,R):M(500,"Internal Server Error")}finally{if(n.hooks.postHandler?.length&&Array.isArray(n.hooks.postHandler))for(let A of n.hooks.postHandler)await A(r)}}async function i(h,R,o){for(let n of h){console.log("middlewares: ",n);let r=await n(R,o);if(r)return r}return null}async function J(h,R,o,n){if(!h.filters.has(R))if(h.filterFunction.length)for(let r of h.filterFunction){let F=await r(o,n);if(F)return F}else return o.json({error:!0,message:"Protected route, authentication required",status:401},401)}function M(h,R){return new Response(JSON.stringify({error:!0,message:R,status:h}),{status:h,headers:{"Content-Type":"application/json"}})}async function W(h,R,o){if(!h.staticPath)return null;let n=`${h.staticPath}${R}`;if(await Bun.file(n).exists()){let F=g(n);return o.file(n,F,200)}return null}export{W as handleStaticFiles,J as handleFilterRequest,M as generateErrorResponse,y as default};
