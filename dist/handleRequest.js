var L=Object.create;var{getPrototypeOf:O,defineProperty:m,getOwnPropertyNames:b}=Object;var u=Object.prototype.hasOwnProperty;var z=(f,R,o)=>{o=f!=null?L(O(f)):{};let n=R||!f||!f.__esModule?m(o,"default",{value:f,enumerable:!0}):o;for(let l of b(f))if(!u.call(n,l))m(n,l,{get:()=>f[l],enumerable:!0});return n};var G=((f)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(f,{get:(R,o)=>(typeof require!=="undefined"?require:R)[o]}):f)(function(f){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+f+'" is not supported')});function E(f){switch(f.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function J(f,R){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(o)=>{try{let n=o.cookies?.accessToken||o.req?.headers?.get("Authorization");if(!n)return o.json({message:"Unauthorized: No token provided"},401);if(n.startsWith("Bearer "))n=n.slice(7);let l=f?.verify(n,R);if(!l)return o.json({message:"Unauthorized: Invalid token"},401);o.set("user",l);return}catch(n){return o.json({message:"Unauthorized: Invalid token",error:n?.message},401)}}}function W(f,R,o){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!R)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(n)=>{try{let l=n.cookies?.accessToken||n.req?.headers?.get("Authorization");if(!l)return n.json({message:"Unauthorized: No token provided"},401);if(l.startsWith("Bearer "))l=l.slice(7);let i=f?.verify(l,o);if(!i)return n.json({message:"Unauthorized: Invalid token"},401);let A=await R.findById(i._id).select("-password -refreshToken");if(!A)return n.json({message:"Unauthorized: User not found"},401);n.set("user",A);return}catch(l){return n.json({message:"Unauthorized: Authentication failed",error:l?.message},401)}}}function N(f,R,o){let n=null,l=null,i=null,A=null,w={};return{req:f,server:R,url:o,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(r,h){return this.headers.set(r,h),this},removeHeader(r){return this.headers.delete(r),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!n)try{n=Object.fromEntries(this.url.searchParams)}catch(r){throw new Error("Failed to parse query parameters")}return n},get params(){if(!l&&this.req.routePattern)try{l=K(this.req.routePattern,this.url.pathname)}catch(r){throw new Error("Failed to extract route parameters")}return l??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!A)A=(async()=>{let r=await X(this.req);if(r.error)throw new Error(r.error);return Object.keys(r).length===0?null:r})();return A},set(r,h){return w[r]=h,this},get(r){return w[r]},text(r,h){if(h)this.status=h;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(r,{status:this.status,headers:this.headers})},send(r,h){if(h)this.status=h;let F=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),g=r instanceof Uint8Array?"Uint8Array":r instanceof ArrayBuffer?"ArrayBuffer":typeof r;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",F.get(g)??"text/plain; charset=utf-8");let H=g==="object"&&r!==null?JSON.stringify(r):r;return new Response(H,{status:this.status,headers:this.headers})},json(r,h){if(h)this.status=h;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(r),{status:this.status,headers:this.headers})},file(r,h,F){if(F)this.status=F;let g=Bun.file(r);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",h??E(r));return new Response(g,{status:this.status,headers:this.headers})},async ejs(r,h={},F){if(F)this.status=F;let g;try{g=await import("ejs"),g=g.default||g}catch(H){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let H=await Bun.file(r).text(),$=g.render(H,h),T=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response($,{status:this.status,headers:T})}catch(H){return console.error("EJS Rendering Error:",H),new Response("Error rendering template",{status:500})}},redirect(r,h){if(h)this.status=h;else this.status=302;return this.headers.set("Location",r),new Response(null,{status:this.status,headers:this.headers})},setCookie(r,h,F={}){let g=`${encodeURIComponent(r)}=${encodeURIComponent(h)}`;if(F.maxAge)g+=`; Max-Age=${F.maxAge}`;if(F.expires)g+=`; Expires=${F.expires.toUTCString()}`;if(F.path)g+=`; Path=${F.path}`;if(F.domain)g+=`; Domain=${F.domain}`;if(F.secure)g+="; Secure";if(F.httpOnly)g+="; HttpOnly";if(F.sameSite)g+=`; SameSite=${F.sameSite}`;return this.headers.append("Set-Cookie",g),this},get cookies(){if(!i){let r=this.req.headers.get("cookie");i=r?I(r):{}}return i}}}function I(f){return Object.fromEntries(f.split(";").map((R)=>{let[o,...n]=R.trim().split("=");return[o,decodeURIComponent(n.join("="))]}))}function K(f,R){let o={},n=f.split("/"),[l]=R.split("?"),i=l.split("/");if(n.length!==i.length)return null;for(let A=0;A<n.length;A++)if(n[A].startsWith(":"))o[n[A].slice(1)]=i[A];return o}async function X(f){let R=f.headers.get("Content-Type");if(!R)return{};if(f.headers.get("Content-Length")==="0"||!f.body)return{};try{if(R.startsWith("application/json"))return await f.json();if(R.startsWith("application/x-www-form-urlencoded")){let n=await f.text();return Object.fromEntries(new URLSearchParams(n))}if(R.startsWith("multipart/form-data")){let n=await f.formData(),l={};for(let[i,A]of n.entries())l[i]=A;return l}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function Y(f,R,o,n){let l=N(f,R,o),i=n.trie.search(o.pathname,f.method);f.routePattern=i?.path;try{if(n.hasFilterEnabled){let r=f.routePattern??o.pathname,h=await Z(n,r,l,R);if(h)return h}if(n.hasMiddleware){if(n.globalMiddlewares.length){let h=await C(n.globalMiddlewares,l,R);if(h)return h}let r=n.middlewares.get(o.pathname)||[];if(r?.length){let h=await C(r,l,R);if(h)return h}}if(!i?.handler||i.method!==f.method){if(n.staticPath){let r=await V(n,o.pathname,l);if(r)return r;let h=n.trie.search("*",f.method);if(h?.handler)return await h.handler(l)}if(n.hooks.routeNotFound?.length&&Array.isArray(n.hooks.routeNotFound)&&!i?.handler){let r=n.hooks.routeNotFound;for(let h=0;h<r.length;h++){let F=await r[h](l);if(F)return F}}if(!i||!i?.handler?.length)return M(404,`Route not found for ${o.pathname}`);if(i?.method!==f.method)return M(405,"Method not allowed")}if(n.hooks.preHandler?.length&&Array.isArray(n.hooks.preHandler)){let r=n.hooks.preHandler;for(let h=0;h<r.length;h++){let F=await r[h](l);if(F)return F}}let A=i.handler(l),w=A instanceof Promise?await A:A;if(n.hooks.onSend?.length&&Array.isArray(n.hooks.onSend)){let r=n.hooks.onSend;for(let h=0;h<r.length;h++){let F=await r[h](l);if(F)return F}}return w??M(204,"No response from this handler")}catch(A){return n.hooks.onError?.length&&Array.isArray(n.hooks.onError)?n.hooks.onError[0](A,f,o,R):M(500,"Internal Server Error")}finally{if(n.hooks.postHandler?.length&&Array.isArray(n.hooks.postHandler)){let A=n.hooks.postHandler;for(let w=0;w<A.length;w++){let r=await A[w](l);if(r)return r}}}}async function C(f,R,o){for(let n of f){let l=await n(R,o);if(l)return l}return null}async function Z(f,R,o,n){if(!f.filters.has(R))if(f.filterFunction.length)for(let l of f.filterFunction){let i=await l(o,n);if(i)return i}else return o.json({error:!0,message:"Protected route, authentication required",status:401},401)}function M(f,R){return new Response(JSON.stringify({error:!0,message:R,status:f}),{status:f,headers:{"Content-Type":"application/json"}})}async function V(f,R,o){if(!f.staticPath)return null;let n=`${f.staticPath}${R}`;if(await Bun.file(n).exists()){let i=E(n);return o.file(n,i,200)}return null}export{V as handleStaticFiles,Z as handleFilterRequest,M as generateErrorResponse,Y as default};
