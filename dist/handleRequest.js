var j=Object.create;var{getPrototypeOf:C,defineProperty:Q,getOwnPropertyNames:b}=Object;var I=Object.prototype.hasOwnProperty;var M=(A,K,L)=>{L=A!=null?j(C(A)):{};let z=K||!A||!A.__esModule?Q(L,"default",{value:A,enumerable:!0}):L;for(let J of b(A))if(!I.call(z,J))Q(z,J,{get:()=>A[J],enumerable:!0});return z};var T=((A)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(A,{get:(K,L)=>(typeof require!=="undefined"?require:K)[L]}):A)(function(A){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+A+'" is not supported')});function H(A){let{time:K=60000,max:L=100,message:z="Rate limit exceeded. Please try again later."}=A,J=new Map;return(X)=>{let $=new Date,V=X.ip;if(!J.has(V))J.set(V,{count:0,startTime:$});let O=J.get(V);if(O)if($-O.startTime>K)O.count=1,O.startTime=$;else O.count++;if(O&&O.count>L)return X.json({error:z},429)}}function W(A){switch(A.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var B=(A,K,L,z)=>{if(L>z)return!1;let J=L+(z-L)/2;if(A[J]==K)return!0;if(A[J]>K)return B(A,K,L,J-1);return B(A,K,J+1,z)};function E(A,K,L){let z=new Headers({"Cache-Control":"no-cache"}),J=null,X=null,$=null,V=null,O={};return{req:A,server:K,url:L,setHeader(G,Z){return z.set(G,Z),this},removeHeader(G){return z.delete(G),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!J)try{J=Object.fromEntries(this.url.searchParams)}catch(G){throw new Error("Failed to parse query parameters")}return J},get params(){if(!X&&this.req.routePattern)try{X=S(this.req.routePattern,this.url.pathname)}catch(G){throw new Error("Failed to extract route parameters")}return X??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!V)V=(async()=>{let G=await P(this.req);if(G.error)throw new Error(G.error);return Object.keys(G).length===0?null:G})();return V},set(G,Z){return O[G]=Z,this},get(G){return O[G]},text(G,Z=200){if(!z.has("Content-Type"))z.set("Content-Type","text/plain; charset=utf-8");return new Response(G,{status:Z,headers:z})},send(G,Z=200){let Y=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),U=G instanceof Uint8Array?"Uint8Array":G instanceof ArrayBuffer?"ArrayBuffer":typeof G;if(!z.has("Content-Type"))z.set("Content-Type",Y.get(U)??"text/plain; charset=utf-8");let _=U==="object"&&G!==null?JSON.stringify(G):G;return new Response(_,{status:Z,headers:z})},json(G,Z=200){if(!z.has("Content-Type"))z.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(G),{status:Z,headers:z})},file(G,Z=200,Y){let U=Bun.file(G);if(!z.has("Content-Type"))z.set("Content-Type",Y??W(G));return new Response(U,{status:Z,headers:z})},async ejs(G,Z={}){let Y;try{Y=await import("ejs"),Y=Y.default||Y}catch(U){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let U=await Bun.file(G).text(),_=Y.render(U,Z),F=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(_,{status:200,headers:F})}catch(U){return console.error("EJS Rendering Error:",U),new Response("Error rendering template",{status:500})}},redirect(G,Z=302){return z.set("Location",G),new Response(null,{status:Z,headers:z})},setCookie(G,Z,Y={}){let U=`${encodeURIComponent(G)}=${encodeURIComponent(Z)}`;if(Y.maxAge)U+=`; Max-Age=${Y.maxAge}`;if(Y.expires)U+=`; Expires=${Y.expires.toUTCString()}`;if(Y.path)U+=`; Path=${Y.path}`;if(Y.domain)U+=`; Domain=${Y.domain}`;if(Y.secure)U+="; Secure";if(Y.httpOnly)U+="; HttpOnly";if(Y.sameSite)U+=`; SameSite=${Y.sameSite}`;return z.append("Set-Cookie",U),this},get cookies(){if(!$){let G=this.req.headers.get("cookie");$=G?w(G):{}}return $}}}function w(A){return Object.fromEntries(A.split(";").map((K)=>{let[L,...z]=K.trim().split("=");return[L,decodeURIComponent(z.join("="))]}))}function S(A,K){let L={},z=A.split("/"),[J]=K.split("?"),X=J.split("/");if(z.length!==X.length)return null;for(let $=0;$<z.length;$++)if(z[$].startsWith(":"))L[z[$].slice(1)]=X[$];return L}async function P(A){let K=A.headers.get("Content-Type");if(!K)return{};if(A.headers.get("Content-Length")==="0"||!A.body)return{};try{if(K.startsWith("application/json"))return await A.json();if(K.startsWith("application/x-www-form-urlencoded")){let z=await A.text();return Object.fromEntries(new URLSearchParams(z))}if(K.startsWith("multipart/form-data")){let z=await A.formData(),J={};for(let[X,$]of z.entries())J[X]=$;return J}return{error:"Unknown request body type"}}catch(z){return{error:"Invalid request body format"}}}async function R(A,K,L,z){let J=E(A,K,L),X=z.trie.search(L.pathname,A.method);if(A.routePattern=X?.path,z.hasFilterEnabled){let O=A.routePattern??L.pathname,G=await v(z,O,J,K);if(G)return G}if(z.hasMiddleware){let O=await D(z.globalMiddlewares,J,K);if(O)return O;let G=z.middlewares.get(L.pathname)||[],Z=await D(G,J,K);if(Z)return Z}if(!X?.handler||X.method!==A.method){if(z.staticPath){let O=await f(z,L.pathname,J);if(O)return O;let G=z.trie.search("*",A.method);if(G?.handler)return await G.handler(J)}if(z.hooks.routeNotFound&&!X?.handler){let O=await z.hooks.routeNotFound(J);if(O)return O}if(!X||!X?.handler?.length)return N(404,`Route not found for ${L.pathname}`);if(X?.method!==A.method)return N(405,"Method not allowed")}if(z.hooks.preHandler){let O=await z.hooks.preHandler(J);if(O)return O}let $=X.handler(J),V=$ instanceof Promise?await $:$;if(z.hooks.postHandler)await z.hooks.postHandler(J);if(z.hooks.onSend){let O=await z.hooks.onSend(J,V);if(O)return O}return V??N(204,"No response from this handler")}async function D(A,K,L){for(let z of A){let J=await z(K,L);if(J)return J}return null}async function v(A,K,L,z){if(!A.filters.has(K))if(A.filterFunction.length)for(let J of A.filterFunction){let X=await J(L,z);if(X)return X}else return L.json({error:!0,message:"Protected route, authentication required",status:401},401)}function N(A,K){return new Response(JSON.stringify({error:!0,message:K,status:A}),{status:A,headers:{"Content-Type":"application/json"}})}async function f(A,K,L){if(!A.staticPath)return null;let z=`${A.staticPath}${K}`;if(await Bun.file(z).exists()){let X=W(z);return L.file(z,200,X)}return null}export{f as handleStaticFiles,v as handleFilterRequest,N as generateErrorResponse,R as default};
