function W(G,E,I){let z=new Headers,J={},X=!1,L=null,Z=null,Y=null,K,M=200;return{req:G,server:E,url:I,next:()=>{},status(F){return M=F,this},getIP(){return this.server.requestIP(this.req)},async body(){if(!K)K=await j(G);if(K.error)return new Response(JSON.stringify({error:K.error}),{status:400});return K},setHeader(F,U){return z.set(F,U),this},set(F,U){return J[F]=U,this},get(F){return J[F]||null},setAuth(F){return X=F,this},getAuth(){return X},text(F,U){return new Response(F,{status:U??M,headers:z})},json(F,U){return new Response(JSON.stringify(F),{status:U??M,headers:z})},html(F,U){return new Response(Bun.file(F),{status:U??M,headers:z})},file(F,U){return new Response(Bun.file(F),{status:U??M,headers:z})},redirect(F,U){return z.set("Location",F),new Response(null,{status:U??302,headers:z})},getParams(F){if(!Y)Y=V(G?.routePattern,I?.pathname);return F?Y[F]||null:Y},getQuery(F){if(!L)L=Object.fromEntries(I.searchParams);return F?L[F]||null:L},async cookie(F,U,_={}){let $=`${encodeURIComponent(F)}=${encodeURIComponent(U)}`;if(_.maxAge)$+=`; Max-Age=${_.maxAge}`;if(_.expires)$+=`; Expires=${_.expires.toUTCString()}`;if(_.path)$+=`; Path=${_.path}`;if(_.domain)$+=`; Domain=${_.domain}`;if(_.secure)$+="; Secure";if(_.httpOnly)$+="; HttpOnly";if(_.sameSite)$+=`; SameSite=${_.sameSite}`;return z?.append("Set-Cookie",$),this},async getCookie(F){if(!Z){let U=G.headers.get("cookie");if(U)Z=await A(U)}return F?Z[F]||null:Z}}}async function A(G){let E={};if(!G)return E;return G.split(";").forEach((z)=>{let[J,X]=z?.trim()?.split("=");if(J&&X)E[J.trim()]=X.split(" ")[0].trim()}),E}function V(G,E){let I={},z=G.split("/"),[J]=E.split("?"),X=J.split("/");if(z.length!==X.length)return null;return z.forEach((L,Z)=>{if(L.startsWith(":")){let Y=L.slice(1);I[Y]=X[Z]}}),I}async function j(G){let E=G.headers.get("Content-Type")||"";if(!E)return{};try{if(E.startsWith("application/json"))return await G.json();if(E.startsWith("application/x-www-form-urlencoded")){let I=await G.text();return Object.fromEntries(new URLSearchParams(I))}if(E.startsWith("multipart/form-data")){let I=await G.formData();return D(I)}return{error:"Unknown request body type"}}catch(I){return{error:"Invalid request body format"}}}function D(G){let E={};for(let[I,z]of G.entries())E[I]=z;return E}async function Q(G,E,I,z){let J=W(G,E,I),X=z.trie.search(I.pathname,G.method);if(!X||!X.handler)return new Response(`Route not found for ${I.pathname}`,{status:404});if(X.method!==G.method)return new Response("Method not allowed",{status:405});if(X.isDynamic)G.routePattern=X.path;if(z.corsConfig){let L=await T(G,J,z.corsConfig);if(L)return L}if(z.hasOnReqHook&&z.hooks.onRequest)z.hooks.onRequest(J,E);if(z.filters.length>0){let L=G.routePattern??I.pathname;if(z.filters.includes(L)===!1)if(z.filterFunction){let Y=await z?.filterFunction(J);if(Y)return Y}else return new Response(JSON.stringify({message:"Authentication required"}),{status:400})}if(z.hasMiddleware){let L=[...z.globalMiddlewares,...z.middlewares.get(I.pathname)||[]];for(let Z of L){let Y=await Z(J,E);if(Y)return Y}}if(z.hasPreHandlerHook&&z.hooks.preHandler){let L=await z.hooks.preHandler(J);if(L)return L}try{let L=await X.handler(J);if(z.hasPostHandlerHook&&z.hooks.postHandler)await z.hooks.postHandler(J);if(z.hasOnSendHook&&z.hooks.onSend){let Z=await z.hooks.onSend(J,L);if(Z)return Z}return L??new Response("No response from handler",{status:204})}catch(L){return new Response("Internal Server Error",{status:500})}}async function T(G,E,I={}){let z=G.headers.get("origin")??"*",J=I?.origin,X=I?.allowedHeaders??["Content-Type","Authorization"],L=I?.methods??["GET","POST","PUT","DELETE","OPTIONS"],Z=I?.credentials??!1,Y=I?.exposedHeaders??[];if(E.setHeader("Access-Control-Allow-Methods",L),E.setHeader("Access-Control-Allow-Headers",X),E.setHeader("Access-Control-Allow-Credentials",Z),Y.length)E.setHeader("Access-Control-Expose-Headers",Y);if(J==="*")E.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(J))if(z&&J.includes(z))E.setHeader("Access-Control-Allow-Origin",z);else if(J.includes("*"))E.setHeader("Access-Control-Allow-Origin","*");else return E.status(403).json({message:"CORS not allowed"});else if(typeof J==="string")if(z===J)E.setHeader("Access-Control-Allow-Origin",z);else return E.status(403).json({message:"CORS not allowed"});else return E.status(403).json({message:"CORS not allowed"});if(E.setHeader("Access-Control-Allow-Origin",z),G.method==="OPTIONS")return E.setHeader("Access-Control-Max-Age","86400"),E.status(204).text("");return null}export{Q as default};
