function D(I,F,G){let z=new Headers,J={},X=!1,_,L=null,Z,Y,W=200,A={};return{req:I,server:F,url:G,getUser(){return A},setUser(E){if(E)A=E},status(E){return W=E,this},getIP(){return this.server.requestIP(this.req)},async getBody(){if(!Y)Y=await M(I);if(Y.error)return new Response(JSON.stringify({error:Y.error}),{status:400});return Y},setHeader(E,U){return z.set(E,U),this},set(E,U){return J[E]=U,this},get(E){return J[E]||null},setAuth(E){return X=E,this},getAuth(){return X},text(E,U){return new Response(E,{status:U??W,headers:z})},send(E,U){return new Response(E,{status:U??W,headers:z})},json(E,U){return new Response(JSON.stringify(E),{status:U??W,headers:z})},html(E,U){return new Response(Bun.file(E),{status:U??W,headers:z})},file(E,U){return new Response(Bun.file(E),{status:U??W,headers:z})},redirect(E,U){return z.set("Location",E),new Response(null,{status:U??302,headers:z})},setCookie(E,U,$={}){let K=`${encodeURIComponent(E)}=${encodeURIComponent(U)}`;if($.maxAge)K+=`; Max-Age=${$.maxAge}`;if($.expires)K+=`; Expires=${$.expires.toUTCString()}`;if($.path)K+=`; Path=${$.path}`;if($.domain)K+=`; Domain=${$.domain}`;if($.secure)K+="; Secure";if($.httpOnly)K+="; HttpOnly";if($.sameSite)K+=`; SameSite=${$.sameSite}`;return z?.append("Set-Cookie",K),this},getParams(E){if(!Z&&I?.routePattern)Z=j(I?.routePattern,G?.pathname);return E?Z[E]||{}:Z},getQuery(E){try{if(!_)_=Object.fromEntries(G.searchParams);return E?_[E]||{}:_}catch(U){return{}}},getCookie(E){if(!L){let U=I.headers.get("cookie");if(U)L=V(U);else return null}if(!L)return null;if(E)return L[E]??null;else return L}}}function V(I){let F={};return I?.split(";")?.forEach((G)=>{let[z,J]=G?.trim()?.split("=");if(z)F[z.trim()]=J?.split(" ")[0]?.trim()}),F}function j(I,F){let G={},z=I.split("/"),[J]=F.split("?"),X=J.split("/");if(z.length!==X.length)return null;return z.forEach((_,L)=>{if(_.startsWith(":")){let Z=_.slice(1);G[Z]=X[L]}}),G}async function M(I){let F=I.headers.get("Content-Type")||"";if(!F)return{};try{if(F.startsWith("application/json"))return await I.json();if(F.startsWith("application/x-www-form-urlencoded")){let G=await I.text();return Object.fromEntries(new URLSearchParams(G))}if(F.startsWith("multipart/form-data")){let G=await I.formData(),z={};for(let[J,X]of G.entries())z[J]=X;return z}return{error:"Unknown request body type"}}catch(G){return{error:"Invalid request body format"}}}async function T(I,F,G,z){let J=z.trie.search(G.pathname,I.method);if(!J||J.method!==I.method)return new Response(J?"Method not allowed":`Route not found for ${G.pathname}`,{status:J?405:404});if(J.isDynamic)I.routePattern=J.path;let X=D(I,F,G);if(z.corsConfig){let L=Q(I,X,z.corsConfig);if(L)return L}if(z.hasOnReqHook&&z.hooks.onRequest)z.hooks.onRequest(X,F);if(z.hasFilterEnabled){let L=I.routePattern??G.pathname;if(z.filters.includes(L)===!1)if(z.filterFunction)try{let Y=await z.filterFunction(X,F);if(Y)return Y}catch(Y){return console.error("Error in filterFunction:",Y),new Response(JSON.stringify({message:"Internal Server Error"}),{status:500})}else return new Response(JSON.stringify({message:"Authentication required"}),{status:400})}if(z.hasMiddleware){for(let Z of z.globalMiddlewares){let Y=await Z(X,F);if(Y)return Y}let L=z.middlewares.get(G.pathname)||[];for(let Z of L){let Y=await Z(X,F);if(Y)return Y}}if(z.hasPreHandlerHook&&z.hooks.preHandler){let L=await z.hooks.preHandler(X);if(L)return L}let _=await J.handler(X);if(z.hasPostHandlerHook&&z.hooks.postHandler)await z.hooks.postHandler(X);if(z.hasOnSendHook&&z.hooks.onSend){let L=await z.hooks.onSend(X,_);if(L)return L}return _??new Response("No response from handler",{status:204})}function Q(I,F,G={}){let z=I.headers.get("origin")??"*",J=G?.origin,X=G?.allowedHeaders??["Content-Type","Authorization"],_=G?.methods??["GET","POST","PUT","DELETE","OPTIONS"],L=G?.credentials??!1,Z=G?.exposedHeaders??[];if(F.setHeader("Access-Control-Allow-Methods",_),F.setHeader("Access-Control-Allow-Headers",X),F.setHeader("Access-Control-Allow-Credentials",L),Z.length)F.setHeader("Access-Control-Expose-Headers",Z);if(J==="*")F.setHeader("Access-Control-Allow-Origin","*");else if(Array.isArray(J))if(z&&J.includes(z))F.setHeader("Access-Control-Allow-Origin",z);else if(J.includes("*"))F.setHeader("Access-Control-Allow-Origin","*");else return F.status(403).json({message:"CORS not allowed"});else if(typeof J==="string")if(z===J)F.setHeader("Access-Control-Allow-Origin",z);else return F.status(403).json({message:"CORS not allowed"});else return F.status(403).json({message:"CORS not allowed"});if(F.setHeader("Access-Control-Allow-Origin",z),I.method==="OPTIONS")return F.setHeader("Access-Control-Max-Age","86400"),F.status(204).text("");return null}export{T as default};
