function V(G){switch(G.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function W(G,K,Y){let z=new Headers({"Cache-Control":"no-cache"}),Z=null,L=null,N=null,U=null,$={};return{req:G,server:K,url:Y,setHeader(A,J){return z.set(A,J),this},removeHeader(A){return z.delete(A),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!Z)try{Z=Object.fromEntries(this.url.searchParams)}catch(A){throw new Error("Failed to parse query parameters")}return Z},get params(){if(!L&&this.req.routePattern)try{L=F(this.req.routePattern,this.url.pathname)}catch(A){throw new Error("Failed to extract route parameters")}return L??{}},get body(){if(!U)U=(async()=>{let A=await Q(this.req);if(A.error)throw new Error(A.error);return Object.keys(A).length===0?null:A})();return U},set(A,J){return $[A]=J,this},get(A){return $[A]},text(A,J=200){if(!z.has("Content-Type"))z.set("Content-Type","text/plain; charset=utf-8");return new Response(A,{status:J,headers:z})},send(A,J=200){let X=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),O=A instanceof Uint8Array?"Uint8Array":A instanceof ArrayBuffer?"ArrayBuffer":typeof A;if(!z.has("Content-Type"))z.set("Content-Type",X.get(O)??"text/plain; charset=utf-8");let _=O==="object"&&A!==null?JSON.stringify(A):A;return new Response(_,{status:J,headers:z})},json(A,J=200){if(!z.has("Content-Type"))z.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(A),{status:J,headers:z})},file(A,J=200,X){let O=Bun.file(A);if(!z.has("Content-Type"))z.set("Content-Type",X??V(A));return new Response(O,{status:J,headers:z})},redirect(A,J=302){return z.set("Location",A),new Response(null,{status:J,headers:z})},setCookie(A,J,X={}){let O=`${encodeURIComponent(A)}=${encodeURIComponent(J)}`;if(X.maxAge)O+=`; Max-Age=${X.maxAge}`;if(X.expires)O+=`; Expires=${X.expires.toUTCString()}`;if(X.path)O+=`; Path=${X.path}`;if(X.domain)O+=`; Domain=${X.domain}`;if(X.secure)O+="; Secure";if(X.httpOnly)O+="; HttpOnly";if(X.sameSite)O+=`; SameSite=${X.sameSite}`;return z.append("Set-Cookie",O),this},get cookies(){if(!N){let A=this.req.headers.get("cookie");N=A?E(A):{}}return N}}}function E(G){return Object.fromEntries(G.split(";").map((K)=>{let[Y,...z]=K.trim().split("=");return[Y,decodeURIComponent(z.join("="))]}))}function F(G,K){let Y={},z=G.split("/"),[Z]=K.split("?"),L=Z.split("/");if(z.length!==L.length)return null;for(let N=0;N<z.length;N++)if(z[N].startsWith(":"))Y[z[N].slice(1)]=L[N];return Y}async function Q(G){let K=G.headers.get("Content-Type");if(!K)return{};if(G.headers.get("Content-Length")==="0"||!G.body)return{};try{if(K.startsWith("application/json"))return await G.json();if(K.startsWith("application/x-www-form-urlencoded")){let z=await G.text();return Object.fromEntries(new URLSearchParams(z))}if(K.startsWith("multipart/form-data")){let z=await G.formData(),Z={};for(let[L,N]of z.entries())Z[L]=N;return Z}return{error:"Unknown request body type"}}catch(z){return{error:"Invalid request body format"}}}async function B(G,K,Y,z){let Z=z.trie.search(Y.pathname,G.method);G.routePattern=Z?.path;let L=W(G,K,Y);if(z.hasFilterEnabled){let $=G.routePattern??Y.pathname,A=await D(z,$,L,K);if(A)return A}if(z.hasMiddleware){let $=z.globalMiddlewares;for(let J=0;J<$.length;J++){let X=await $[J](L,K);if(X)return X}let A=z.middlewares.get(Y.pathname)||[];for(let J=0;J<A.length;J++){let X=await A[J](L,K);if(X)return X}}if(!Z?.handler||Z.method!==G.method){let $=z.trie.search("*",G.method);if($){let A=await w(z,Y.pathname,L);if(A)return A;return await $.handler(L)}if(z.hooks.routeNotFound){let A=await z.hooks.routeNotFound(L);if(A)return A}if(!Z||!Z.handler.length)return j(404,`Route not found for ${Y.pathname}`);return j(405,"Method not allowed")}if(z.hooks.preHandler){let $=await z.hooks.preHandler(L);if($)return $}let N=Z.handler(L),U=N instanceof Promise?await N:N;if(z.hooks.postHandler)await z.hooks.postHandler(L);if(z.hooks.onSend){let $=await z.hooks.onSend(L,U);if($)return $}return U??j(204,"No response from this handler")}async function D(G,K,Y,z){if(!G.filters.has(K))if(G.filterFunction.length)for(let Z of G.filterFunction){let L=await Z(Y,z);if(L)return L}else return Y.json({error:!0,message:"Protected route, authentication required",status:401},401)}function j(G,K){return new Response(JSON.stringify({error:!0,message:K,status:G}),{status:G,headers:{"Content-Type":"application/json"}})}async function w(G,K,Y){if(!G.UseStaticFiles)throw new Error("Static files directory is not configured.");let z=`${G.UseStaticFiles}${K}`;if(/\.(js|css|html)$/.test(K)){let Z=V(z);return Y.file(z,200,Z)}return null}export{w as handleStaticFiles,D as handleFilterRequest,j as generateErrorResponse,B as default};
