var T=Object.create;var{getPrototypeOf:L,defineProperty:N,getOwnPropertyNames:O}=Object;var z=Object.prototype.hasOwnProperty;var G=(r,o,l)=>{l=r!=null?T(L(r)):{};let n=o||!r||!r.__esModule?N(l,"default",{value:r,enumerable:!0}):l;for(let R of O(r))if(!z.call(n,R))N(n,R,{get:()=>r[R],enumerable:!0});return n};var I=((r)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(r,{get:(o,l)=>(typeof require!=="undefined"?require:o)[l]}):r)(function(r){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});function g(r){switch(r.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function J(r,o){if(!r)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(l)=>{try{let n=l.cookies?.accessToken||l.req?.headers?.get("Authorization");if(!n)return l.json({message:"Unauthorized: No token provided"},401);if(n.startsWith("Bearer "))n=n.slice(7);let R=r?.verify(n,o);if(!R)return l.json({message:"Unauthorized: Invalid token"},401);l.set("user",R)}catch(n){return console.error("JWT verification error:",n),l.json({message:"Unauthorized: Invalid token",error:n?.message},401)}}}function D(r,o,l){if(!r)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!o)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(n)=>{try{let R=n.cookies?.accessToken||n.req?.headers?.get("Authorization");if(!R)return n.json({message:"Unauthorized: No token provided"},401);if(R.startsWith("Bearer "))R=R.slice(7);let F=r?.verify(R,l);if(!F)return n.json({message:"Unauthorized: Invalid token"},401);let A=await o.findById(F._id).select("-password -refreshToken");if(!A)return n.json({message:"Unauthorized: User not found"},401);n.set("user",A);return}catch(R){return n.json({message:"Unauthorized: Authentication failed",error:R?.message},401)}}}function H(r,o,l){let n=null,R=null,F=null,A=null,w={};return{req:r,server:o,url:l,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(f,h){return this.headers.set(f,h),this},removeHeader(f){return this.headers.delete(f),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!n)try{n=Object.fromEntries(this.url.searchParams)}catch(f){throw new Error("Failed to parse query parameters")}return n},get params(){if(!R&&this.req.routePattern)try{R=X(this.req.routePattern,this.url.pathname)}catch(f){throw new Error("Failed to extract route parameters")}return R??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!A)A=(async()=>{let f=await Y(this.req);if(f.error)throw new Error(f.error);return Object.keys(f).length===0?null:f})();return A},set(f,h){return w[f]=h,this},get(f){return w[f]},text(f,h){if(h)this.status=h;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(f,{status:this.status,headers:this.headers})},send(f,h){if(h)this.status=h;let i=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),E=f instanceof Uint8Array?"Uint8Array":f instanceof ArrayBuffer?"ArrayBuffer":typeof f;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",i.get(E)??"text/plain; charset=utf-8");let M=E==="object"&&f!==null?JSON.stringify(f):f;return new Response(M,{status:this.status,headers:this.headers})},json(f,h){if(h)this.status=h;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(f,{status:this.status,headers:this.headers})},file(f,h,i){if(i)this.status=i;let E=Bun.file(f);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",h??g(f));return new Response(E,{status:this.status,headers:this.headers})},async ejs(f,h={},i){if(i)this.status=i;let E;try{E=await import("ejs"),E=E.default||E}catch(M){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let M=await Bun.file(f).text(),$=E.render(M,h),m=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response($,{status:this.status,headers:m})}catch(M){return console.error("EJS Rendering Error:",M),new Response("Error rendering template",{status:500})}},redirect(f,h){if(h)this.status=h;else this.status=302;return this.headers.set("Location",f),new Response(null,{status:this.status,headers:this.headers})},stream(f){let h=new Headers(this.headers),i=new ReadableStream({async start(E){await f(E),E.close()}});return new Response(i,{headers:h})},yieldStream(f){return new Response({async*[Symbol.asyncIterator](){yield*f()}},{headers:this.headers})},setCookie(f,h,i={}){let E=`${encodeURIComponent(f)}=${encodeURIComponent(h)}`;if(i.maxAge)E+=`; Max-Age=${i.maxAge}`;if(i.expires)E+=`; Expires=${i.expires.toUTCString()}`;if(i.path)E+=`; Path=${i.path}`;if(i.domain)E+=`; Domain=${i.domain}`;if(i.secure)E+="; Secure";if(i.httpOnly)E+="; HttpOnly";if(i.sameSite)E+=`; SameSite=${i.sameSite}`;return this.headers.append("Set-Cookie",E),this},get cookies(){if(!F){let f=this.req.headers.get("cookie");F=f?K(f):{}}return F}}}function K(r){return Object.fromEntries(r.split(";").map((o)=>{let[l,...n]=o.trim().split("=");return[l,decodeURIComponent(n.join("="))]}))}function X(r,o){let l={},n=r.split("/"),[R]=o.split("?"),F=R.split("/");if(n.length!==F.length)return null;for(let A=0;A<n.length;A++)if(n[A].startsWith(":"))l[n[A].slice(1)]=F[A];return l}async function Y(r){let o=r.headers.get("Content-Type");if(!o)return{};if(r.headers.get("Content-Length")==="0"||!r.body)return{};try{if(o.startsWith("application/json"))return await r.json();if(o.startsWith("application/x-www-form-urlencoded")){let n=await r.text();return Object.fromEntries(new URLSearchParams(n))}if(o.startsWith("multipart/form-data")){let n=await r.formData(),R={};for(let[F,A]of n.entries())R[F]=A;return R}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function Z(r,o,l,n){let R=H(r,o,l),F=n.trie.search(l.pathname,r.method);r.routePattern=F?.path;try{if(l.pathname.startsWith("/favicon"))return;if(n.hasFilterEnabled){let f=r.routePattern??l.pathname,h=await V(n,f,R,o);if(h)return h}if(n.hasMiddleware){if(n.globalMiddlewares.length){let h=await C(n.globalMiddlewares,R,o);if(h)return h}let f=n.middlewares.get(l.pathname)||[];if(f?.length){let h=await C(f,R,o);if(h)return h}}if(!F?.handler||F.method!==r.method){if(n.staticPath){let f=await W(n,l.pathname,R);if(f)return f;let h=n.trie.search("*",r.method);if(h?.handler)return await h.handler(R)}if(n.hooks.routeNotFound&&Array.isArray(n.hooks.routeNotFound)&&!F?.handler){let f=n.hooks.routeNotFound;for(let h=0;h<f.length;h++){let i=await f[h](R);if(i)return i}}if(!F||!F?.handler?.length)return u(404,`Route not found for ${l.pathname}`);if(F?.method!==r.method)return u(405,"Method not allowed")}if(n.hooks.preHandler?.length&&Array.isArray(n.hooks.preHandler)){let f=n.hooks.preHandler;for(let h=0;h<f.length;h++){let i=await f[h](R);if(i)return i}}let A=F.handler(R);return(A instanceof Promise?await A:A)??u(204,"")}catch(A){if(n.hooks.onError&&Array.isArray(n.hooks.onError)){let w=n.hooks.onError;for(let f=0;f<w.length;f++){let h=n.hooks.onError[f](A,r,l,o);if(h)return h}}return u(500,"Internal Server Error")}finally{if(n.hooks.onSend&&Array.isArray(n.hooks.onSend)){let A=n.hooks.onSend;for(let w=0;w<A.length;w++){let f=await A[w](R);if(f)return f}}}}async function C(r,o,l){for(let n of r){let R=await n(o,l);if(R)return R}return null}async function V(r,o,l,n){if(!r.filters.has(o))if(r.filterFunction.length)for(let R of r.filterFunction){let F=await R(l,n);if(F)return F}else return l.json({error:!0,message:"Protected route, authentication required",status:401},401)}function u(r,o){return new Response(JSON.stringify({error:!0,message:o,status:r}),{status:r,headers:{"Content-Type":"application/json"}})}async function W(r,o,l){if(!r.staticPath)return null;let n=`${r.staticPath}${o}`;if(await Bun.file(n).exists()){let F=g(n);return l.file(n,F,200)}return null}export{W as handleStaticFiles,V as handleFilterRequest,u as generateErrorResponse,Z as default};
