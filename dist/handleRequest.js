var A=Object.create;var{getPrototypeOf:E,defineProperty:a,getOwnPropertyNames:p}=Object;var T=Object.prototype.hasOwnProperty;var C=(t,o,i)=>{i=t!=null?A(E(t)):{};let r=o||!t||!t.__esModule?a(i,"default",{value:t,enumerable:!0}):i;for(let f of p(t))if(!T.call(r,f))a(r,f,{get:()=>t[f],enumerable:!0});return r};var H=((t)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(t,{get:(o,i)=>(typeof require!=="undefined"?require:o)[i]}):t)(function(t){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function R(t){switch(t.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function x(t,o,i){let r=null,f=null,c=null,l=null,w={};return{req:t,server:o,url:i,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(n,e){return this.headers.set(n,e),this},removeHeader(n){return this.headers.delete(n),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!r)try{r=Object.fromEntries(this.url.searchParams)}catch(n){throw new Error("Failed to parse query parameters")}return r},get params(){if(!f&&this.req.routePattern)try{f=B(this.req.routePattern,this.url.pathname)}catch(n){throw new Error("Failed to extract route parameters")}return f??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!l)l=(async()=>{let n=await $(this.req);if(n.error)throw new Error(n.error);return Object.keys(n).length===0?null:n})();return l},set(n,e){return w[n]=e,this},get(n){return w[n]},text(n,e){if(e)this.status=e;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(n,{status:this.status,headers:this.headers})},send(n,e){if(e)this.status=e;let h=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),u=n instanceof Uint8Array?"Uint8Array":n instanceof ArrayBuffer?"ArrayBuffer":typeof n;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",h.get(u)??"text/plain; charset=utf-8");let s=u==="object"&&n!==null?JSON.stringify(n):n;return new Response(s,{status:this.status,headers:this.headers})},json(n,e){if(e)this.status=e;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(n,{status:this.status,headers:this.headers})},file(n,e,h){if(h)this.status=h;let u=Bun.file(n);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",e??R(n));return new Response(u,{status:this.status,headers:this.headers})},async ejs(n,e={},h){if(h)this.status=h;let u;try{u=await import("ejs"),u=u.default||u}catch(s){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let s=await Bun.file(n).text(),m=u.render(s,e),M=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(m,{status:this.status,headers:M})}catch(s){return console.error("EJS Rendering Error:",s),new Response("Error rendering template",{status:500})}},redirect(n,e){if(e)this.status=e;else this.status=302;return this.headers.set("Location",n),new Response(null,{status:this.status,headers:this.headers})},stream(n){let e=new Headers(this.headers),h=new ReadableStream({async start(u){await n(u),u.close()}});return new Response(h,{headers:e})},yieldStream(n){return new Response({async*[Symbol.asyncIterator](){yield*n()}},{headers:this.headers})},setCookie(n,e,h={}){let u=`${encodeURIComponent(n)}=${encodeURIComponent(e)}`;if(h.maxAge)u+=`; Max-Age=${h.maxAge}`;if(h.expires)u+=`; Expires=${h.expires.toUTCString()}`;if(h.path)u+=`; Path=${h.path}`;if(h.domain)u+=`; Domain=${h.domain}`;if(h.secure)u+="; Secure";if(h.httpOnly)u+="; HttpOnly";if(h.sameSite)u+=`; SameSite=${h.sameSite}`;return this.headers.append("Set-Cookie",u),this},get cookies(){if(!c){let n=this.req.headers.get("cookie");c=n?N(n):{}}return c}}}function N(t){return Object.fromEntries(t.split(";").map((o)=>{let[i,...r]=o.trim().split("=");return[i,decodeURIComponent(r.join("="))]}))}function B(t,o){let i={},r=t.split("/"),[f]=o.split("?"),c=f.split("/");if(r.length!==c.length)return null;for(let l=0;l<r.length;l++)if(r[l].startsWith(":"))i[r[l].slice(1)]=c[l];return i}async function $(t){let o=t.headers.get("Content-Type");if(!o)return{};if(t.headers.get("Content-Length")==="0"||!t.body)return{};try{if(o.startsWith("application/json"))return await t.json();if(o.startsWith("application/x-www-form-urlencoded")){let r=await t.text();return Object.fromEntries(new URLSearchParams(r))}if(o.startsWith("multipart/form-data")){let r=await t.formData(),f={};for(let[c,l]of r.entries())f[c]=l;return f}return{error:"Unknown request body type"}}catch(r){return{error:"Invalid request body format"}}}async function j(t,o,i,r){let f=x(t,o,i),c=r.trie.search(i.pathname,t.method);t.routePattern=c?.path;try{if(i.pathname.startsWith("/favicon"))return f.text("");if(r.hasFilterEnabled){let n=t.routePattern??i.pathname,e=await L(r,n,f,o);if(e)return e}if(r.hasMiddleware){if(r.globalMiddlewares.length){let e=await F(r.globalMiddlewares,f,o);if(e)return e}let n=r.middlewares.get(i.pathname)||[];if(n?.length){let e=await F(n,f,o);if(e)return e}}if(!c?.handler||c.method!==t.method){if(r.staticPath){let n=await J(r,i.pathname,f);if(n)return n;let e=r.trie.search("*",t.method);if(e?.handler)return await e.handler(f)}if(r.hooks.routeNotFound&&Array.isArray(r.hooks.routeNotFound)&&!c?.handler){let n=r.hooks.routeNotFound;for(let e=0;e<n.length;e++){let h=await n[e](f);if(h)return h}}if(!c||!c?.handler?.length)return g(404,`Route not found for ${i.pathname}`);if(c?.method!==t.method)return g(405,"Method not allowed")}if(r.hooks.preHandler?.length&&Array.isArray(r.hooks.preHandler)){let n=r.hooks.preHandler;for(let e=0;e<n.length;e++){let h=await n[e](f);if(h)return h}}let l=c.handler(f);return(l instanceof Promise?await l:l)??g(204,"")}catch(l){if(r.hooks.onError&&Array.isArray(r.hooks.onError)){let w=r.hooks.onError;for(let n=0;n<w.length;n++){let e=r.hooks.onError[n](l,t,i,o);if(e)return e}}return g(500,"Internal Server Error")}finally{if(r.hooks.onSend&&Array.isArray(r.hooks.onSend)){let l=r.hooks.onSend;for(let w=0;w<l.length;w++){let n=await l[w](f);if(n)return n}}}}async function F(t,o,i){for(let r of t){let f=await r(o,i);if(f)return f}return null}async function K(t,o,i){for(let r of t){let f=await r(o,i);if(f)return f}}async function L(t,o,i,r){if(!t.filters.has(o))if(t.filterFunction.length)for(let f of t.filterFunction){let c=await f(i,r);if(c)return c}else return Response.json({error:!0,message:"Protected route, authentication required",status:401},{status:401})}async function U(t,o,i,r){if(!t.filters.has(o))if(t.filterFunction.length)for(let f of t.filterFunction){let c=await f(i,r);if(c)return c}else return Response.json({error:!0,message:"Protected route, authentication required",status:401},{status:401})}function g(t,o){return new Response(JSON.stringify({error:!0,message:o,status:t}),{status:t,headers:{"Content-Type":"application/json"}})}async function J(t,o,i){if(!t.staticPath)return null;let r=`${t.staticPath}${o}`;if(await Bun.file(r).exists()){let c=R(r);return i.file(r,c,200)}return null}export{J as handleStaticFiles,L as handleFilterRequest,U as handleBunFilterRequest,g as generateErrorResponse,F as executeMiddlewares,K as executeBunMiddlewares,j as default};
