var X=Object.create;var{getPrototypeOf:Y,defineProperty:z,getOwnPropertyNames:Z}=Object;var g=Object.prototype.hasOwnProperty;var m=(f,F,h)=>{h=f!=null?X(Y(f)):{};let n=F||!f||!f.__esModule?z(h,"default",{value:f,enumerable:!0}):h;for(let R of Z(f))if(!g.call(n,R))z(n,R,{get:()=>f[R],enumerable:!0});return n};var T=((f)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(f,{get:(F,h)=>(typeof require!=="undefined"?require:F)[h]}):f)(function(f){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+f+'" is not supported')});function V(f){let{time:F=60000,max:h=100,message:n="Rate limit exceeded. Please try again later."}=f,R=new Map;return(w)=>{let H=new Date,$=w.ip;if(!R.has($))R.set($,{count:0,startTime:H});let E=R.get($);if(E)if(H-E.startTime>F)E.count=1,E.startTime=H;else E.count++;if(E&&E.count>h)return w.json({error:n},429)}}function L(f){switch(f.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function P(f,F){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(h)=>{try{let n=h.cookies?.accessToken||h.req?.headers?.get("Authorization");if(!n)return h.json({message:"Unauthorized: No token provided"},401);if(n.startsWith("Bearer "))n=n.slice(7);let R=f?.verify(n,F);if(!R)return h.json({message:"Unauthorized: Invalid token"},401);h.set("user",R);return}catch(n){return h.json({message:"Unauthorized: Invalid token",error:n?.message},401)}}}function o(f,F,h){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!F)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(n)=>{try{let R=n.cookies?.accessToken||n.req?.headers?.get("Authorization");if(!R)return n.json({message:"Unauthorized: No token provided"},401);if(R.startsWith("Bearer "))R=R.slice(7);let w=f?.verify(R,h);if(!w)return n.json({message:"Unauthorized: Invalid token"},401);let H=await F.findById(w._id).select("-password -refreshToken");if(!H)return n.json({message:"Unauthorized: User not found"},401);n.set("user",H);return}catch(R){return n.json({message:"Unauthorized: Authentication failed",error:R?.message},401)}}}function b(f,F,h){let n=new Headers({"Cache-Control":"no-cache"}),R=null,w=null,H=null,$=null,E={};return{req:f,server:F,url:h,status:200,setHeader(l,M){return n.set(l,M),this},removeHeader(l){return n.delete(l),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!R)try{R=Object.fromEntries(this.url.searchParams)}catch(l){throw new Error("Failed to parse query parameters")}return R},get params(){if(!w&&this.req.routePattern)try{w=W(this.req.routePattern,this.url.pathname)}catch(l){throw new Error("Failed to extract route parameters")}return w??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!$)$=(async()=>{let l=await D(this.req);if(l.error)throw new Error(l.error);return Object.keys(l).length===0?null:l})();return $},set(l,M){return E[l]=M,this},get(l){return E[l]},text(l,M){if(M)this.status=M;if(!n.has("Content-Type"))n.set("Content-Type","text/plain; charset=utf-8");return new Response(l,{status:this.status,headers:n})},send(l,M){if(M)this.status=M;let N=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),C=l instanceof Uint8Array?"Uint8Array":l instanceof ArrayBuffer?"ArrayBuffer":typeof l;if(!n.has("Content-Type"))n.set("Content-Type",N.get(C)??"text/plain; charset=utf-8");let i=C==="object"&&l!==null?JSON.stringify(l):l;return new Response(i,{status:this.status,headers:n})},json(l,M){if(M)this.status=M;if(!n.has("Content-Type"))n.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(l),{status:this.status,headers:n})},file(l,M,N){if(N)this.status=N;let C=Bun.file(l);if(!n.has("Content-Type"))n.set("Content-Type",M??L(l));return new Response(C,{status:this.status,headers:n})},async ejs(l,M={},N){if(N)this.status=N;let C;try{C=await import("ejs"),C=C.default||C}catch(i){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let i=await Bun.file(l).text(),G=C.render(i,M),K=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(G,{status:this.status,headers:K})}catch(i){return console.error("EJS Rendering Error:",i),new Response("Error rendering template",{status:500})}},redirect(l,M){if(M)this.status=M;else this.status=302;return n.set("Location",l),new Response(null,{status:this.status,headers:n})},setCookie(l,M,N={}){let C=`${encodeURIComponent(l)}=${encodeURIComponent(M)}`;if(N.maxAge)C+=`; Max-Age=${N.maxAge}`;if(N.expires)C+=`; Expires=${N.expires.toUTCString()}`;if(N.path)C+=`; Path=${N.path}`;if(N.domain)C+=`; Domain=${N.domain}`;if(N.secure)C+="; Secure";if(N.httpOnly)C+="; HttpOnly";if(N.sameSite)C+=`; SameSite=${N.sameSite}`;return n.append("Set-Cookie",C),this},get cookies(){if(!H){let l=this.req.headers.get("cookie");H=l?J(l):{}}return H}}}function J(f){return Object.fromEntries(f.split(";").map((F)=>{let[h,...n]=F.trim().split("=");return[h,decodeURIComponent(n.join("="))]}))}function W(f,F){let h={},n=f.split("/"),[R]=F.split("?"),w=R.split("/");if(n.length!==w.length)return null;for(let H=0;H<n.length;H++)if(n[H].startsWith(":"))h[n[H].slice(1)]=w[H];return h}async function D(f){let F=f.headers.get("Content-Type");if(!F)return{};if(f.headers.get("Content-Length")==="0"||!f.body)return{};try{if(F.startsWith("application/json"))return await f.json();if(F.startsWith("application/x-www-form-urlencoded")){let n=await f.text();return Object.fromEntries(new URLSearchParams(n))}if(F.startsWith("multipart/form-data")){let n=await f.formData(),R={};for(let[w,H]of n.entries())R[w]=H;return R}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function B(f,F,h,n){let R=b(f,F,h),w=n.trie.search(h.pathname,f.method);f.routePattern=w?.path;try{if(n.hasFilterEnabled){let E=f.routePattern??h.pathname,l=await Q(n,E,R,F);if(l)return l}if(n.hasMiddleware){if(n.globalMiddlewares.length){let l=await A(n.globalMiddlewares,R,F);if(l)return l}let E=n.middlewares.get(h.pathname)||[];if(E?.length){let l=await A(E,R,F);if(l)return l}}if(!w?.handler||w.method!==f.method){if(n.staticPath){let E=await U(n,h.pathname,R);if(E)return E;let l=n.trie.search("*",f.method);if(l?.handler)return await l.handler(R)}if(n.hooks.routeNotFound&&!w?.handler){let E=await n.hooks.routeNotFound(R);if(E)return E}if(!w||!w?.handler?.length)return O(404,`Route not found for ${h.pathname}`);if(w?.method!==f.method)return O(405,"Method not allowed")}if(n.hooks.preHandler){let E=await n.hooks.preHandler(R);if(E)return E}let H=w.handler(R),$=H instanceof Promise?await H:H;if(n.hooks.onSend){let E=await n.hooks.onSend(R,$);if(E)return E}return $??O(204,"No response from this handler")}catch(H){return n.hooks.onError?n.hooks.onError(H,f,h,F):O(500,"Internal Server Error")}finally{if(n.hooks.postHandler)n.hooks.postHandler(R)}}async function A(f,F,h){for(let n of f){console.log("middlewares: ",n);let R=await n(F,h);if(R)return R}return null}async function Q(f,F,h,n){if(!f.filters.has(F))if(f.filterFunction.length)for(let R of f.filterFunction){let w=await R(h,n);if(w)return w}else return h.json({error:!0,message:"Protected route, authentication required",status:401},401)}function O(f,F){return new Response(JSON.stringify({error:!0,message:F,status:f}),{status:f,headers:{"Content-Type":"application/json"}})}async function U(f,F,h){if(!f.staticPath)return null;let n=`${f.staticPath}${F}`;if(await Bun.file(n).exists()){let w=L(n);return h.file(n,w,200)}return null}export{U as handleStaticFiles,Q as handleFilterRequest,O as generateErrorResponse,B as default};
