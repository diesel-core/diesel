var T=Object.create;var{getPrototypeOf:C,defineProperty:m,getOwnPropertyNames:H}=Object;var N=Object.prototype.hasOwnProperty;var $=(f,o,h)=>{h=f!=null?T(C(f)):{};let r=o||!f||!f.__esModule?m(h,"default",{value:f,enumerable:!0}):h;for(let e of H(f))if(!N.call(r,e))m(r,e,{get:()=>f[e],enumerable:!0});return r};var p=((f)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(f,{get:(o,h)=>(typeof require!=="undefined"?require:o)[h]}):f)(function(f){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+f+'" is not supported')});function g(f){switch(f.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function F(f,o,h){let r=null,e=null,c=null,w=null,u={};return{req:f,server:o,url:h,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(n,t){return this.headers.set(n,t),this},removeHeader(n){return this.headers.delete(n),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!r)try{r=Object.fromEntries(this.url.searchParams)}catch(n){throw new Error("Failed to parse query parameters")}return r},get params(){if(!e&&this.req.routePattern)try{e=L(this.req.routePattern,this.url.pathname)}catch(n){throw new Error("Failed to extract route parameters")}return e??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!w)w=(async()=>{let n=await a(this.req);if(n.error)throw new Error(n.error);return Object.keys(n).length===0?null:n})();return w},set(n,t){return u[n]=t,this},get(n){return u[n]},text(n,t){if(t)this.status=t;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(n,{status:this.status,headers:this.headers})},send(n,t){if(t)this.status=t;let i=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),l=n instanceof Uint8Array?"Uint8Array":n instanceof ArrayBuffer?"ArrayBuffer":typeof n;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",i.get(l)??"text/plain; charset=utf-8");let R=l==="object"&&n!==null?JSON.stringify(n):n;return new Response(R,{status:this.status,headers:this.headers})},json(n,t){if(t)this.status=t;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(n,{status:this.status,headers:this.headers})},file(n,t,i){if(i)this.status=i;let l=Bun.file(n);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",t??g(n));return new Response(l,{status:this.status,headers:this.headers})},async ejs(n,t={},i){if(i)this.status=i;let l;try{l=await import("ejs"),l=l.default||l}catch(R){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let R=await Bun.file(n).text(),E=l.render(R,t),M=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(E,{status:this.status,headers:M})}catch(R){return console.error("EJS Rendering Error:",R),new Response("Error rendering template",{status:500})}},redirect(n,t){if(t)this.status=t;else this.status=302;return this.headers.set("Location",n),new Response(null,{status:this.status,headers:this.headers})},stream(n){let t=new Headers(this.headers),i=new ReadableStream({async start(l){await n(l),l.close()}});return new Response(i,{headers:t})},yieldStream(n){return new Response({async*[Symbol.asyncIterator](){yield*n()}},{headers:this.headers})},setCookie(n,t,i={}){let l=`${encodeURIComponent(n)}=${encodeURIComponent(t)}`;if(i.maxAge)l+=`; Max-Age=${i.maxAge}`;if(i.expires)l+=`; Expires=${i.expires.toUTCString()}`;if(i.path)l+=`; Path=${i.path}`;if(i.domain)l+=`; Domain=${i.domain}`;if(i.secure)l+="; Secure";if(i.httpOnly)l+="; HttpOnly";if(i.sameSite)l+=`; SameSite=${i.sameSite}`;return this.headers.append("Set-Cookie",l),this},get cookies(){if(!c){let n=this.req.headers.get("cookie");c=n?s(n):{}}return c}}}function s(f){return Object.fromEntries(f.split(";").map((o)=>{let[h,...r]=o.trim().split("=");return[h,decodeURIComponent(r.join("="))]}))}function L(f,o){let h={},r=f.split("/"),[e]=o.split("?"),c=e.split("/");if(r.length!==c.length)return null;for(let w=0;w<r.length;w++)if(r[w].startsWith(":"))h[r[w].slice(1)]=c[w];return h}async function a(f){let o=f.headers.get("Content-Type");if(!o)return{};if(f.headers.get("Content-Length")==="0"||!f.body)return{};try{if(o.startsWith("application/json"))return await f.json();if(o.startsWith("application/x-www-form-urlencoded")){let r=await f.text();return Object.fromEntries(new URLSearchParams(r))}if(o.startsWith("multipart/form-data")){let r=await f.formData(),e={};for(let[c,w]of r.entries())e[c]=w;return e}return{error:"Unknown request body type"}}catch(r){return{error:"Invalid request body format"}}}async function j(f,o,h,r){let e=F(f,o,h),c=r.trie.search(h.pathname,f.method);f.routePattern=c?.path;try{if(h.pathname.startsWith("/favicon"))return;if(r.hasFilterEnabled){let n=f.routePattern??h.pathname,t=await J(r,n,e,o);if(t)return t}if(r.hasMiddleware){if(r.globalMiddlewares.length){let t=await A(r.globalMiddlewares,e,o);if(t)return t}let n=r.middlewares.get(h.pathname)||[];if(n?.length){let t=await A(n,e,o);if(t)return t}}if(!c?.handler||c.method!==f.method){if(r.staticPath){let n=await O(r,h.pathname,e);if(n)return n;let t=r.trie.search("*",f.method);if(t?.handler)return await t.handler(e)}if(r.hooks.routeNotFound&&Array.isArray(r.hooks.routeNotFound)&&!c?.handler){let n=r.hooks.routeNotFound;for(let t=0;t<n.length;t++){let i=await n[t](e);if(i)return i}}if(!c||!c?.handler?.length)return x(404,`Route not found for ${h.pathname}`);if(c?.method!==f.method)return x(405,"Method not allowed")}if(r.hooks.preHandler?.length&&Array.isArray(r.hooks.preHandler)){let n=r.hooks.preHandler;for(let t=0;t<n.length;t++){let i=await n[t](e);if(i)return i}}let w=c.handler(e);return(w instanceof Promise?await w:w)??x(204,"")}catch(w){if(r.hooks.onError&&Array.isArray(r.hooks.onError)){let u=r.hooks.onError;for(let n=0;n<u.length;n++){let t=r.hooks.onError[n](w,f,h,o);if(t)return t}}return x(500,"Internal Server Error")}finally{if(r.hooks.onSend&&Array.isArray(r.hooks.onSend)){let w=r.hooks.onSend;for(let u=0;u<w.length;u++){let n=await w[u](e);if(n)return n}}}}async function A(f,o,h){for(let r of f){let e=await r(o,h);if(e)return e}return null}async function J(f,o,h,r){if(!f.filters.has(o))if(f.filterFunction.length)for(let e of f.filterFunction){let c=await e(h,r);if(c)return c}else return h.json({error:!0,message:"Protected route, authentication required",status:401},401)}function x(f,o){return new Response(JSON.stringify({error:!0,message:o,status:f}),{status:f,headers:{"Content-Type":"application/json"}})}async function O(f,o,h){if(!f.staticPath)return null;let r=`${f.staticPath}${o}`;if(await Bun.file(r).exists()){let c=g(r);return h.file(r,c,200)}return null}export{O as handleStaticFiles,J as handleFilterRequest,x as generateErrorResponse,j as default};
