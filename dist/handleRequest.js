var b=Object.create;var{getPrototypeOf:z,defineProperty:C,getOwnPropertyNames:G}=Object;var K=Object.prototype.hasOwnProperty;var X=(f,o,R)=>{R=f!=null?b(z(f)):{};let n=o||!f||!f.__esModule?C(R,"default",{value:f,enumerable:!0}):R;for(let l of G(f))if(!K.call(n,l))C(n,l,{get:()=>f[l],enumerable:!0});return n};var Y=((f)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(f,{get:(o,R)=>(typeof require!=="undefined"?require:o)[R]}):f)(function(f){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+f+'" is not supported')});function Z(f){let{time:o=60000,max:R=100,message:n="Rate limit exceeded. Please try again later."}=f,l=new Map;return(A)=>{let g=new Date,i=A.ip;if(!l.has(i))l.set(i,{count:0,startTime:g});let h=l.get(i);if(h)if(g-h.startTime>o)h.count=1,h.startTime=g;else h.count++;if(h&&h.count>R)return A.json({error:n},429)}}function w(f){switch(f.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function S(f,o){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(R)=>{try{let n=R.cookies?.accessToken||R.req?.headers?.get("Authorization");if(!n)return R.json({message:"Unauthorized: No token provided"},401);if(n.startsWith("Bearer "))n=n.slice(7);let l=f?.verify(n,o);if(!l)return R.json({message:"Unauthorized: Invalid token"},401);R.set("user",l);return}catch(n){return R.json({message:"Unauthorized: Invalid token",error:n?.message},401)}}}function B(f,o,R){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!o)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(n)=>{try{let l=n.cookies?.accessToken||n.req?.headers?.get("Authorization");if(!l)return n.json({message:"Unauthorized: No token provided"},401);if(l.startsWith("Bearer "))l=l.slice(7);let A=f?.verify(l,R);if(!A)return n.json({message:"Unauthorized: Invalid token"},401);let g=await o.findById(A._id).select("-password -refreshToken");if(!g)return n.json({message:"Unauthorized: User not found"},401);n.set("user",g);return}catch(l){return n.json({message:"Unauthorized: Authentication failed",error:l?.message},401)}}}function M(f,o,R){let n=null,l=null,A=null,g=null,i={};return{req:f,server:o,url:R,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(h,r){return this.headers.set(h,r),this},removeHeader(h){return this.headers.delete(h),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!n)try{n=Object.fromEntries(this.url.searchParams)}catch(h){throw new Error("Failed to parse query parameters")}return n},get params(){if(!l&&this.req.routePattern)try{l=V(this.req.routePattern,this.url.pathname)}catch(h){throw new Error("Failed to extract route parameters")}return l??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!g)g=(async()=>{let h=await m(this.req);if(h.error)throw new Error(h.error);return Object.keys(h).length===0?null:h})();return g},set(h,r){return i[h]=r,this},get(h){return i[h]},text(h,r){if(r)this.status=r;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(h,{status:this.status,headers:this.headers})},send(h,r){if(r)this.status=r;let F=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),H=h instanceof Uint8Array?"Uint8Array":h instanceof ArrayBuffer?"ArrayBuffer":typeof h;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",F.get(H)??"text/plain; charset=utf-8");let E=H==="object"&&h!==null?JSON.stringify(h):h;return new Response(E,{status:this.status,headers:this.headers})},json(h,r){if(r)this.status=r;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(h),{status:this.status,headers:this.headers})},file(h,r,F){if(F)this.status=F;let H=Bun.file(h);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",r??w(h));return new Response(H,{status:this.status,headers:this.headers})},async ejs(h,r={},F){if(F)this.status=F;let H;try{H=await import("ejs"),H=H.default||H}catch(E){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let E=await Bun.file(h).text(),L=H.render(E,r),O=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(L,{status:this.status,headers:O})}catch(E){return console.error("EJS Rendering Error:",E),new Response("Error rendering template",{status:500})}},redirect(h,r){if(r)this.status=r;else this.status=302;return this.headers.set("Location",h),new Response(null,{status:this.status,headers:this.headers})},setCookie(h,r,F={}){let H=`${encodeURIComponent(h)}=${encodeURIComponent(r)}`;if(F.maxAge)H+=`; Max-Age=${F.maxAge}`;if(F.expires)H+=`; Expires=${F.expires.toUTCString()}`;if(F.path)H+=`; Path=${F.path}`;if(F.domain)H+=`; Domain=${F.domain}`;if(F.secure)H+="; Secure";if(F.httpOnly)H+="; HttpOnly";if(F.sameSite)H+=`; SameSite=${F.sameSite}`;return this.headers.append("Set-Cookie",H),this},get cookies(){if(!A){let h=this.req.headers.get("cookie");A=h?T(h):{}}return A}}}function T(f){return Object.fromEntries(f.split(";").map((o)=>{let[R,...n]=o.trim().split("=");return[R,decodeURIComponent(n.join("="))]}))}function V(f,o){let R={},n=f.split("/"),[l]=o.split("?"),A=l.split("/");if(n.length!==A.length)return null;for(let g=0;g<n.length;g++)if(n[g].startsWith(":"))R[n[g].slice(1)]=A[g];return R}async function m(f){let o=f.headers.get("Content-Type");if(!o)return{};if(f.headers.get("Content-Length")==="0"||!f.body)return{};try{if(o.startsWith("application/json"))return await f.json();if(o.startsWith("application/x-www-form-urlencoded")){let n=await f.text();return Object.fromEntries(new URLSearchParams(n))}if(o.startsWith("multipart/form-data")){let n=await f.formData(),l={};for(let[A,g]of n.entries())l[A]=g;return l}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function y(f,o,R,n){let l=M(f,o,R),A=n.trie.search(R.pathname,f.method);f.routePattern=A?.path;try{if(n.hasFilterEnabled){let h=f.routePattern??R.pathname,r=await J(n,h,l,o);if(r)return r}if(n.hasMiddleware){if(n.globalMiddlewares.length){let r=await $(n.globalMiddlewares,l,o);if(r)return r}let h=n.middlewares.get(R.pathname)||[];if(h?.length){let r=await $(h,l,o);if(r)return r}}if(!A?.handler||A.method!==f.method){if(n.staticPath){let h=await W(n,R.pathname,l);if(h)return h;let r=n.trie.search("*",f.method);if(r?.handler)return await r.handler(l)}if(n.hooks.routeNotFound?.length&&Array.isArray(n.hooks.routeNotFound)&&!A?.handler){let h=n.hooks.routeNotFound;for(let r=0;r<h.length;r++){let F=await h[r](l);if(F)return F}}if(!A||!A?.handler?.length)return N(404,`Route not found for ${R.pathname}`);if(A?.method!==f.method)return N(405,"Method not allowed")}if(n.hooks.preHandler?.length&&Array.isArray(n.hooks.preHandler)){let h=n.hooks.preHandler;for(let r=0;r<h.length;r++){let F=await h[r](l);if(F)return F}}let g=A.handler(l),i=g instanceof Promise?await g:g;if(n.hooks.onSend?.length&&Array.isArray(n.hooks.onSend)){let h=n.hooks.onSend;for(let r=0;r<h.length;r++){let F=await h[r](l);if(F)return F}}return i??N(204,"No response from this handler")}catch(g){return n.hooks.onError?.length&&Array.isArray(n.hooks.onError)?n.hooks.onError[0](g,f,R,o):N(500,"Internal Server Error")}finally{if(n.hooks.postHandler?.length&&Array.isArray(n.hooks.postHandler)){let g=n.hooks.postHandler;for(let i=0;i<g.length;i++){let h=await g[i](l);if(h)return h}}}}async function $(f,o,R){for(let n of f){let l=await n(o,R);if(l)return l}return null}async function J(f,o,R,n){if(!f.filters.has(o))if(f.filterFunction.length)for(let l of f.filterFunction){let A=await l(R,n);if(A)return A}else return R.json({error:!0,message:"Protected route, authentication required",status:401},401)}function N(f,o){return new Response(JSON.stringify({error:!0,message:o,status:f}),{status:f,headers:{"Content-Type":"application/json"}})}async function W(f,o,R){if(!f.staticPath)return null;let n=`${f.staticPath}${o}`;if(await Bun.file(n).exists()){let A=w(n);return R.file(n,A,200)}return null}export{W as handleStaticFiles,J as handleFilterRequest,N as generateErrorResponse,y as default};
