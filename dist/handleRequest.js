var Z=Object.create;var{getPrototypeOf:b,defineProperty:G,getOwnPropertyNames:T}=Object;var V=Object.prototype.hasOwnProperty;var i=(f,F,h)=>{h=f!=null?Z(b(f)):{};let n=F||!f||!f.__esModule?G(h,"default",{value:f,enumerable:!0}):h;for(let R of T(f))if(!V.call(n,R))G(n,R,{get:()=>f[R],enumerable:!0});return n};var m=((f)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(f,{get:(F,h)=>(typeof require!=="undefined"?require:F)[h]}):f)(function(f){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+f+'" is not supported')});function J(f){let{time:F=60000,max:h=100,message:n="Rate limit exceeded. Please try again later."}=f,R=new Map;return(E)=>{let N=new Date,$=E.ip;if(!R.has($))R.set($,{count:0,startTime:N});let H=R.get($);if(H)if(N-H.startTime>F)H.count=1,H.startTime=N;else H.count++;if(H&&H.count>h)return E.json({error:n},429)}}function O(f){switch(f.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function P(f,F){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(h)=>{try{let n=h.cookies?.accessToken||h.req?.headers?.get("Authorization");if(!n)return h.json({message:"Unauthorized: No token provided"},401);if(n.startsWith("Bearer "))n=n.slice(7);let R=f?.verify(n,F);if(!R)return h.json({message:"Unauthorized: Invalid token"},401);h.set("user",R);return}catch(n){return h.json({message:"Unauthorized: Invalid token",error:n?.message},401)}}}function I(f,F,h){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!F)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(n)=>{try{let R=n.cookies?.accessToken||n.req?.headers?.get("Authorization");if(!R)return n.json({message:"Unauthorized: No token provided"},401);if(R.startsWith("Bearer "))R=R.slice(7);let E=f?.verify(R,h);if(!E)return n.json({message:"Unauthorized: Invalid token"},401);let N=await F.findById(E._id).select("-password -refreshToken");if(!N)return n.json({message:"Unauthorized: User not found"},401);n.set("user",N);return}catch(R){return n.json({message:"Unauthorized: Authentication failed",error:R?.message},401)}}}function A(f,F,h){let n=new Headers({"Cache-Control":"no-cache"}),R=null,E=null,N=null,$=null,H={};return{req:f,server:F,url:h,status:200,setHeader(l,w){return n.set(l,w),this},removeHeader(l){return n.delete(l),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!R)try{R=Object.fromEntries(this.url.searchParams)}catch(l){throw new Error("Failed to parse query parameters")}return R},get params(){if(!E&&this.req.routePattern)try{E=D(this.req.routePattern,this.url.pathname)}catch(l){throw new Error("Failed to extract route parameters")}return E??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!$)$=(async()=>{let l=await B(this.req);if(l.error)throw new Error(l.error);return Object.keys(l).length===0?null:l})();return $},set(l,w){return H[l]=w,this},get(l){return H[l]},text(l,w){if(w)this.status=w;if(!n.has("Content-Type"))n.set("Content-Type","text/plain; charset=utf-8");return new Response(l,{status:this.status,headers:n})},send(l,w){if(w)this.status=w;let C=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),M=l instanceof Uint8Array?"Uint8Array":l instanceof ArrayBuffer?"ArrayBuffer":typeof l;if(!n.has("Content-Type"))n.set("Content-Type",C.get(M)??"text/plain; charset=utf-8");let L=M==="object"&&l!==null?JSON.stringify(l):l;return new Response(L,{status:this.status,headers:n})},json(l,w){if(w)this.status=w;if(!n.has("Content-Type"))n.set("Content-Type","application/json; charset=utf-8");return new Response(JSON.stringify(l),{status:this.status,headers:n})},file(l,w,C){if(C)this.status=C;let M=Bun.file(l);if(!n.has("Content-Type"))n.set("Content-Type",w??O(l));return new Response(M,{status:this.status,headers:n})},async ejs(l,w={},C){if(C)this.status=C;let M;try{M=await import("ejs"),M=M.default||M}catch(L){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let L=await Bun.file(l).text(),X=M.render(L,w),Y=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(X,{status:this.status,headers:Y})}catch(L){return console.error("EJS Rendering Error:",L),new Response("Error rendering template",{status:500})}},redirect(l,w){if(w)this.status=w;else this.status=302;return n.set("Location",l),new Response(null,{status:this.status,headers:n})},setCookie(l,w,C={}){let M=`${encodeURIComponent(l)}=${encodeURIComponent(w)}`;if(C.maxAge)M+=`; Max-Age=${C.maxAge}`;if(C.expires)M+=`; Expires=${C.expires.toUTCString()}`;if(C.path)M+=`; Path=${C.path}`;if(C.domain)M+=`; Domain=${C.domain}`;if(C.secure)M+="; Secure";if(C.httpOnly)M+="; HttpOnly";if(C.sameSite)M+=`; SameSite=${C.sameSite}`;return n.append("Set-Cookie",M),this},get cookies(){if(!N){let l=this.req.headers.get("cookie");N=l?W(l):{}}return N}}}function W(f){return Object.fromEntries(f.split(";").map((F)=>{let[h,...n]=F.trim().split("=");return[h,decodeURIComponent(n.join("="))]}))}function D(f,F){let h={},n=f.split("/"),[R]=F.split("?"),E=R.split("/");if(n.length!==E.length)return null;for(let N=0;N<n.length;N++)if(n[N].startsWith(":"))h[n[N].slice(1)]=E[N];return h}async function B(f){let F=f.headers.get("Content-Type");if(!F)return{};if(f.headers.get("Content-Length")==="0"||!f.body)return{};try{if(F.startsWith("application/json"))return await f.json();if(F.startsWith("application/x-www-form-urlencoded")){let n=await f.text();return Object.fromEntries(new URLSearchParams(n))}if(F.startsWith("multipart/form-data")){let n=await f.formData(),R={};for(let[E,N]of n.entries())R[E]=N;return R}return{error:"Unknown request body type"}}catch(n){return{error:"Invalid request body format"}}}async function Q(f,F,h,n){let R=A(f,F,h),E=n.trie.search(h.pathname,f.method);f.routePattern=E?.path;try{if(n.hasFilterEnabled){let H=f.routePattern??h.pathname,l=await U(n,H,R,F);if(l)return l}if(n.hasMiddleware){let H=await K(n.globalMiddlewares,R,F);if(H)return H;let l=n.middlewares.get(h.pathname)||[],w=await K(l,R,F);if(w)return w}if(!E?.handler||E.method!==f.method){if(n.staticPath){let H=await g(n,h.pathname,R);if(H)return H;let l=n.trie.search("*",f.method);if(l?.handler)return await l.handler(R)}if(n.hooks.routeNotFound&&!E?.handler){let H=await n.hooks.routeNotFound(R);if(H)return H}if(!E||!E?.handler?.length)return z(404,`Route not found for ${h.pathname}`);if(E?.method!==f.method)return z(405,"Method not allowed")}if(n.hooks.preHandler){let H=await n.hooks.preHandler(R);if(H)return H}let N=E.handler(R),$=N instanceof Promise?await N:N;if(n.hooks.onSend){let H=await n.hooks.onSend(R,$);if(H)return H}return $??z(204,"No response from this handler")}catch(N){return n.hooks.onError?n.hooks.onError(N,f,h,F):z(500,"Internal Server Error")}finally{if(n.hooks.postHandler)n.hooks.postHandler(R)}}async function K(f,F,h){for(let n of f){let R=await n(F,h);if(R)return R}return null}async function U(f,F,h,n){if(!f.filters.has(F))if(f.filterFunction.length)for(let R of f.filterFunction){let E=await R(h,n);if(E)return E}else return h.json({error:!0,message:"Protected route, authentication required",status:401},401)}function z(f,F){return new Response(JSON.stringify({error:!0,message:F,status:f}),{status:f,headers:{"Content-Type":"application/json"}})}async function g(f,F,h){if(!f.staticPath)return null;let n=`${f.staticPath}${F}`;if(await Bun.file(n).exists()){let E=O(n);return h.file(n,E,200)}return null}export{g as handleStaticFiles,U as handleFilterRequest,z as generateErrorResponse,Q as default};
